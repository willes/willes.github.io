<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://willes.github.io/</id>
    <title>icodex Blog</title>
    <updated>2022-10-29T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://willes.github.io/"/>
    <subtitle>icodex Blog</subtitle>
    <icon>https://willes.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[IntersectionObserver API 用法]]></title>
        <id>https://willes.github.io/intersection</id>
        <link href="https://willes.github.io/intersection"/>
        <updated>2022-10-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[当我们说到图片懒加载、页面数据的滚动加载这些体验设计时，一般能够想到基于scroll事件，通过getBoundingClientRect方法获取元素相对于视口偏移量top，来判断元素是否可见，demo 如下]]></summary>
        <content type="html"><![CDATA[<p>当我们说到图片懒加载、页面数据的滚动加载这些体验设计时，一般能够想到基于<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/scroll_event" target="_blank" rel="noopener noreferrer"><code>scroll</code></a>事件，通过<code>getBoundingClientRect</code>方法获取元素相对于视口偏移量<code>top</code>，来判断元素是否可见，demo 如下</p><p><a href="https://codesandbox.io/s/jovial-snowflake-e42869?fontsize=14&amp;hidenavigation=1&amp;theme=dark" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit jovial-snowflake-e42869" class="img_MG2L"></a></p><p>这种实现方式较为繁琐，但是现在我们有了<code>IntersectionObserver</code> API，可以大大简化这些通过计算元素偏移量来判断可视性的逻辑。</p><h1>IntersectionObserver 介绍</h1><p>W3C 在 <a href="https://www.w3.org/standards/history/intersection-observer" target="_blank" rel="noopener noreferrer">2017-09-14</a> 正式发布了<code>IntersectionObserver</code> API 草案，其功能上提供了检测目标元素在祖先元素或 <a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Viewport" target="_blank" rel="noopener noreferrer">viewport</a> 内可视情况变化的方式，这种观测是异步的，保证了开发上的便捷和性能上的高效。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="intersectionobserver类型定义">IntersectionObserver类型定义<a href="#intersectionobserver类型定义" class="hash-link" aria-label="IntersectionObserver类型定义的直接链接" title="IntersectionObserver类型定义的直接链接">​</a></h2><p><code>IntersectionObserver</code>本身是一个构造函数，需要通过<code>new</code>来初始化调用，基本使用方式如下：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 获取目标元素 DOM 对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> observeTarget </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">document</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">querySelector</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"#targetId"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 初始化IntersectionObserver实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> observer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">IntersectionObserver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">entries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  entries</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">forEach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">e</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// e.isIntersecting 为 true，则目标元素变得可见</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">isIntersecting</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">threshold</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 开始监测目标元素</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">observer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">observe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">observeTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// 取消监测</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">observer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">unobserve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">observeTarget</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">observer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">disconnect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面是详细的 TypeScript 类型定义：</p><div class="language-typescript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-typescript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> * 构造函数</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> IntersectionObserver</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    prototype</span><span class="token operator">:</span><span class="token plain"> IntersectionObserver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">callback</span><span class="token operator">:</span><span class="token plain"> IntersectionObserverCallback</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> options</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> IntersectionObserverInit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> IntersectionObserver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> * 构造函数初始参数1：回调函数</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name">IntersectionObserverCallback</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">entries</span><span class="token operator">:</span><span class="token plain"> IntersectionObserverEntry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> observer</span><span class="token operator">:</span><span class="token plain"> IntersectionObserver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> * 构造函数初始参数2：回调函数执行条件设定</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name">IntersectionObserverInit</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素的包含元素，如果不指定则默认为 viewport</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    root</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> Element </span><span class="token operator">|</span><span class="token plain"> Document </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素相对于 viewport 或者包含元素的偏移量</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 注意：负值表示目标元素在包含元素内部偏右或者偏下的位置</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    rootMargin</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素触发回调函数的</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    threshold</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">number</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> * IntersectionObserver对象属性和方法</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name">IntersectionObserver</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> root</span><span class="token operator">:</span><span class="token plain"> Element </span><span class="token operator">|</span><span class="token plain"> Document </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> rootMargin</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> thresholds</span><span class="token operator">:</span><span class="token plain"> ReadonlyArray</span><span class="token operator">&lt;</span><span class="token builtin" style="color:rgb(189, 147, 249)">number</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 停止监测所有元素</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">disconnect</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 开始监测目标元素</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">observe</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">target</span><span class="token operator">:</span><span class="token plain"> Element</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 获取所有目标元素的监测对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">takeRecords</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> IntersectionObserverEntry</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 停止监测目标元素</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">unobserve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">target</span><span class="token operator">:</span><span class="token plain"> Element</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">void</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> * 回调函数获取的目标元素的监测变量</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name">IntersectionObserverEntry</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素在 viewport 内部的坐标</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> boundingClientRect</span><span class="token operator">:</span><span class="token plain"> DOMRectReadOnly</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素可见比例</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> intersectionRatio</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素可见区域在 viewport 内部的坐标</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> intersectionRect</span><span class="token operator">:</span><span class="token plain"> DOMRectReadOnly</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素是否可见</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> isIntersecting</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素的root元素可见区域的坐标</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> rootBounds</span><span class="token operator">:</span><span class="token plain"> DOMRectReadOnly </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 目标元素 DOM 对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> target</span><span class="token operator">:</span><span class="token plain"> Element</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">/*</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     * 相对于创建文档的时间，当元素可见性发生改变的时间对象</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">readonly</span><span class="token plain"> time</span><span class="token operator">:</span><span class="token plain"> DOMHighResTimeStamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在初始化<code>IntersectionObserver</code>对象的时候，需要重点理解<code>root</code>和<code>threshold</code>的概念。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="root">root<a href="#root" class="hash-link" aria-label="root的直接链接" title="root的直接链接">​</a></h3><p><code>root</code>可以在初始化<code>IntersectionObserver</code>时指定，表示目标元素相对的容器元素，如果未指定则为<code>html</code>根元素。</p><p><code>root</code>和目标元素都被看成是矩形盒子，而<code>rootMargin</code>则是目标元素相对于<code>root</code>的位置偏移量，因为<code>root</code>内部还可能排布的有其他元素或者<code>root</code>本身具有不为<code>0</code>的<code>margin</code>属性。</p><ul><li><p>当<code>rootMargin</code>取正值时，元素在<code>viewport</code>或者祖先元素内部向上或者向左偏移</p></li><li><p>当<code>rootMargin</code>取负值时，元素在<code>viewport</code>或者祖先元素内部向下或者向右偏移</p></li></ul><p>（下图引自<a href="https://www.smashingmagazine.com/2021/07/dynamic-header-intersection-observer/" target="_blank" rel="noopener noreferrer">Building A Dynamic Header With Intersection Observer — Smashing Magazine</a>）</p><p><img loading="lazy" alt="1-dynamic-header-intersection-observer" src="/assets/images/1-dynamic-header-intersection-observer-660d0ed0ce2b2121669c1588619973ce.png" width="1366" height="1428" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="threshold">threshold<a href="#threshold" class="hash-link" aria-label="threshold的直接链接" title="threshold的直接链接">​</a></h3><p><code>threshold</code>用于指定一个或者多个在<code>0 ~ 1</code>范围内的数字，数字代表的是一个比例，表示元素在<code>root</code>内部可见面积相对于<code>root</code>的百分比。</p><p>当目标元素可见面积比例发生改变且在指定的阈值时，就会触发<code>IntersectionObserver</code>初始化时的回调函数，如果不指定，则默认为<code>0</code>，即元素在完全不可见和可见时触发回调函数。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_amsr"><div class="admonitionHeading_n8eI"><span class="admonitionIcon_HzUW"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_qhyd"><p><code>threshold</code>并不能保证回调函数一定在这些指定的阈值到达时执行。</p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="元素是否可见的判断">元素是否可见的判断<a href="#元素是否可见的判断" class="hash-link" aria-label="元素是否可见的判断的直接链接" title="元素是否可见的判断的直接链接">​</a></h2><p>通过<code>IntersectionObserver</code>我们可以判断元素是否可见的两种情况：</p><ol><li>在<code>document</code>的<code>viewport</code>内部是否可见，此时元素相对于浏览器窗口或者<code>iframe</code>定位</li></ol><iframe src="https://codesandbox.io/embed/ancient-sound-l3vbju?fontsize=14&amp;hidenavigation=1&amp;theme=dark" width="100%" height="500" title="ancient-sound-l3vbju" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts" loading="lazy"></iframe><ol start="2"><li>在祖先元素内部是否可见</li></ol><iframe src="https://codesandbox.io/embed/nervous-tristan-k630cf?fontsize=14&amp;hidenavigation=1&amp;theme=dark" width="100%" height="500" title="nervous-tristan-k630cf" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts" loading="lazy"></iframe><h1>IntersectionObserver用例</h1><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="image-lazyload">Image Lazyload<a href="#image-lazyload" class="hash-link" aria-label="Image Lazyload的直接链接" title="Image Lazyload的直接链接">​</a></h2><iframe src="https://codesandbox.io/embed/hopeful-poincare-uuhiob?fontsize=14&amp;hidenavigation=1&amp;theme=dark" width="100%" height="500" title="hopeful-poincare-uuhiob" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts" loading="lazy"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="sticky-header-boxshadow">Sticky Header BoxShadow<a href="#sticky-header-boxshadow" class="hash-link" aria-label="Sticky Header BoxShadow的直接链接" title="Sticky Header BoxShadow的直接链接">​</a></h2><iframe src="https://codesandbox.io/embed/angry-taussig-e07ysx?fontsize=14&amp;hidenavigation=1&amp;theme=dark" width="100%" height="500" title="angry-taussig-e07ysx" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts" loading="lazy"></iframe><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="infinite-scroll">Infinite Scroll<a href="#infinite-scroll" class="hash-link" aria-label="Infinite Scroll的直接链接" title="Infinite Scroll的直接链接">​</a></h2><iframe src="https://codesandbox.io/embed/intelligent-albattani-yrujgn?fontsize=14&amp;hidenavigation=1&amp;theme=dark" width="100%" height="500" title="intelligent-albattani-yrujgn" allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts" loading="lazy"></iframe>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[web图像格式对比（三）]]></title>
        <id>https://willes.github.io/webimage3</id>
        <link href="https://willes.github.io/webimage3"/>
        <updated>2022-08-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[无损压缩]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="无损压缩">无损压缩<a href="#无损压缩" class="hash-link" aria-label="无损压缩的直接链接" title="无损压缩的直接链接">​</a></h2><p>无损压缩目前使用最广泛的图像格式是 PNG，但是近几年也出现了许多新的压缩算法标准，以期望替代 PNG，提供更好的图像压缩效果。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="bmp">BMP<a href="#bmp" class="hash-link" aria-label="BMP的直接链接" title="BMP的直接链接">​</a></h2><p>BMP，BMP 是编码原始图像的一种文件格式，一般采取不压缩的方式存储图像数据，因此文件体积非常大，不推荐在 web 使用。</p><table><thead><tr><th>文件格式</th><th>开发商</th></tr></thead><tbody><tr><td>BMP</td><td>微软</td></tr><tr><td>开发商</td><td>微软</td></tr><tr><td>发布时间</td><td>1987 年跟随 Windows2 发布</td></tr><tr><td>文件名后缀</td><td><code>.bmp</code>，<code>.dib</code></td></tr><tr><td>MIME</td><td><code>image/bmp``image/x-bmp</code></td></tr><tr><td>色深</td><td>最高支持 32 bpp，使用压缩算法后只支持 4bpp 或 8bpp</td></tr><tr><td>最大图像尺寸</td><td>2 ^ 31 - 1</td></tr><tr><td>兼容性</td><td>全平台</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="gif">GIF<a href="#gif" class="hash-link" aria-label="GIF的直接链接" title="GIF的直接链接">​</a></h2><p>GIF，Graphics Interchange Format，图形交换格式，使用 LZW 无损压缩算法来压缩图像数据，可以将多个图像存储在一个文件中，因此可以用 GIF 来制作动画帧。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="gif-的历史">GIF 的历史<a href="#gif-的历史" class="hash-link" aria-label="GIF 的历史的直接链接" title="GIF 的历史的直接链接">​</a></h3><p>GIF 最初版本为 87a，由美国 <a href="https://en.wikipedia.org/wiki/CompuServe" target="_blank" rel="noopener noreferrer">CompuServe</a> 公司在 1987 年发布，由于其支持彩色图像和使用高速的编解码算法，所以很快流行起来，但是此时的 GIF 还不支持动画。理论上，GIF 是最早在互联网流行的图像格式，比 JPEG 还早了三四年。</p><p>1989 年，CompuServe 公司又发布了一个增强版本 89a，此版本为 GIF 增加了图形控制拓展，允许 GIF 文件中的每一幅图像可以在等待一定的时间延迟后进行绘制，从第一幅图像开始绘制到最后一幅结束，不支持循环。</p><p>为了让 GIF 能够自动循环播放图像，Netscape 公司开发者在 1995 年在 GIF 动画帧序列前添加了一个表示帧播放次数的数据块，指定帧应该被播放的次数，从 0~ 65535 次，0 就表示永远循环，从此便有了强大的动画表情包。后续 Netscape 也将对 GIF 的支持添加到了浏览器中，后续随着网络发展，各大浏览器也都支持了，直到今天仍然使用的是 1989 年发布的 89a 标准。</p><table><thead><tr><th>开发者</th><th>美国 CompuServe 公司</th></tr></thead><tbody><tr><td>发布时间</td><td>1987</td></tr><tr><td>色深</td><td>8 bpp</td></tr><tr><td>是否支持 alpha 通道</td><td>不支持，但是 GIF 支持为每个颜色分量指定一个索引位作为透明背景颜色</td></tr><tr><td>支持动画</td><td>支持</td></tr><tr><td>支持隔行扫描</td><td>支持，允许部分下载渐进式解析</td></tr><tr><td>文件格式</td><td>GIF</td></tr><tr><td>文件名后缀</td><td><code>.gif</code></td></tr><tr><td>MIME</td><td><code>image/gif</code></td></tr><tr><td>最大图像尺寸</td><td>65536×65536</td></tr><tr><td>兼容性</td><td>全平台</td></tr><tr><td>缺陷</td><td>GIF 的缺陷主要由以下方面：GIF 无损压缩图像的压缩比不如视频压缩，导致多帧画面编码得到的文件体积过大；目前，越来越多的图像压缩标准支持动画，例如 webp，apng，heif 等，它们都具有更高压缩比和更出色的显示效果，谷歌开发者也推荐将 GIF 转换成 webm, mp4 等视频格式来减小体积；GIF 最多支持 256 种颜色，制作不了全彩图像，无法满足设计群体的要求GIF 更多的还是应用于 1MiB 下的动画图像，其余场景都有更好的图像格式选择。</td></tr><tr><td>开源工具</td><td><a href="https://github.com/imagemin/imagemin-gifsicle" target="_blank" rel="noopener noreferrer">imagemin-gifsicle</a>：nodejs 使用 gifsicle 优化 GIF 图像<br><a href="https://developers.google.com/speed/webp/docs/gif2webp" target="_blank" rel="noopener noreferrer">gif2webp</a>：将 GIF 转换成 webp<a href="https://ezgif.com/gif-to-apng" target="_blank" rel="noopener noreferrer">ezgif</a>：图像格式转换网站</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="pngapng">PNG/APNG<a href="#pngapng" class="hash-link" aria-label="PNG/APNG的直接链接" title="PNG/APNG的直接链接">​</a></h2><p>PNG，Portable Network Graphics，便携式网络图形，最初由一群计算机图形开发专家（PNG Development Group）组织开发，初衷是应对 GIF 使用的压缩算法 LZW 的专利争端。</p><p>PNG 提供的文件格式本身只支持编码单个图像，直到 2001 年，开发者发布了 MNG（多图像网络图形） 图像格式，让 PNG 也能像 GIF 那样支持动画，但是 MNG 格式并未得到主流浏览器的支持，早期只是 mozilla 和 netscape 支持，IE，chrome，safari 这些浏览器则从未支持 MNG。</p><p>此后，mozilla 开发者基于 PNG 开发出了 APNG（动画便捷式网络图形）格式并于 2008 年发布，兼容 PNG 格式的同时，支持动画显示，比 GIF 支持更高色深和更高的压缩比，动图质量更高且体积更小。但是 PNG 开发小组一直拒绝将 APNG 作为拓展纳入自己的标准，也就 mozilla 在背后推广，这就导致 APNG 一直没普及使用，再加上 mozilla 近年来相比 chrome 越来越势弱，APNG 的未来前景渺茫。</p><table><thead><tr><th></th><th>PNG</th><th>APNG</th></tr></thead><tbody><tr><td>开发者</td><td>PNG Development Group（PNG开发小组）</td><td>mozilla</td></tr><tr><td>发布时间</td><td>1996，2003 年纳入<a href="https://www.w3.org/TR/PNG/" target="_blank" rel="noopener noreferrer"> w3c 标准</a></td><td>2008</td></tr><tr><td>色深</td><td>32 bpp</td><td>32bpp</td></tr><tr><td>是否支持 alpha 通道</td><td>支持</td><td>支持</td></tr><tr><td>支持动画</td><td>不支持</td><td>支持</td></tr><tr><td>支持隔行扫描</td><td>支持，允许部分下载渐进式解析，但会增加图像体积</td><td>支持</td></tr><tr><td>文件格式</td><td>PNG，</td><td>APNG</td></tr><tr><td>文件名后缀</td><td><code>.png</code></td><td><code>.png</code></td></tr><tr><td>MIME</td><td><code>image/png</code></td><td><code>image/png</code>，<code>image/apng</code></td></tr><tr><td>最大图像尺寸</td><td>2 ^ 31 - 1</td><td>2 ^ 31 - 1</td></tr><tr><td>兼容性</td><td>PNG 全平台兼容</td><td>APNG 只有 IE 不支持<br><img loading="lazy" alt="image-20220830172040065" src="/assets/images/image-20220830172040065-c5800a57701e2ddbcec72e6fd48f0f3d.png" width="2600" height="854" class="img_MG2L"></td></tr><tr><td>开源库</td><td><a href="http://www.libpng.org/pub/png/libpng.html" target="_blank" rel="noopener noreferrer">libpng</a>：编解码 png</td><td><a href="https://sourceforge.net/projects/libpng-apng/" target="_blank" rel="noopener noreferrer">libpng-apng</a>：编辑码 APNG<br><a href="http://gif2apng.sourceforge.net/" target="_blank" rel="noopener noreferrer">gif2apng</a>：使用 c++ 开发转换 gif 到 apng</td></tr><tr><td>性能</td><td></td><td>相比 GIF 可以减少 20% 的体积，同时可编码的颜色更多，图像质量更高。</td></tr><tr><td>使用率</td><td>PNG 本身基本没有缺陷，在 web 上的使用率也一直是最高的</td><td>普及率不高，使用者较少</td></tr><tr><td>示例</td><td></td><td><img loading="lazy" alt="img" src="/assets/images/apng-20220830171949179-7b94752b57a542ff501f3a51d65a59d4.png" width="556" height="495" class="img_MG2L"></td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="webp">Webp<a href="#webp" class="hash-link" aria-label="Webp的直接链接" title="Webp的直接链接">​</a></h2><p>webp 实际本身主打的是无损压缩静态图像的格式，其无损压缩格式比 PNG 可以减少 26% 的体积。</p><table><thead><tr><th>开发者</th><th>google</th></tr></thead><tbody><tr><td>发布时间</td><td>2010</td></tr><tr><td>文件格式</td><td>RIFF，RIFF 是微软和 IBM 于 1991 推出的一种容器格式，可用来编码位图，音频，视频等数据形式，在此文件格式基础上还衍生出了 AVI，WAV 等文件格式。</td></tr><tr><td>文件名后缀</td><td><code>.webp</code></td></tr><tr><td>MIME</td><td><code>image/webp</code></td></tr><tr><td>色深</td><td>32 bpp</td></tr><tr><td>Alpha 通道</td><td>支持 8 bit</td></tr><tr><td>最大图像尺寸</td><td>16383 x 16383</td></tr><tr><td>支持动画</td><td>支持</td></tr><tr><td>兼容性</td><td>除了 IE 基本都支持<br><img loading="lazy" alt="image-20220830172305062" src="/assets/images/image-20220830172305062-f8fc20e1fd852bed59c6a49177833f6a.png" width="2604" height="1046" class="img_MG2L"></td></tr><tr><td>开源库</td><td><a href="https://storage.googleapis.com/downloads.webmproject.org/releases/webp/index.html" target="_blank" rel="noopener noreferrer">libwebp</a>：包含在 JPEG、PNG 和 webp 之间互相转换的 CLI 工具，<a href="https://developers.google.com/speed/webp/docs/cwebp" target="_blank" rel="noopener noreferrer">cwebp</a> 可以将  PNG、JPEG 转换成 Webp，dwebp 可以将 webp 转换成 PNG<br><a href="https://developers.google.com/speed/webp/docs/img2webp" target="_blank" rel="noopener noreferrer">img2webp</a>：从一系列输入图像创建动画 WebP 文件的 CLI 工具<br><a href="https://developers.google.com/speed/webp/docs/gif2webp" target="_blank" rel="noopener noreferrer">gif2webp</a>： 将 GIF 图像转换为 WebP 的 CLI 工具<br><a href="https://chromium.googlesource.com/codecs/libwebp2/" target="_blank" rel="noopener noreferrer">libwebp2</a>：第二版 libwebp<br><a href="https://github.com/imagemin/imagemin-webp" target="_blank" rel="noopener noreferrer">imagemin-webp</a>：nodejs 工具，转换 JPEG/PNG 到 webp 格式<br><a href="https://sharp.pixelplumbing.com/api-output#webp" target="_blank" rel="noopener noreferrer">sharp</a>：nodejs 工具，转换其他图像格式到 webp</td></tr><tr><td>普及率</td><td>就目前来看，使用 webp 网站还是相对较低，75% &lt;-&gt; 4.8%，有趣的是，google 目前自己也很少使用 webp，之前在 webstore 用过一段时间后又替换回了 jpeg 和 png<br><img loading="lazy" alt="image" src="/assets/images/image-67d1af2a2e45776145c441587cc07f00.png" width="900" height="500" class="img_MG2L"></td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="heic">HEIC<a href="#heic" class="hash-link" aria-label="HEIC的直接链接" title="HEIC的直接链接">​</a></h2><p>HEIC（High Efficiency Image Container，高效图像容器格式），是编码经过 HEVC（H.265，High Efficiency Video Coding）压缩过的图像的文件格式，是 IOS 11+ 系统内部默认图像格式，目前仅在 IOS 和 macOS 内部默认支持。</p><table><thead><tr><th>HEIC</th><th>High Efficiency Image Container</th></tr></thead><tbody><tr><td>开发者</td><td>MPEG（Moving Pictures Experts Group）</td></tr><tr><td>发布时间</td><td>2013</td></tr><tr><td>文件格式</td><td>HEIF（High Efficiency Image File Format），由 MPEG 开发并于 2015 年推出的一种容器格式，支持以不同的文件编码格式存储单个或多个图像，例如用来编码 HEVC 压缩过的图像使用 HEIC 文件格式，编码 AV1 压缩过的图像使用 AVIF 文件格式。</td></tr><tr><td>文件名后缀</td><td><code>.heic</code>，<code>.heics</code></td></tr><tr><td>MIME</td><td><code>image/heic</code>，<code>image/heic-sequence</code></td></tr><tr><td>最大色深</td><td>16 bpp</td></tr><tr><td>最大图像尺寸</td><td>8192×4352（8k）</td></tr><tr><td>是否支持透明</td><td>支持 alpha 分量</td></tr><tr><td>是否支持动画</td><td>支持</td></tr><tr><td>是否支持隔行扫描</td><td>不支持</td></tr><tr><td>兼容性</td><td><img loading="lazy" alt="image (1)" src="/assets/images/image (1)-2e542bde185a5235aaac56adc0ae4250.png" width="2610" height="890" class="img_MG2L"></td></tr><tr><td>开源库</td><td><a href="https://github.com/strukturag/libheif" target="_blank" rel="noopener noreferrer">libheif</a>：支持编解码 HEIF 和 HEIC 的 c++ 库<br><a href="https://sharp.pixelplumbing.com/api-output#heif" target="_blank" rel="noopener noreferrer">sharp</a>：nodejs 转换图像格式的工具，支持 HEIC</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="avif">AVIF<a href="#avif" class="hash-link" aria-label="AVIF的直接链接" title="AVIF的直接链接">​</a></h2><p>AVIF（AOMedia Video Image Format，AOM视频图像格式），是编码经过 AV1（AOMedia Video 1）算法压缩过的图像的文件格式，由 <a href="https://aomedia.org/" target="_blank" rel="noopener noreferrer">AOMedia（开放媒体联盟）</a>开发维护，最初规范 <a href="https://github.com/AOMediaCodec/av1-avif/releases" target="_blank" rel="noopener noreferrer">1.0.0 </a>于 2019 年 2 月发布，现今仍然沿用这个版本的规范。</p><p>AOMedia 由目前一些最具影响力的互联网公司组成，例如亚马逊、谷歌、苹果，Netflix，国内的有腾讯、阿里等等，这些公司通过共享其各自掌握的专利技术开发出了免版税的视频流数据压缩算法 AV1，以替代由 MPEG 推出的视频压缩算法 HEVC，避免向 HEVC 背后的专利持有者支付日益高昂的专利费。</p><table><thead><tr><th>AVIF</th><th>AOMedia Video Image Format</th></tr></thead><tbody><tr><td>开发者</td><td>AOMedia</td></tr><tr><td>发布时间</td><td>2019</td></tr><tr><td>文件格式</td><td>HEIF（High Efficiency Image File Format），由 MPEG 开发并于 2015 年推出的一种容器格式，支持以不同的文件编码格式存储单个或多个图像，例如用来编码 HEVC 压缩过的图像使用 HEIC 文件格式，编码 AV1 压缩过的图像使用 AVIF 文件格式。</td></tr><tr><td>文件名后缀</td><td><code>.avif</code></td></tr><tr><td>MIME</td><td><code>image/avif</code></td></tr><tr><td>最大色深</td><td>12 bpp</td></tr><tr><td>最大图像尺寸</td><td>8192×4352（8k）</td></tr><tr><td>是否支持透明</td><td>支持 alpha 分量</td></tr><tr><td>是否支持动画</td><td>支持</td></tr><tr><td>是否支持隔行扫描</td><td>不支持渐进式解析，必须完整下载图片才开始解析</td></tr><tr><td>兼容性</td><td>Edge 虽然用了 chromium 内核，但是不支持 avif<br><img loading="lazy" alt="image-20220830172809242" src="/assets/images/image-20220830172809242-3c9e28e202ac0c137b1241ef4d85fa4c.png" width="2720" height="966" class="img_MG2L"></td></tr><tr><td>开源库</td><td><a href="https://github.com/AOMediaCodec/libavif" target="_blank" rel="noopener noreferrer">libavif</a>：官方使用 C 编写的编解码 avif 的库<br><a href="https://github.com/Kagami/avif.js" target="_blank" rel="noopener noreferrer">avif.js</a>：avif polyfill，为不支持 avif 的浏览器提供支持<br><a href="https://sharp.pixelplumbing.com/api-output#avif" target="_blank" rel="noopener noreferrer">sharp</a>：nodejs 转换图像格式的工具，支持 avif<br><a href="https://avif.io/" target="_blank" rel="noopener noreferrer">avif.io</a>：支持转换其他图像格式到 avif 的网站</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="jpeg-xl">JPEG XL<a href="#jpeg-xl" class="hash-link" aria-label="JPEG XL的直接链接" title="JPEG XL的直接链接">​</a></h2><p>JPEG XL 是 JPEG（联合图像专家组）开发的新一代图像压缩算法和文件格式，建立在 google 开发的 <a href="https://github.com/google/pik" target="_blank" rel="noopener noreferrer">PIK</a> 和 cloudinary 开发的 <a href="https://github.com/cloudinary/fuif" target="_blank" rel="noopener noreferrer">FUIF（Free Universal Image Format）</a>基础上，其中 FUIF 又是建立在 <a href="https://github.com/FLIF-hub/FLIF" target="_blank" rel="noopener noreferrer">FLIF（Free Lossless Image Format）</a> 项目基础上，目前 PIK、FLIF、FUIF 都被废弃了，这些项目的开发者都已经转头全力支持 JPEG XL 编解码库 <a href="https://github.com/libjxl/libjxl" target="_blank" rel="noopener noreferrer">libjxl</a> 的开发。</p><p>JPEG XL 旨在替代当前的 JPEG 标准，其支持无损/有损压缩，也支持动画，并且免版税，其标准化的编码算法在 2022 年 5 月份才发布，标准号 ISO/IEC 18181。</p><table><thead><tr><th>JPEG XL</th><th>JPEG extended longterm</th></tr></thead><tbody><tr><td>开发者</td><td>JPEG</td></tr><tr><td>发布时间</td><td>2022</td></tr><tr><td>文件名后缀</td><td><code>.jxl</code></td></tr><tr><td>MIME</td><td><code>image/jxl</code></td></tr><tr><td>最大色深</td><td>32 bpp</td></tr><tr><td>最大图像尺寸</td><td>(2^30 - 1) * (2^30 - 1)</td></tr><tr><td>是否支持透明</td><td>支持 alpha 分量</td></tr><tr><td>是否支持动画</td><td>支持</td></tr><tr><td>是否支持隔行扫描</td><td>支持，可以渐进式解析</td></tr><tr><td>兼容性</td><td>暂无平台支持，但是 chrome 和 firefox 从 90 版本进入测试阶段，可以通过 flags 开启，例如 chrome://flags#enable-jxl<br><img loading="lazy" alt="image-20220830172946647" src="/assets/images/image-20220830172946647-15b5fef65effa482b9334cffb8d003be.png" width="2728" height="948" class="img_MG2L"></td></tr><tr><td>开源库</td><td><a href="https://github.com/libjxl/libjxl" target="_blank" rel="noopener noreferrer">libjxl</a>：使用 c++ 实现的编解码 JPEG XL 库<br><a href="https://squoosh.app/" target="_blank" rel="noopener noreferrer">squoosh</a>：在线转换图像格式，支持 JPEG XL<br><a href="https://github.com/GoogleChromeLabs/squoosh/tree/dev/libsquoosh" target="_blank" rel="noopener noreferrer">libSquoosh</a>：nodejs 转换图像格式的工具，支持 JPEG XL</td></tr></tbody></table>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[web图像格式对比（四）]]></title>
        <id>https://willes.github.io/webimage4</id>
        <link href="https://willes.github.io/webimage4"/>
        <updated>2022-08-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[nodejs 图像处理库]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="nodejs-图像处理库">nodejs 图像处理库<a href="#nodejs-图像处理库" class="hash-link" aria-label="nodejs 图像处理库的直接链接" title="nodejs 图像处理库的直接链接">​</a></h2><p>说完了有损压缩和无损压缩的图像格式，来整理下 nodejs 方面图像处理相关的库。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="sharp"><a href="https://sharp.pixelplumbing.com/" target="_blank" rel="noopener noreferrer">sharp</a><a href="#sharp" class="hash-link" aria-label="sharp的直接链接" title="sharp的直接链接">​</a></h2><p>基于 <a href="https://github.com/libvips/libvips" target="_blank" rel="noopener noreferrer">libvips</a> 实现，提供 JPEG、PNG、GIF、Webp、AVIF 以及 SVG 图像格式的处理，包括图像格式转换，图像尺寸缩放，图像组合，图像旋转，等等多种操作，也支持将图像转换成 base64 字符串。</p><p>例如将 png 转换成 avif</p><div class="language-JavaScript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-JavaScript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain"> import sharp from 'sharp';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> sharp('./images/rgb.png')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .toFormat('avif', { quality: 50 })</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .toFile('build/images/rgb.avif')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .then(info =&gt; console.log(info));</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如将 jpeg 转成 base64</p><div class="language-JavaScript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-JavaScript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">const resizedImageBuf = await require('sharp')(pathToMyImage)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  .toBuffer();</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">console.log(`data:image/png;base64,${resizedImageBuf.toString('base64')}`);</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="imagemin停止维护"><a href="https://github.com/imagemin/imagemin" target="_blank" rel="noopener noreferrer">imagemin</a>（停止维护）<a href="#imagemin停止维护" class="hash-link" aria-label="imagemin停止维护的直接链接" title="imagemin停止维护的直接链接">​</a></h2><p>imagemin 是插件式的压缩图像的工具，可通过引入自定义的插件来支持不同图像格式的转换和图像尺寸的优化，文档相对简陋，并且本身已停止维护，常用的插件有以下这些：</p><ul><li><p><a href="https://www.npmjs.com/package/imagemin-jpegtran" target="_blank" rel="noopener noreferrer">imagemin-jpegtran</a>：优化 jpeg 体积</p></li><li><p><a href="https://www.npmjs.com/package/imagemin-optipng" target="_blank" rel="noopener noreferrer">imagemin-optipng</a>：优化 png 体积</p></li><li><p><a href="https://www.npmjs.com/package/imagemin-gifsicle" target="_blank" rel="noopener noreferrer">imagemin-gifsicle</a>：优化 gif 体积</p></li><li><p><a href="https://www.npmjs.com/package/imagemin-webp" target="_blank" rel="noopener noreferrer">imagemin-webp</a>：转换到 webp</p></li><li><p><a href="https://www.npmjs.com/package/imagemin-svgo" target="_blank" rel="noopener noreferrer">imagemin-svgo</a>：基于 svgo 优化 svg</p></li></ul><div class="language-JavaScript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-JavaScript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">import imagemin from 'imagemin';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">import imageminWebp from 'imagemin-webp';</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">await imagemin(['images/*.{jpg,png}'], {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  destination: 'build/images',</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  plugins: [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    imageminWebp({ quality: 100 })</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="libsquoosh"><a href="https://github.com/GoogleChromeLabs/squoosh/tree/dev/libsquoosh" target="_blank" rel="noopener noreferrer">libsquoosh</a><a href="#libsquoosh" class="hash-link" aria-label="libsquoosh的直接链接" title="libsquoosh的直接链接">​</a></h2><p>Google 开发的 <a href="https://github.com/GoogleChromeLabs/squoosh/tree/dev/libsquoosh" target="_blank" rel="noopener noreferrer">libSquoosh</a>，支持使用 nodejs cli 转换图像格式的工具，支持 JPEG XL，具体的可以看这篇介绍 —— <a href="https://web.dev/introducing-libsquoosh/" target="_blank" rel="noopener noreferrer">Introducing libSquoosh</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="其他构建工具">其他构建工具<a href="#其他构建工具" class="hash-link" aria-label="其他构建工具的直接链接" title="其他构建工具的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="webpack">Webpack<a href="#webpack" class="hash-link" aria-label="Webpack的直接链接" title="Webpack的直接链接">​</a></h3><table><thead><tr><th>版本</th><th>loader</th><th>plugin</th></tr></thead><tbody><tr><td><code>&lt;= 4</code></td><td><code>url-loader</code>：支持读取图像并转换成 base64<code>file-loader</code>：支持读取图像</td><td><a href="https://github.com/Klathmon/imagemin-webpack-plugin" target="_blank" rel="noopener noreferrer">imagemin-webpack-plugin</a>(停止维护)<br><a href="https://github.com/webpack-contrib/image-minimizer-webpack-plugin" target="_blank" rel="noopener noreferrer">image-minimizer-webpack-plugin</a>：支持使用 <code>imagemin</code> 和<code>libsquoosh</code> 优化图像尺寸</td></tr><tr><td><code>5</code></td><td><a href="https://webpack.js.org/guides/asset-modules/" target="_blank" rel="noopener noreferrer">内置支持 - assets module</a></td><td></td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="vite">Vite<a href="#vite" class="hash-link" aria-label="Vite的直接链接" title="Vite的直接链接">​</a></h3><p><a href="https://github.com/vbenjs/vite-plugin-imagemin" target="_blank" rel="noopener noreferrer">vite-plugin-imagemin</a>：使用 imagemin 压缩图像</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="rollup">Rollup<a href="#rollup" class="hash-link" aria-label="Rollup的直接链接" title="Rollup的直接链接">​</a></h3><p><a href="https://github.com/rollup/plugins/tree/master/packages/image" target="_blank" rel="noopener noreferrer">@rollup/plugin-image</a>：支持<code>import</code> jpeg，png 等图像文件的语法并打包</p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[web图像格式对比（一）]]></title>
        <id>https://willes.github.io/webimage1</id>
        <link href="https://willes.github.io/webimage1"/>
        <updated>2022-08-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>根据 <a href="https://httparchive.org/reports/page-weight#reqImg" target="_blank" rel="noopener noreferrer">httpachive 的统计数据</a>，在统计的 5,431,533 个 PC 页面中:</p><ul><li><p>图像流量平均占页面的 44.5%（1032.0 KB -&gt; 2317.8 KB）</p></li><li><p>请求数量平均占页面的 33%（25 -&gt; 76）</p></li></ul><p>所以图像数据在网站内容部分占比巨大，使用合适的图像格式能有效降低网站的流量带宽，同时降低网络传输延时，提升用户体验。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="数字图像分类">数字图像分类<a href="#数字图像分类" class="hash-link" aria-label="数字图像分类的直接链接" title="数字图像分类的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="原始图">原始图<a href="#原始图" class="hash-link" aria-label="原始图的直接链接" title="原始图的直接链接">​</a></h3><p>Raw Image，原始文件，一般是通过单反相机拍摄得到的原始文件，保留大量图像细节，但是所需的文件存储空间非常大，可以通过 ps 等图像编辑软件处理，并且转换压缩后得到光栅图，然后才能在其他图像查看软件正常显示。</p><p>常见的原始文件格式一般有 BMP，adobe 的 DNG，佳能相机的 CR2 等。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="光栅图">光栅图<a href="#光栅图" class="hash-link" aria-label="光栅图的直接链接" title="光栅图的直接链接">​</a></h3><p>Raster Image，光栅图，或者叫位图，由像素组成。</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="像素">像素<a href="#像素" class="hash-link" aria-label="像素的直接链接" title="像素的直接链接">​</a></h4><p>pixel，像素，每个像素都是原始图像的一个采样样本，也是图像的最小可编辑单元。在计算机显示设备上，每个像素的颜色有三个分量，也就是三原色（RGB-红绿蓝）。</p><p>通过改变 RGB 每个分量的权重来达到组合成其他颜色的目的，这就需要提到色深的概念。</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="色深">色深<a href="#色深" class="hash-link" aria-label="色深的直接链接" title="色深的直接链接">​</a></h4><p>色深是编码单个像素点所使用的 bit 数，使用 bpp(bit per pixel)单位。色深主要用来表示单个像素所能展示的颜色数量，呈 2 的指数级关系：</p><ul><li><p>1 bpp，2^1 = 2 种颜色，也就是黑色和白色</p></li><li><p>2 bpp，2^2 = 4 种颜色</p></li><li><p>8 bpp，2^8 = 256 种颜色</p></li><li><p>24 bpp，2^24 = 16777216 种颜色，能达到人眼识别的颜色范围</p></li><li><p>32 bpp，在 24 位色深的基础上增加 8 bit 单独的 alpha 分量，然后通过每个颜色分量和  alpha 分量叠加运算改变其透明度；支持 alpha 分量的图像可以单独显示出图像内部透明区域，例如实现透明背景</p></li></ul><p><img loading="lazy" alt="image-20220830163435801" src="/assets/images/image-20220830163435801-5badfb8313e82ac98d9f381c619c8525.png" width="2104" height="1370" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="矢量图">矢量图<a href="#矢量图" class="hash-link" aria-label="矢量图的直接链接" title="矢量图的直接链接">​</a></h3><p>Vector Image，矢量图，基于笛卡尔坐标系内的点组成的几何图形，常见的也就是 SVG 格式的图像。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="位图和矢量图的对比">位图和矢量图的对比<a href="#位图和矢量图的对比" class="hash-link" aria-label="位图和矢量图的对比的直接链接" title="位图和矢量图的对比的直接链接">​</a></h3><ol><li>矢量图的呈现不会受到图像尺寸的影响，这是相对于位图的优势；</li><li>矢量图支持编程化动态修改其图像本身的尺寸，颜色等细节；</li><li>位图比矢量图具有更丰富的颜色细节，更适合表现真实世界的物品和艺术创作，而矢量图往往应用于工程制图方面；</li><li>从位图到矢量图的转换叫图像追踪或光栅矢量化，相反，从矢量图转换成位图叫光栅化。</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="图像压缩概念">图像压缩概念<a href="#图像压缩概念" class="hash-link" aria-label="图像压缩概念的直接链接" title="图像压缩概念的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="为什么需要压缩">为什么需要压缩<a href="#为什么需要压缩" class="hash-link" aria-label="为什么需要压缩的直接链接" title="为什么需要压缩的直接链接">​</a></h3><p>从色深和图像的像素数可以计算出一张原始图像所需的存储空间大小：
$$
width <em> height </em> n (bpp) / 8 = <!-- -->[size]<!-- --> byte
$$
例如一张 1920 * 1080 像素宽高的 24 bpp 图像，所需约 7.91 MB，那么对于标称 500G 的硬盘，完全占用的情况只能存储 63254 张该图像；不仅如此，考虑到图像需要在不同设备或网络上传输，这个体积也是无法接受的，所以就需要图像压缩算法来减小图像数据的体积，节约在计算机设备上存储成本以及网络传输的带宽成本。</p><p>图像压缩分为有损压缩和无损压缩：</p><ul><li>无损压缩指的是计算机根据逆向的解压缩算法能完全恢复原始图像，</li><li>有损压缩则无法从解压缩算法恢复得到原始图像，所以有损压缩后的图像显示效果可能在人眼观察上有所降低。</li></ul><p>经过图像压缩算法得到的数据还需要指定文件编码格式，以便于图像数据在计算机系统上存储、读取和共享，文件格式通常和文件名后缀是对应的，但是具体的文件格式还是要根据文件编码的开头数据来确定。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="压缩比率">压缩比率<a href="#压缩比率" class="hash-link" aria-label="压缩比率的直接链接" title="压缩比率的直接链接">​</a></h3><p>压缩软件一般都会提供压缩比选择范围，压缩比是 <strong>原始数据/压缩后数据</strong> 计算得到的比率，同时，也会提供图像质量参数供选择，开发者需要权衡质量和图像体积选择的权重。
$$
compression ratio = uncompressed size / compressed size
$$</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="解析模式">解析模式<a href="#解析模式" class="hash-link" aria-label="解析模式的直接链接" title="解析模式的直接链接">​</a></h3><p>图像编解码算法有两种解析模式，基线解析和渐进式解析：</p><ul><li><p>基线解析：如果是从 web 加载，需要完全下载图像后从上往下解析图像并显示；</p></li><li><p>渐进式解析：渐进式相比基线编码式采用更复杂的隔行扫描式编码方式，同时解码也是隔行扫描解码，所以相比基线解码从上往下解析逐渐得到整张图像的方式，隔行扫描会更快看到整张图像的大致影像；应用于 web 方面，浏览器在下载到图像的部分数据后就能解析呈现整张图像的模糊缩影，后续继续下载数据再慢慢绘制整张完整的图像，从而优化慢速网络环境下的用户体验。</p></li></ul><p>参见基线编码模式下的 JPEG 和渐进式编码模式的 JPEG 解析对比：<a href="https://nerds.sh/snippets/baseline-vs-progressive.html" target="_blank" rel="noopener noreferrer">https://nerds.sh/snippets/baseline-vs-progressive.html</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="图像兼容性处理">图像兼容性处理<a href="#图像兼容性处理" class="hash-link" aria-label="图像兼容性处理的直接链接" title="图像兼容性处理的直接链接">​</a></h2><p>如果网站在使用一些较新的图像压缩格式（<code>avif</code>，<code>webp</code>等）时，可能在不同的浏览器上会出现兼容性问题，这时候可以通过 HTML5 的<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture" target="_blank" rel="noopener noreferrer"><code>picture</code>元素</a>来解决。</p><p><code>picture</code>元素内部可以包含多个<code>source</code>元素和一个<code>img</code>元素，浏览器会首先根据<code>source</code>的<code>media</code>或<code>type</code>等属性来检测是否支持加载改图像，如果不匹配或者浏览器本身不支持<code>picture</code>元素，则直接采用<code>img</code>指定的图像。</p><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">picture</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">source</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">srcset</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">photo.avif</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">image/avif</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">source</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">srcset</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">photo.webp</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">image/webp</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">img</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">src</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">photo.jpg</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">alt</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">photo</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">picture</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="source-元素">source 元素<a href="#source-元素" class="hash-link" aria-label="source 元素的直接链接" title="source 元素的直接链接">​</a></h3><p><code>source</code>元素包含以下属性：</p><ul><li><code>media</code>：指定媒体查询条件</li><li><code>type</code>：指定 <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types" target="_blank" rel="noopener noreferrer">MIME type</a>，浏览器不支持就会跳过</li><li><code>srcset</code>：指定一个或多个图像的 URL，多个图像的 URL 使用逗号分隔</li></ul><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">source</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">srcset</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">mdn-logo-wide.avif</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">media</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">(min-width: 600px)</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">image/avif</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="picture-元素的兼容性">picture 元素的兼容性<a href="#picture-元素的兼容性" class="hash-link" aria-label="picture 元素的兼容性的直接链接" title="picture 元素的兼容性的直接链接">​</a></h3><p>除了 IE 都支持（IE 于 2022-05-26 停止维护）</p><p><img loading="lazy" alt="image-20220830175646253" src="/assets/images/image-20220830175646253-b3d61acefb82319a9bd7d906a7903036.png" width="2726" height="896" class="img_MG2L"></p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[web图像格式对比（二）]]></title>
        <id>https://willes.github.io/webimage2</id>
        <link href="https://willes.github.io/webimage2"/>
        <updated>2022-08-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[有损压缩]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="有损压缩">有损压缩<a href="#有损压缩" class="hash-link" aria-label="有损压缩的直接链接" title="有损压缩的直接链接">​</a></h2><p>有损压缩目前使用最广泛的是 JPEG 压缩算法和文件格式，下面来整理一下三种有损压缩格式。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="jpeg">JPEG<a href="#jpeg" class="hash-link" aria-label="JPEG的直接链接" title="JPEG的直接链接">​</a></h3><p>JPEG 是 <strong>Joint Photographic Experts Group(联合图像专家组)</strong> 的首字母缩写，其前身是 <strong>——</strong> <strong>Joint Bi-level Image Experts Group(联合二进制图像专家组)</strong>，JBIG 负责制定二进制图像（二进制图像的每个像素只能使用一个 bit 表示黑色或者白色，也就是黑白图像）的压缩编码格式，例如 JBIG1 和 JBIG2；联合图像专家组负责维护 JBIG 标准以及制定彩色图像压缩新的算法标准。</p><p>实际上，联合图像专家组于 1992 年发布 JPEG 标准后还制定了一系列其他压缩标准，以下是 JPEG 家族的图像压缩标准：</p><table><thead><tr><th></th><th>JPEG</th><th><div style="width:290px">JPEG 2000</div></th><th><div style="width:290px">JPEG LS（lossless）</div></th><th>JPEG XR（extended range）</th><th>JPEG XT（extended tone still image）</th><th><div style="width:290px">JPEG XS（extended extra small）</div></th><th><div style="width:290px">JPEG XL（extended longterm）</div></th></tr></thead><tbody><tr><td>发布时间</td><td>1992</td><td>1997</td><td>1998</td><td>2011</td><td>2015</td><td>2019</td><td>2022</td></tr><tr><td>文件格式</td><td>JFIF，Exif，TIFF</td><td>JP2，JPX</td><td></td><td>JXR</td><td>JFIF</td><td>JXS</td><td>JXL</td></tr><tr><td>文件后缀名</td><td><code>.jpeg</code>，<code>.jpg</code>，<code>.jfif</code>，<code>.jif</code>，<code>.jpe</code>，<code>.tif</code></td><td><code>jp2</code>, <code>.j2k</code>, <code>.jpf</code>, <code>.jpm</code>, <code>.jpg2</code>, <code>.j2c</code>, <code>.jpc</code>, <code>.jpx</code>, <code>.mj2</code></td><td><code>.jls</code></td><td><code>.jxr</code>，<code>.hdp</code>，<code>.wdp </code></td><td><code>.jpeg</code>，<code>.jpg</code>，<code>.jfif</code>，<code>.jif</code>，<code>.jpe</code></td><td><code>.jxs</code></td><td><code>.jxl</code></td></tr><tr><td>有损/无损</td><td>有损，也支持无损但不常用</td><td>有损，也支持无损但不常用</td><td>无损</td><td>有损/无损</td><td>无损</td><td>有损</td><td>有损/无损</td></tr><tr><td>最大图像分辨率</td><td>(2^16 - 1) * (2^16 - 1)</td><td>(2^32 - 1) * (2^32 - 1)</td><td></td><td></td><td></td><td></td><td>(2^30 - 1) * (2^30 - 1)</td></tr><tr><td>色深</td><td>8 bpp</td><td>32 bpp</td><td></td><td>16 bpp</td><td>8 bpp</td><td>16 bpp</td><td>24 bpp，32 bpp</td></tr><tr><td>是否支持 alpha 通道</td><td>不支持</td><td>支持</td><td></td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>MIME type</td><td><code>image/jpeg</code></td><td><code>image/jp2</code>, <code>image/jpx</code>, <code>image/jpm</code>,</td><td></td><td><code>image/jxr</code>，<code>image/vnd.ms-photo</code></td><td><code>image/jpeg</code></td><td><code>image/jxsc</code>, <code>video/jxsv</code></td><td><code>image/jxl</code></td></tr><tr><td>兼容性</td><td>全平台</td><td>只有 safari 支持</td><td>已知 Chrome 有查看医学成像的插件 —— <a href="https://chrome.google.com/webstore/detail/dicom-medical-image-reade/phakdkeobphiapdoggpcdilgmjbepnfg?hl=ro" target="_blank" rel="noopener noreferrer">medical-image</a>，其他平台未知</td><td>只有 IE 支持</td><td>暂无平台使用</td><td>暂无平台使用</td><td>暂无平台支持，但是 chrome 和 firefox 从 90 版本进入测试阶段，可以开启实验性特性</td></tr><tr><td>对比</td><td></td><td>相比 JPEG 标准，JPEG-2000 着重提升码流的灵活性组织，使得图片传输可以渐进式加载：也就是用户在收到整个文件的一小部分后，查看者可以看到最终图片的质量较低的版本，然后通过从源下载更多数据位，质量会逐渐提高。</td><td>JPEG LS 主要优化了 JPEG 无损压缩部分的算法，可以实现 2:1 的压缩比，并且提高了编解码速度，主要应用于医学成像领域，例如 X 光片。</td><td>与 JPEG 相比，JPEG XR 文件格式支持更高的压缩比，以对具有同等质量的图像进行编码。</td><td></td><td>JPEG XS 被称为视觉无损低延迟轻量级图像，主要适用于网络码流传输场景下的图像压缩，因为其具有超高速的编解码压缩算法和高达 10:1 的压缩比，同时其编码器可以根据带宽动态调整压缩比来完美匹配可用带宽，从而减少图像传输延迟时间。</td><td>目前被图像专家组纳入标准，旨在替代当前的 JPEG 压缩标准，有损压缩相比目前的 JPEG 可以减小约 60% 的体积，同时优化了高压缩比下的图像质量，无损压缩相比 PNG 减少 35% 的体积。</td></tr><tr><td>开源库</td><td><a href="https://github.com/thorfdbg/libjpeg" target="_blank" rel="noopener noreferrer">libjpeg</a>：官方于 1992 发布的编解码 jpeg 库<br><a href="https://github.com/libjpeg-turbo/libjpeg-turbo" target="_blank" rel="noopener noreferrer">libjpeg-turbo</a>：社区基于 libjpeg 实现的增强版本，于 2010 发布，相比  libjpeg ，编码速度提升 2~6 倍，因此使用更广泛，例如 <a href="https://chromium.googlesource.com/chromium/deps/libjpeg_turbo/" target="_blank" rel="noopener noreferrer">chromium</a><br><a href="https://github.com/mozilla/mozjpeg" target="_blank" rel="noopener noreferrer">mozjpeg</a>：mozilla 开发者于 2014 推出的版本，基于 libjpeg-turbo，相比 libjpeg-turbo 压缩的文件体积减小 10% 左右<br><a href="https://github.com/google/guetzli" target="_blank" rel="noopener noreferrer">Guetzli</a>：google 于 2016 年推出的基于 libjpeg 实现的版本，相比 libjpeg 压缩得到的文件体积减小 20~30%</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>备注</td><td>TIFF（Tag Image File Format），标记图像文件格式，可以存储一张或者多张位图，可以不压缩，或者无损压缩、有损压缩； 但是通常文件体积都比较大，因此很少用于 web，浏览器也只有 Safari 支持读取这种文件格式。<br>Exif（Exchange Image File Format） 是拓展于 TIFF 的一种文件格式，可用于编码压缩后的 JFIF 文件， 同时也可以用于音频文件的编码。</td><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="ico">ICO<a href="#ico" class="hash-link" aria-label="ICO的直接链接" title="ICO的直接链接">​</a></h3><p>ICO，icon，最初由微软公司开发用于 windows 系统应用程序显示在桌面、任务栏以及文件管理器内部的图标，在 web 上可以用于 favicon（favorite icon）。</p><table><thead><tr><th>属性</th><th>解释</th></tr></thead><tbody><tr><td>发布时间</td><td>1999，2010 年通过 html5 规范支持<code>link</code>的<code>rel=icon</code>属性</td></tr><tr><td>MIME</td><td><code>image/vnd.microsoft.icon</code>，<code>image/x-icon</code></td></tr><tr><td>文件名后缀</td><td><code>.ico</code></td></tr><tr><td>色深</td><td>8 bpp，24 bpp，32 bpp</td></tr><tr><td>最大尺寸</td><td>256×256</td></tr><tr><td>兼容性</td><td>全平台</td></tr></tbody></table><p>favicon 通常用于显示在浏览器标签页 title、收藏夹等位置的图标，通过 HTML 规范定义的<code>link</code>标签和<code>rel=icon</code>或者<code>rel=apple-touch-icon</code>来嵌入到页面代码中，并且可以通过<code>sizes</code>属性来提供跨浏览器支持。</p><p>浏览器默认支持的尺寸要求如下：</p><ul><li><p>Chrome desktop：32×32（大部分浏览器都默认支持 32×32）</p></li><li><p>Safari desktop：32×32</p></li><li><p>IOS Safari：180×180</p></li><li><p>Android Chrome：196×196</p></li><li><p>IE：16×16, 32×32, 48×48</p></li></ul><div class="language-HTML codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-HTML codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;link rel="icon" sizes="32x32" href="icon.png"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;link rel="icon" sizes="180x180" href="icon-180x180.png"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;link rel="apple-touch-icon" sizes="180x180" href="icon.png"&gt;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&lt;link rel="icon" href="/favicon.svg" type="image/svg+xml"&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>目前 favicon 使用 PNG 的更多，但是未来的趋势是用 SVG 格式，因为 SVG 没有尺寸限制，不受设备分辨率影响且通常体积小于 PNG，而且支持运行时动态修改其样式，不足点是 svg favicon 的兼容性非常不好，目前仅在使用 chromium 内核的浏览器支持。</p><p><img loading="lazy" alt="image-20220830171340802" src="/assets/images/image-20220830171340802-fdf44a4e29c301efbad00f5ce8c9e199.png" width="2600" height="1020" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="webp">Webp<a href="#webp" class="hash-link" aria-label="Webp的直接链接" title="Webp的直接链接">​</a></h3><p>Webp（读作weppy），webp 支持有损压缩，但是有损压缩效果在某些时候要弱于 JPEG，这里不多赘述，见后面文章无损压缩的分析。</p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[混合内容请求限制]]></title>
        <id>https://willes.github.io/mixcontent</id>
        <link href="https://willes.github.io/mixcontent"/>
        <updated>2022-07-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>这两天又遇到一个图片问题，具体就是在 HTTPS 协议网页请求完的 HTTP 图片会被限制下载，这...，web 静态资源的问题还挺多坑。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是混合内容">什么是混合内容<a href="#什么是混合内容" class="hash-link" aria-label="什么是混合内容的直接链接" title="什么是混合内容的直接链接">​</a></h2><p>Mixed Content 来自于 W3C 规范的定义 —— <a href="https://w3c.github.io/webappsec-mixed-content/" target="_blank" rel="noopener noreferrer">混合内容 (以下简称规范)</a>，简单来说，当使用 HTTPS 请求的网页中包含其他通过 HTTP 请求的资源时，这些通过 HTTP 请求的内容就属于 Mixed Content。</p><p>W3C 的这篇规范不建议浏览器一律阻止所有混合内容的请求，视情况而定，将混合内容分为两种：</p><ul><li>可升级的混合内容请求，一般也被称为被动/显示混合内容</li><li>无法升级的混合内容请求，一般也被称为主动型混合内容</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="被动型混合内容">被动型混合内容<a href="#被动型混合内容" class="hash-link" aria-label="被动型混合内容的直接链接" title="被动型混合内容的直接链接">​</a></h3><p>被动混合内容主要是<code>img</code>，<code>video</code>，<code>audio</code>这些元素通过<code>src</code>属性指定的 URL 发起的请求，其本身既不受同源策略的限制，也不会受到这里混合内容的访问限制，并且浏览器还会自动帮助完成 HTTPS 访问的升级，然后在浏览器控制台给出一条如下提示内容，具体的可以移步这个网页观察细节 —— <a href="https://mixed-content.vercel.app/" target="_blank" rel="noopener noreferrer">mixed content example (mixed-content.vercel.app)</a></p><p><img loading="lazy" alt="image-20220719232438771" src="/assets/images/image-20220719232438771-ca4a85f6bbe1afe328e881008b348bc3.png" width="918" height="109" class="img_MG2L"></p><p>如果资源本身无法通过 HTTPS 访问，那么资源不会被加载并且报错。</p><p>W3C 也有个响应头来限制所有 HTTPS 站点内的 HTTP 请求 —— <code>Content-Security-Policy: block-all-mixed-content</code>，可以通过<code>meta</code>标签指定，不过这个请求头支持的浏览器比较少，目前这个属性值是被弃用了。</p><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">http-equiv</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">Content-Security-Policy</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">  </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">block-all-mixed-content</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20220719233328676" src="/assets/images/image-20220719233328676-44a73759311d0c48083d1cc5c82a315c.png" width="1702" height="435" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="主动型混合内容">主动型混合内容<a href="#主动型混合内容" class="hash-link" aria-label="主动型混合内容的直接链接" title="主动型混合内容的直接链接">​</a></h3><p>主动性混合内容是指可以直接获取并修改页面数据的请求，也就是<code>XMLHttpRequest</code>和<code>fetch</code>发起的 HTTP 请求，这些请求会被浏览器直接拦截，并不会发起跨域请求，然后在控制台提示报错信息。</p><p><img loading="lazy" alt="image-20220720220835786" src="/assets/images/image-20220720220835786-f1599c75dacdbcd21b4489c24c142e99.png" width="784" height="277" class="img_MG2L"></p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_amsr"><div class="admonitionHeading_n8eI"><span class="admonitionIcon_HzUW"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_qhyd"><p>主动型混合内容无法通过前端解决，只能后端统一升级 HTTPS，或者对于页面能够通过 HTTPS 请求的内容，手动修改请求 URL 的协议。</p></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[私有网络访问限制]]></title>
        <id>https://willes.github.io/pna</id>
        <link href="https://willes.github.io/pna"/>
        <updated>2022-07-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>上一篇 blog 提到了跨域访问图像资源引起的 canvas 污染的问题，其实当时我在查看跨域请求到的图像资源时，还无意中发现了一个新的 HTTP 响应头<code>Access-Control-Allow-Private-Network</code>，这篇文章就来简单探讨一下这个非常新的跨域请求的特性。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="access-control-allow-private-network">Access-Control-Allow-Private-Network<a href="#access-control-allow-private-network" class="hash-link" aria-label="Access-Control-Allow-Private-Network的直接链接" title="Access-Control-Allow-Private-Network的直接链接">​</a></h2><p><code>Access-Control-Allow-Private-Network</code>是 W3C 社区草案 <a href="https://wicg.github.io/private-network-access/" target="_blank" rel="noopener noreferrer">Private Network Access 草案</a>（以下简称<code>PNA</code>）制定的新的 HTTP 响应头字段，要求浏览器在判定从公共网络请求私有网络或者本地网络的跨域请求场景时，必须先发送预检请求，同时携带<code>Access-Control-Request-Private-Network: true</code>请求头，只有当服务端携带了<code>Access-Control-Allow-Private-Network: true</code>响应头字段时，才能继续发送原始请求，否则提示跨域错误。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是私有网络请求">什么是私有网络请求<a href="#什么是私有网络请求" class="hash-link" aria-label="什么是私有网络请求的直接链接" title="什么是私有网络请求的直接链接">​</a></h2><p><code>PNA</code>草案将域名<code>ip</code>分为以下三种类型，从<code>public ip</code>请求<code>private ip</code>或者<code>localhost</code>；以及从<code>private ip</code>请求<code>localhost</code>这两种情况都属于私有网络请求的范围，浏览器还可以拓展这个<code>ip</code>的限定范围。</p><ul><li><code>local</code>：本地<code>ip</code></li><li><code>private</code>：私有<code>ip</code></li><li><code>public</code>：公共<code>ip</code></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="私有地址段">私有地址段<a href="#私有地址段" class="hash-link" aria-label="私有地址段的直接链接" title="私有地址段的直接链接">​</a></h3><p>一般来说<code>private ip</code>和<code>local ip</code>也就是以下这些，包括了一些<code>ipv6</code>的地址段。</p><table><thead><tr><th>ip</th><th>ip 类型</th></tr></thead><tbody><tr><td><code>127.0.0.0/8</code></td><td><code>local</code></td></tr><tr><td><code>10.0.0.0/8</code></td><td><code>private</code></td></tr><tr><td><code>172.16.0.0/12</code></td><td><code>private</code></td></tr><tr><td><code>192.168.0.0/16</code></td><td><code>private</code></td></tr><tr><td><code>169.254.0.0/16</code></td><td><code>private</code></td></tr><tr><td><code>::1/128</code></td><td><code>local</code></td></tr><tr><td><code>fc00::/7</code></td><td><code>private</code></td></tr><tr><td><code>fe80::/10</code></td><td><code>private</code></td></tr></tbody></table><div class="theme-admonition theme-admonition-info alert alert--info admonition_amsr"><div class="admonitionHeading_n8eI"><span class="admonitionIcon_HzUW"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>信息</div><div class="admonitionContent_qhyd"><p>ipv4 采用点分十进制表示，使用<code>.</code>分为 4 段，每段都由 1 个字节 8 位二进制数组成，转换成 10 进制表示范围就是 0~255</p><p><img loading="lazy" alt="image-20220703213259809" src="/assets/images/image-20220703213259809-b35db4ad4d4e4bc1a85beb1533056522.png" width="627" height="355" class="img_MG2L"></p><p>ipv6 采用冒分十六进制表示，使用<code>:</code>分为 8 段，每段由 2 个字节 16 位二进制数组成，但是表示的时候采用 16 进制的形式取四合一得到 4 个 16 进制的数；如果一个段内都是<code>0</code>，那么该段可以简写成一个<code>0</code>表示；同时如果连续两段以上都是<code>0</code>，可以简写成<code>::</code>来表示所有为<code>0</code>的段。</p><p><img loading="lazy" alt="image-20220703215337219" src="/assets/images/image-20220703215337219-656efd9c5ee60984ea0825dd99f6c825.png" width="724" height="376" class="img_MG2L"></p></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="chrome-进展">chrome 进展<a href="#chrome-进展" class="hash-link" aria-label="chrome 进展的直接链接" title="chrome 进展的直接链接">​</a></h2><p>从 <a href="https://developer.chrome.com/blog/private-network-access-update/#timeline" target="_blank" rel="noopener noreferrer">Chrome 规划的时间线</a>来看:</p><ul><li>Chrome 94 推出测试版，开始在控制台对私有网络请求显示警告提示；</li><li>Chrome 102 版本测试结束，需要手动开启试验特性；</li><li>Chrome 105 版本正式推出</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="测试效果">测试效果<a href="#测试效果" class="hash-link" aria-label="测试效果的直接链接" title="测试效果的直接链接">​</a></h2><p>默认情况下，Chrome 102 稳定版后默认不会支持<code>PNA</code>，我们先来看下不开启的效果。</p><p>我这里使用了 Chrome 103 稳定版测试了<code>PNA</code>特性，测试步骤如下：</p><ol><li>在 GitHub 新建一个只包含以下网页的仓库，也就是点击<code>fetch</code>就会请求本地网络的<code>index.html</code>文件，然后通过 vercel 发布到公共网络；</li></ol><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token doctype punctuation" style="color:rgb(248, 248, 242)">&lt;!</span><span class="token doctype doctype-tag">DOCTYPE</span><span class="token doctype"> </span><span class="token doctype name">html</span><span class="token doctype punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">html</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">lang</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">en</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">title</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">Home</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">title</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">charset</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">UTF-8</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">meta</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">viewport</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">width=device-width</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">body</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">div</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">a</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">javascript:;</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag special-attr attr-name" style="color:rgb(241, 250, 140)">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag special-attr attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:rgb(80, 250, 123)">fetchLocalhost</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token tag special-attr attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">aria-current</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">page</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">        </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">fetch</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">a</span><span class="token tag" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token tag" style="color:rgb(255, 121, 198)">      </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">div</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript function" style="color:rgb(80, 250, 123)">fetchLocalhost</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">        </span><span class="token script language-javascript function" style="color:rgb(80, 250, 123)">fetch</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript string" style="color:rgb(255, 121, 198)">'http://127.0.0.1:8080/index.js'</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token script language-javascript method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript parameter">res</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator">=&gt;</span><span class="token script language-javascript">                 </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">          </span><span class="token script language-javascript console class-name">console</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token script language-javascript method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token script language-javascript"> res</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token script language-javascript method function property-access" style="color:rgb(80, 250, 123)">text</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">        </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token script language-javascript"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token script language-javascript">    </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">script</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">body</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">html</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>在本地电脑另建一个新的文件夹，添加<code>index.js</code>文件，通过<code>http-server</code>启动一个本地服务器，并开启<code>CORS</code>，这样<code>index.html</code>就会暴露在<code>127.0.0.1:8080</code>下，并且允许跨域访问；</li></ol><p><img loading="lazy" alt="image-20220704004910426" src="/assets/images/image-20220704004910426-0f21a62bb16e8ea0ba7c58b272231ae3.png" width="665" height="334" class="img_MG2L"></p><ol start="3"><li>然后打开 vercel 部署的公共网页，点击 fetch 发起请求，可以看到这里公共网络的请求顺利拿到了本地服务的<code>index.js</code>文件</li></ol><p><img loading="lazy" alt="413123131" src="/assets/images/413123131-96b4aa7f470317bb0b649c6fc0585e9d.gif" width="1114" height="692" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="开启-pna">开启 PNA<a href="#开启-pna" class="hash-link" aria-label="开启 PNA的直接链接" title="开启 PNA的直接链接">​</a></h3><p>现在我通过<code>chrome://flags</code>手动开启下面的试验特性，可观察到以下结果：</p><ul><li><a href="chrome://flags/#private-network-access-send-preflights" target="_blank" rel="noopener noreferrer">private-network-access-send-preflights</a>：发送预检请求，并在响应头不包含<code>Access-Control-Allow-Private-Network: true</code>时只在控制台显示警告，而不阻止后续请求的发送和结果的获取；</li></ul><p><img loading="lazy" alt="image-20220704005719958" src="/assets/images/image-20220704005719958-a64ba96051c5d2194cffd6ad16273844.png" width="1304" height="668" class="img_MG2L"></p><ul><li><a href="chrome://flags/#private-network-access-respect-preflight-results" target="_blank" rel="noopener noreferrer">private-network-access-respect-preflight-results</a>：仅在预检请求获取的响应包含<code>Access-Control-Allow-Private-Network: true</code>时才会发送后续请求，即使本地服务开启了<code>CORS</code>响应头<code>Access-Control-Allow-Origin:*</code>等也无济于事。</li></ul><p><img loading="lazy" alt="image-20220704005925970" src="/assets/images/image-20220704005925970-b13a270f523ca624a542cc8ad969a9e2.png" width="1530" height="451" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2><p>总体来说，<code>PNA</code>这个跨域请求限制对于开发者来说非常安全，前端开发场景经常需要在本地启动开发环境的本地服务代理本地资源，如果开发期间不小心点了某个网页，其具有对本地服务攻击性的请求，那么数据泄露将是毁灭性的。其实这也是 CSRF 攻击的一种，具体的 CSRF 攻击探讨下篇继续。</p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[canvas 污染问题]]></title>
        <id>https://willes.github.io/tainted_canvas</id>
        <link href="https://willes.github.io/tainted_canvas"/>
        <updated>2022-06-29T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>前端时间实现了一个用<code>canvas</code>往模板图片绘制数据的功能点，遇到了一个跨域引起<code>canvas</code><strong>污染</strong>的问题，仔细发掘下去发现不少的技术点。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="tainted-canvas">tainted canvas<a href="#tainted-canvas" class="hash-link" aria-label="tainted canvas的直接链接" title="tainted canvas的直接链接">​</a></h2><p>对于<code>canvas</code>污染的问题，这应该是非常常见的在处理跨域资源时会遇到的问题。</p><p>一般来说，利用<code>canvas</code>绘制图像的时候需要执行以下步骤:</p><ol><li>创建<code>canvas</code>元素；</li><li>获取<code>canvas</code>元素的二维渲染上下文对象；</li><li>创建<code>Image</code>对象并加载；</li><li>等待图像加载完成的时候绘制在<code>canvas</code>上</li></ol><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> canvas </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">document</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">createElement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"canvas"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> ctx </span><span class="token operator">=</span><span class="token plain"> canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"2d"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> img </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">Image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'xxxx'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(80, 250, 123)">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">width</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">height</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">drawImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当使用<code>drawImage</code>方法绘制一个<strong>不同源</strong>的图像时，此时并不会报错，但是<code>canvas</code>会变成<code>tainted </code>（被污染），之后如果在当前被污染的<code>canvas</code>上调用以下方法时就会抛出<code>SecurityError</code>的错误。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_amsr"><div class="admonitionHeading_n8eI"><span class="admonitionIcon_HzUW"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_qhyd"><ul><li><code>HTMLCanvasElement.toDataURL()</code></li><li><code>HTMLCanvasElement.toBlob()</code></li><li><code>CanvasRenderingContext2D.getImageData()</code></li></ul><blockquote><p>Uncaught SecurityError: Failed to execute 'toDataURL' on 'HTMLCanvasElement': Tainted canvases may not be exported.</p><p>Uncaught SecurityError: Failed to execute 'getImageData' on 'CanvasRenderingContext2D': The canvas has been tainted by cross-origin data. </p></blockquote></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="为什么会出现-tainted-canvas">为什么会出现 tainted canvas<a href="#为什么会出现-tainted-canvas" class="hash-link" aria-label="为什么会出现 tainted canvas的直接链接" title="为什么会出现 tainted canvas的直接链接">​</a></h2><p>tainted canvas 其实还是牵扯到浏览器同源策略的限制问题，一般来说这个问题在使用<code>XMLHttpRequest</code>或者<code>Fetch</code>发起网络请求的情况比较多见，而在这里的目的是禁止使用<code>canvas</code>随意从另一个网站加载图片再转换成数据的强盗行为。</p><p>这看起来合情合理，但是现在大型网站一般都会走 CDN 服务器来缓存并代理资源访问，这就导致在动态加载图像的时候实际可能走的是 CDN 服务器域名，这就导致网页域名和资源域名不同源了。本来防别人的，这下连自己人也堵在外面了。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="如何解决-tainted-canvas-问题">如何解决 tainted canvas 问题<a href="#如何解决-tainted-canvas-问题" class="hash-link" aria-label="如何解决 tainted canvas 问题的直接链接" title="如何解决 tainted canvas 问题的直接链接">​</a></h2><p>要解决 canvas 污染的问题，需要 CORS + crossOrign 两步配置：</p><ol><li>配置服务端响应头支持跨域请求的域名，请求方法等；</li><li>设置<code>crossorigin</code>属性</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="cors-header-配置">cors header 配置<a href="#cors-header-配置" class="hash-link" aria-label="cors header 配置的直接链接" title="cors header 配置的直接链接">​</a></h3><p>关于服务端 CORS 的配置就不细说了，具体的可以看我的这篇文章：</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_amsr"><div class="admonitionHeading_n8eI"><span class="admonitionIcon_HzUW"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_qhyd"><p>跨域直通车 —— <a href="https://icodex.me/docs/engineer/%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5" target="_blank" rel="noopener noreferrer">跨域与解决方案 | icodex</a></p></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="crossorigin">crossorigin<a href="#crossorigin" class="hash-link" aria-label="crossorigin的直接链接" title="crossorigin的直接链接">​</a></h3><p>HTML 规范给<code>crossorigin</code>制定了<a href="https://html.spec.whatwg.org/multipage/urls-and-fetching.html#cors-settings-attributes" target="_blank" rel="noopener noreferrer">三个允许值</a>：</p><ul><li><code>anonymous</code>或<code>""</code>（空字符串）：匿名请求访问资源，不会在跨域请求的时候携带任何身份凭据；</li><li><code>use-credentials</code>：在跨域请求的时候携带身份凭据，仅当服务端响应头返回<code>Access-Control-Allow-Credentials: true</code>的时候才允许使用跨域资源</li></ul><p><code>crossorigin</code>无论设置成哪一个值都会指定浏览器以跨域的模式请求资源，去发送相关<code>CORS</code>相关的请求头，并通过检查服务端是否返回<code>Access-Control-Allow-Orgin</code>等响应头来判断用户是否有权限完全访问响应内容。但是为了客户端安全考虑，一般设置成<code>anonymous</code>更为合适，避免向陌生的服务端发送网页的<code>cookie</code>等身份数据。</p><p>放在<code>canvas</code>绘制<code>image</code>的代码里可以这样修改：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> canvas </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable" style="color:rgb(189, 147, 249);font-style:italic">document</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">createElement</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"canvas"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> ctx </span><span class="token operator">=</span><span class="token plain"> canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">getContext</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"2d"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> img </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">Image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'xxxx'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">crossOrigin</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'anonymous'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(80, 250, 123)">onload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">width</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">width</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">height</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">height</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  canvas</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">drawImage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">img</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果是<code>img</code>标签可以增加<code>crossorigin</code>属性：</p><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">img</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">src</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">xxx</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">crossorigin</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">anonymous</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">/&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以下资源可能也需要<code>crossorigin</code>来取得数据访问权：</p><table><thead><tr><th>元素</th><th>限制</th></tr></thead><tbody><tr><td><code>img</code>, <code>audio</code>, <code>video</code></td><td>当它们被放在<code>canvas</code>元素内部使用时</td></tr><tr><td><code>script</code></td><td>使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/GlobalEventHandlers/onerror" target="_blank" rel="noopener noreferrer"><code>window.onerror</code></a></td></tr><tr><td><code>link</code></td><td>加载<code>webmanifest</code>时必须添加<code>crossorigin</code>属性</td></tr></tbody></table>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[饥荒云服务器搭建]]></title>
        <id>https://willes.github.io/dstcloudserver</id>
        <link href="https://willes.github.io/dstcloudserver"/>
        <updated>2022-06-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[​		玩饥荒的小伙伴都知道，饥荒这个游戏在创建多人房间的时候，会将房主的电脑作为本地服务器来中转数据，然后就经常遇到卡顿的问题。这篇文章尝试使用腾讯云轻量服务器来搭建饥荒的云服务器。]]></summary>
        <content type="html"><![CDATA[<p>​		玩饥荒的小伙伴都知道，饥荒这个游戏在创建多人房间的时候，会将房主的电脑作为本地服务器来中转数据，然后就经常遇到卡顿的问题。这篇文章尝试使用腾讯云轻量服务器来搭建饥荒的云服务器。</p><h1>配置</h1><p>镜像系统：</p><ul><li>CentOS7.6-Docker20</li></ul><p>实例规格</p><ul><li>CPU: 2核 内存: 4GB</li></ul><p>系统盘</p><ul><li>60GB SSD云硬盘管理快照</li></ul><p>流量包</p><ul><li>1000GB/月（带宽：6Mbps）</li></ul><h1>SSH 远程连接</h1><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是-ssh">什么是 SSH<a href="#什么是-ssh" class="hash-link" aria-label="什么是 SSH的直接链接" title="什么是 SSH的直接链接">​</a></h2><p>SSH 全程<code>Secure Shell</code>，是一种加密的网络传输协议，比较常用于远程登录系统，例如传输命令行界面或者执行服务端命令等。</p><p>SSH 采用非对称加密方式来保护数据传输，这种加密方式也是 web 应用协议 HTTPS 的加密手段。这种加密方式需要两个密钥：公钥和私钥。在实际运用的时候，假如有通信双方 A 和 B，A 先使用密钥算法计算产生一个公钥 Pkey 和私钥 Skey，并将其告知 B，后续 B 在发送数据的时候先使用公钥 Pkey 加密然后传输，经过公钥 Pkey 加密的数据，只能通过 A 保留的 Skey 来解密，以此来保证数据的安全性。</p><p>SSH 身份验证有多种途径，其中一种方法是使用自动生成的公钥-私钥对来简单地加密网络连接，随后<strong>使用密码认证</strong>进行登录；另一种方法是人工生成一对公钥和私钥，公钥需要放在待访问的电脑之中，然后就可<strong>通过生成的密钥</strong>进行认证，这样就可以在不输入密码的情况下登录。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="powershell-连接">powershell 连接<a href="#powershell-连接" class="hash-link" aria-label="powershell 连接的直接链接" title="powershell 连接的直接链接">​</a></h2><p>windows10 2018 年秋季更新（也就是 1809 版本）后内置 OpenSSH，可以直接通过 powershell 或者 cmd 执行 SSH 连接。</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">ssh</span><span class="token plain"> root@</span><span class="token operator">&lt;</span><span class="token plain">ip</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 然后提示输入密码</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">// 断开连接</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">logout</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以往的 powershell 等也可以通过 <a href="https://docs.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse" target="_blank" rel="noopener noreferrer">Get started with OpenSSH | Microsoft Docs</a> 这篇文档一步一步往下配置 openssh，然后通过<code>ssh</code>命令连接云服务器，不过需要注意两点：</p><ul><li>新购买的云服务器需要先通过重置密码操作来配置 SSH 远程登录密码；</li><li>powershell 需要以管理员身份运行。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="windows-terminal">windows terminal<a href="#windows-terminal" class="hash-link" aria-label="windows terminal的直接链接" title="windows terminal的直接链接">​</a></h2><p>windows terminal 本身支持 SSH 连接，通过生成密钥对，并添加新配置的方式来完成自动登录和认证的过程，以此来提高效率。</p><p>windows terminal 支持可视化配置，只需要注意命令行这里为：</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">ssh</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">username</span><span class="token operator">&gt;</span><span class="token plain">@</span><span class="token operator">&lt;</span><span class="token plain">ip</span><span class="token operator">&gt;</span><span class="token plain"> -p </span><span class="token number">22</span><span class="token plain"> -i ~/.ssh/id_rsa</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20220626185539285" src="/assets/images/image-20220626185539285-814e9fbced7f1d546922760fd84857ed.png" width="1113" height="626" class="img_MG2L"></p><h1>更新系统</h1><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yum -y update</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>安装远程桌面</h1><p>我个人对 linux 命令一窍不通，所以这里通过安装远程桌面的方式来安排！</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> epel-release </span><span class="token operator">&amp;&amp;</span><span class="token plain"> yum groupinstall Xfce</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> xrdp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">systemctl start xrdp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"xfce4-session"</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> ~/.Xclients</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">chmod</span><span class="token plain"> +x .Xclients</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后通过 windows 的远程桌面客户端就可以连接服务器了</p><p><img loading="lazy" alt="image-20220626190222604" src="/assets/images/image-20220626190222604-bbbff40343e9339c96a2345df2b5ce6a.png" width="475" height="321" class="img_MG2L"></p><h1>安装steamcmd</h1><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="安装运行环境">安装运行环境<a href="#安装运行环境" class="hash-link" aria-label="安装运行环境的直接链接" title="安装运行环境的直接链接">​</a></h2><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">yum -y </span><span class="token function" style="color:rgb(80, 250, 123)">install</span><span class="token plain"> glibc.i686 libstdc++.i686 </span><span class="token function" style="color:rgb(80, 250, 123)">screen</span><span class="token plain"> libcurl.i686</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="安装-steamcmd">安装 steamcmd<a href="#安装-steamcmd" class="hash-link" aria-label="安装 steamcmd的直接链接" title="安装 steamcmd的直接链接">​</a></h2><p>先创建<code>steam/steamcmd</code>目录，然后在该目录下执行安装<code>steamcmd</code>的命令并解压</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -sqL </span><span class="token string" style="color:rgb(255, 121, 198)">"https://steamcdn-a.akamaihd.net/client/installer/steamcmd_osx.tar.gz"</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> zxvf -</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>安装饥荒服务器程序</h1><p>安装完<code>steamcmd</code>后，就可以使用<code>steamcmd</code>安装饥荒服务器程序<code>Don’t Starve Together Dedicated Server</code></p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 运行 steamcmd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./steamcmd.sh</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 匿名身份登录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">login anonymous</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 安装 Don’t Starve Together Dedicated Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">app_update </span><span class="token number">343050</span><span class="token plain"> validate +quit</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装完<code>Don’t Starve Together Dedicated Server</code>以后，就可以在<code>steam/steamapps/common</code>下找到该程序，为了方便以后命令操作，将该文件夹名称修改为<code>dst</code></p><p><img loading="lazy" alt="image-20220626193538075" src="/assets/images/image-20220626193538075-5e0decea671f53a86da64a870b72e63b.png" width="694" height="336" class="img_MG2L"></p><h1>初次运行 server</h1><p>还是刚才的<code>dst</code>目录下，找到<code>bin</code>目录，里面有个<code>dontstarve_dedicated_server_nullrenderer</code>程序，使用命令行运行它</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> steam/steamcmd/common/dst/bin</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./dontstarve_dedicated_server_nullrenderer</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可能会报<code>error while loading shared libraries: libcurl-gnutls.so.4: cannot open shared object file</code>的错误，运行以下命令解决，注意将末尾的目录替换成你安装的 server 的路径。</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">ln</span><span class="token plain"> -s /usr/lib/libcurl.so.4 ~/steam/steamcmd/common/dst/bin/lib32/libcurl-gnutls.so.4</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后看到<code>your server will not start</code>就表示可以成功执行。</p><h1>配置饥荒世界</h1><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="生成地图配置">生成地图配置<a href="#生成地图配置" class="hash-link" aria-label="生成地图配置的直接链接" title="生成地图配置的直接链接">​</a></h2><p>配置饥荒服务器这里最简单的方式是借助饥荒客户端来解决，也就是首先我们在本地运行饥荒服务器创建一个多人房间，把森林、洞穴以及<code>mod</code>什么的都配置好，并选择<strong>本地存档</strong>，然后生成世界。</p><p><img loading="lazy" alt="image-20220626194448633" src="/assets/images/image-20220626194448633-26463d240c5bc40415093a376d9b9dec.png" width="1622" height="969" class="img_MG2L"></p><p>然后我们到电脑的本地存档目录，一般在电脑文档目录下，例如我这里在<code>Documents\Klei\DoNotStarveTogether\347061565</code>下，然后就可以看到多个生成的存档的目录，找到最近时间创建的就是刚才生成的世界。</p><p><img loading="lazy" alt="image-20220626194610527" src="/assets/images/image-20220626194610527-a82a0c4b8127e0c1d049ea21db7ed6a5.png" width="798" height="403" class="img_MG2L"></p><p>世界存档包含以下文件和目录：</p><p><img loading="lazy" alt="image-20220626195633501" src="/assets/images/image-20220626195633501-3491d27dffcd0e42a93eae8178549dbe.png" width="653" height="196" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="生成并替换-token">生成并替换 token<a href="#生成并替换-token" class="hash-link" aria-label="生成并替换 token的直接链接" title="生成并替换 token的直接链接">​</a></h2><p>然后登录到<code>Klei</code>官网 —— <a href="https://accounts.klei.com/account/info" target="_blank" rel="noopener noreferrer">Login</a>（支持 steam 登录），然后找到饥荒游戏服务器并进入。</p><p><img loading="lazy" alt="image-20220626195057555" src="/assets/images/image-20220626195057555-86e9e6ceb148023c879112e28cca1466.png" width="1531" height="601" class="img_MG2L"></p><p>然后输入名称选择添加新服务器</p><p><img loading="lazy" alt="image-20220626195138924" src="/assets/images/image-20220626195138924-6a52a605ed584f264c8155af0cf59329.png" width="1085" height="244" class="img_MG2L"></p><p>然后新添加的服务器会显示在当前页面上方列表里，找到它并把下方的一串<code>token</code>复制下来</p><p><img loading="lazy" alt="image-20220626195421056" src="/assets/images/image-20220626195421056-cf495e9a96039bf3a5dea1b21eb23936.png" width="1119" height="218" class="img_MG2L"></p><p>然后回到刚才本地电脑创建的世界的存档目录，打开<code>cluster_token.txt</code>文件，将复制的服务器<code>token</code>替换进去即可。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="配置-mod">配置 mod<a href="#配置-mod" class="hash-link" aria-label="配置 mod的直接链接" title="配置 mod的直接链接">​</a></h2><p>打开刚才饥荒世界的<code>Master</code>或者<code>Caves</code>目录，找到<code>modoverrides.lua</code>文件，使用文件编辑器打开，可以看到创建世界时配置启用的所有<code>mod</code>的 id。</p><p><img loading="lazy" alt="image-20220626200138014" src="/assets/images/image-20220626200138014-ce50dbf4e49707f5242ad5813a4fb883.png" width="1027" height="670" class="img_MG2L"></p><p>回到服务器上饥荒服务器的<code>dst/mods</code>目录，找到<code>dedicated_server_mods_setup.lua</code>文件，该文件是服务器创建世界时安装<code>mod</code>的配置文件。</p><p>将<code>modoverrides.lua</code>内部的<code>mod</code>的<code>id</code>复制下来，并用<code>ServerModSetup("xxxx")</code>包裹，写入<code>dedicated_server_mods_setup.lua</code>文件，这就完成<code>mod</code>安装配置了。</p><h1>上传饥荒世界配置文件</h1><p>配置完饥荒世界和<code>mod</code>以后，我们把刚才本地电脑文件目录下的存档目录直接上传到服务器的<code>.klei/DoNotStarveTogether</code>目录下，这里我使用了 ftp 客户端<code>FileZilla</code>来上传文件，很方便很快！</p><h1>运行地上和洞穴服务</h1><p>上传完饥荒世界的配置文件以后，就可以再次使用<code>dontstarve_dedicated_server_nullrenderer</code>运行地上和洞穴服务了。</p><p>这里需要开两个<code>shell</code>窗口来运行两个命令。</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 启动地上世界</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Caves</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 启动洞穴</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Master</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[如何给类库打包]]></title>
        <id>https://willes.github.io/packlib</id>
        <link href="https://willes.github.io/packlib"/>
        <updated>2022-03-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[背景]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>在业务场景开发过程中，经常会需要我们手动编写一些方法来解决一些业务场景问题，例如防抖、节流、正则表达式表单校验方法等。一般我们会把这些方法统一放在项目的某个目录，例如<code>utils</code>下维护。</p><p>但是当涉及到跨团队使用的时候，这些方法通过<code>npm</code>包的形式来维护会减少团队开发成本。这篇文章主要探索使用<code>rollup</code>和<code>api-extractor</code>打包基于 TypeScript 开发的类库的使用过程。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="rollup-是干嘛的">rollup 是干嘛的<a href="#rollup-是干嘛的" class="hash-link" aria-label="rollup 是干嘛的的直接链接" title="rollup 是干嘛的的直接链接">​</a></h2><p><code>rollup</code>(汇总)是一个支持 ES Modules 模块语法的 JS 应用打包工具，可以将 ES 模块语法编译成 CommonJS，AMD，IIFE 等形式的代码。同时，<code>rollup</code>支持<code>Tree-Shaking</code>。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="tree-shaking">Tree-Shaking<a href="#tree-shaking" class="hash-link" aria-label="Tree-Shaking的直接链接" title="Tree-Shaking的直接链接">​</a></h3><p><code>rollup</code>提出<code>Tree-Shaking</code>这个词，用来删减无用的代码段。原理上简单来说从编译代码得到的<code>AST</code>（Abstract Syntax Tree），首先标记相关联的代码，然后移除没被标记的代码，类似于<code>标记-清除</code>的内存回收机制。</p><p>通过 ES Modules 模块语法支持静态分析的特性，可以让<code>Tree-Shaking</code>更好地发挥作用，但是许多第三方包并不是以  ES Modules 形式对外界暴露 API，例如<code>lodash</code>，要想在代码层面上配合<code>Tree-Shaking</code>，可以通过引入子模块来解决问题。例如使用<code>import map from 'lodash-es/map'</code>而不是<code>import { map } from 'lodash-es'</code>。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="不支持第三方包">不支持第三方包<a href="#不支持第三方包" class="hash-link" aria-label="不支持第三方包的直接链接" title="不支持第三方包的直接链接">​</a></h3><p><code>rollup</code>本身不支持处理从<code>node_modules</code>引入的第三方模块，需要通过额外的<code>plugin</code> —— <code>@rollup/plugin-node-resolve</code>来处理。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// rollup.config.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports">resolve</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'@rollup/plugin-node-resolve'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">input</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'src/main.js'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">file</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'bundle.js'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">format</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'cjs'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="配置项">配置项<a href="#配置项" class="hash-link" aria-label="配置项的直接链接" title="配置项的直接链接">​</a></h3><p><code>rollup</code>支持 CLI 命令<code>rollup</code>，默认查找项目根目录下的<code>rollup.config.js</code>配置文件，默认配置文件使用 CJS 模块语法，但是也支持以<code>.cjs</code>和<code>.mjs</code>两种后缀来区分在配置文件中使用的模块语法。</p><div class="language-typescript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-typescript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// rollup.config.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">interface</span><span class="token plain"> </span><span class="token class-name">Configuration</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 打包入口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  input</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">entryAlias</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 插件数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  plugins</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">Plugin </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 忽略打包的模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  external</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> RegExp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> RegExp</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        importer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        isResolved</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 缓存之前的构建产物，在 watch 模式下提高后续构建速度，开启的时候 rollup 会只分析改变的模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 可以指定缓存 plugin 和 module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  cache</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> RollupCache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 警示信息自定义处理函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  onwarn</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  preserveEntrySignatures</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'strict'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'allow-extension'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'exports-only'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否对使用了 rollup 过时的特性直接报错</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  strictDeprecations</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// acorn 编译器的配置项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  acorn</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> AcornOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// acorn 使用的插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  acornInjectPlugins</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">unknown</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">unknown</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 全局上下文对象，例如 window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  context</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 单独配置每个模块的上下文对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  moduleContext</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  preserveSymlinks</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否对使用未定义的模块提示报错</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  shimMissingExports</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 自定义 tree-shaking 的过程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  treeshake</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> TreeshakingPreset </span><span class="token operator">|</span><span class="token plain"> TreeshakingOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 确定在运行了多少次之后，插件不再使用的缓存资源应该被删除，默认 10 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  experimentalCacheExpiry</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否计算构建性能，例如构建时间等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  perf</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 构建输出配置，可以是一个数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  output</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 输出文件目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dir</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 输出文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    file</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指定输出产物的模块语法，默认 es，也就是 ES Modules 语法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    format</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'amd'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'cjs'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'es'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'iife'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'system'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'umd'</span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'commonjs'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'esm'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'module'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'systemjs'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 将外部模块 ID 转换为全局变量名，例如 jquery =&gt; $, 在所有模块内部不需要引用 jquery 就可以直接使用 $</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    globals</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 打包产物对外暴露的全局变量名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    name</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 只作用于当前输出的插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    plugins</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">OutputPlugin </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">undefined</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 其他静态资源的输出文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    assetFileNames</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chunkInfo</span><span class="token operator">:</span><span class="token plain"> PreRenderedAsset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 放置在打包产物顶部的字符串内容，例如作者信息，版本声明等，和下面的 footer 一样</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    banner</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Promise</span><span class="token operator">&lt;</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    footer</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Promise</span><span class="token operator">&lt;</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指定 code-splitting 拆分出来的 chunk 的文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    chunkFileNames</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chunkInfo</span><span class="token operator">:</span><span class="token plain"> PreRenderedChunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 减少 rollup 生成的包装器的代码，可以用于优化生成产物体积，默认 false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    compact</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指定从 entry 指定的 chunk 的文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    entryFileNames</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chunkInfo</span><span class="token operator">:</span><span class="token plain"> PreRenderedChunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否拓展 name 指定的全局变量的名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    extend</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当拆分多个 chunk 的时候，rollup 会把后续关联的模块添加到入口模块 import 进来，这样JS 引擎在从</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 入口开始加载 chunk 的时候就会提前发现其他关联的模块并加载它们，从而提升多个 chunk 的加载速度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hoistTransitiveImports</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当指定一个入口模块的时候，将其内部使用动态导入 import() 的模块直接打包进来而不是创建单独的 chunk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    inlineDynamicImports</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    interop</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'auto'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'esModule'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'defaultOnly'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 放置在打包产物内部的介绍信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    intro</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Promise</span><span class="token operator">&lt;</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    outro</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">Promise</span><span class="token operator">&lt;</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token operator">&gt;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// code-splitting 的方式，可以将第三方包拆分出来成单独的 chunk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    manualChunks</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">chunkAlias</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> GetManualChunk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 对于 es 模块或者 compact 设置为 true，会将模块名混淆成单个字母来表示，更好的压缩代码体积</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    minifyInternalExports</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 配置 external 指定的模块名和模块路径的映射关系，可以是 CDN URL 地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    paths</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> Record</span><span class="token operator">&lt;</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 将每个模块都拆分成单独的 chunk 打包输出，可用于将文件结构转换为不同的模块格式来输出不同打包产物</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    preserveModules</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 保证指定目录的模块从入口进入可以输出到 output 指定的输出文件夹，从而和 preserveModules 隔离开</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    preserveModulesRoot</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 输出 sourcemap 的形式，默认 false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sourcemap</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'inline'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'hidden'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指定源代码的实际代码是否被添加到 sourcemap 中，可减小 sourcemap 的体积</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sourcemapExcludeSources</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sourcemapFile</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sourcemapPathTransform</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 校验生成的 JS 代码是否有效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    validate</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 以下属于模块语法相关的配置项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    amd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    esModule</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 决定模块导出的语法形式，默认情况下 rollup 会根据入口模块来决定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    exports</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'default'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'named'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'none'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'auto'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否不允许修改导出的模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    externalLiveBindings</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否使用 Object.freeze 冻结 import as 形式导出的模块</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    freeze</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否使用缩进字符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    indent</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    namespaceToStringTag</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 为 UMD 模块添加额外的不会导致冲突的导出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    noConflict</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 使用 const 定义导出的模块而不是 var</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    preferConst</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 移除 chunk 名称中的 \0, ? and * 字符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sanitizeFileName</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否在非 ES Modules 模块顶部添加 use strict，默认添加</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    strict</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当打包模块输出为 SystemJS 的时候，是否用 null 替换空的 setter 方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    systemNullSetters</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 热更新监听配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  watch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 配置 Rollup 在触发重新构建之前等待进一步更改的时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    buildDelay</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">number</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    chokidar</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> ChokidarOptions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否在重新构建的时候清空控制台</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clearScreen</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 排除监听的文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    exclude</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> RegExp </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> RegExp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> RegExp </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token builtin" style="color:rgb(189, 147, 249)">string</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> RegExp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 触发热更新的时候是否跳过 bundle.write() </span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    skipWrite</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(189, 147, 249)">boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="常用plugin">常用plugin<a href="#常用plugin" class="hash-link" aria-label="常用plugin的直接链接" title="常用plugin的直接链接">​</a></h3><p><code>rollup</code>目前支持的<code>plugin</code>都在这个列表里 —— <a href="https://github.com/rollup/awesome" target="_blank" rel="noopener noreferrer">rollup/awesome: ⚡️ Delightful Rollup Plugins</a>。常用的有以下这些：</p><ul><li><code>@rollup/plugin-node-resolve</code>：解析<code>node_modules</code>中第三方模块</li><li><code>@rollup/plugin-typescript</code>：解析 TypeScript 模块，注意配置<code>tsconfig</code>路径</li><li><code>@rollup/plugin-alias</code>：<code>alias</code>模块名</li><li><code>rollup-plugin-visualizer</code>：<code>rollup</code>打包产物可视化图分析依赖项</li><li><code>rollup-plugin-progress</code>：构建进度条</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="api-extractor-是什么">api-extractor 是什么<a href="#api-extractor-是什么" class="hash-link" aria-label="api-extractor 是什么的直接链接" title="api-extractor 是什么的直接链接">​</a></h2><p><code>api-extractor</code>是辅助打包 TypeScript 类型系统的工具，属于 TypeScript 语言领域的<code>rollup</code>。一般来说，我们使用<code>rollup</code>只为打包生成<code>.js</code>文件，借助<code>@rollup/plugin-typescript</code>这样的插件也可以生成<code>.d.ts</code>后缀的类型定义文件，但是类型定义往往分散在项目不同的文件下，导致构建产物有很多<code>.d.ts</code>文件，看起来很乱，那么别人用的时候往往还需要从<code>node_modules</code>下引用不同的<code>.d.ts</code>模块，这就很不方便了。</p><p><code>api-extractor</code>主要就是解决上面这个问题的，它可以将所有类型定义从一个入口获取到，最后汇总到一个<code>.d.ts</code>文件内部。此外，还有以下功能：</p><ul><li><p>将所有 TS 类型定义导出到一个<code>.d.ts</code>文件，这一项功能最有用；</p></li><li><p>从项目入口遍历所有<code>export</code>的类型，并生成一个 markdown 报告，一般没用；</p></li><li><p>根据类型生成包含类型签名和注释的 JSON 文件，然后内置的<code>api-documenter</code>可以根据这些 JSON 文件生成 API 文档，一般没用；</p></li></ul><p><img loading="lazy" alt="image-20220326210450101" src="/assets/images/image-20220326210450101-e797435e9a94b578deb8dc890cce2436.png" width="633" height="511" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="使用">使用<a href="#使用" class="hash-link" aria-label="使用的直接链接" title="使用的直接链接">​</a></h3><p><code>api-extractor</code>使用比较简单：</p><ol><li>首先全局安装<code>@microsoft/api-extractor</code></li></ol><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">pnpm</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> @microsoft/api-extractor -g</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>然后在项目根目录执行<code>api-extractor init</code>会生成一个<code>api-extractor</code>的 JSON 配置文件<code>api-extractor.json</code></li><li>配置<code>api-extractor.json</code>，关键需要为其指定两个路径：类型入口文件路径<code>mainEntryPointFilePath</code>和汇总输出的文件路径<code>untrimmedFilePath</code></li></ol><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 类型入口文件路径，必须为 .d.ts 后缀</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"mainEntryPointFilePath"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;projectFolder&gt;/lib/index.d.ts"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"compiler"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"tsconfigFilePath"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;projectFolder&gt;/tsconfig.json"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">，</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"apiReport"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否生成 API 报告，一般用不到，关掉</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"docModel"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否生成 doc model 文档，一般用不到，关掉</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"dtsRollup"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 汇总 *.d.ts 文件后输出的目录，有用而且是关键配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"untrimmedFilePath"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"&lt;projectFolder&gt;/lib/index.d.ts"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li><p>接着我们需要保证项目生成了<code>api-extractor</code>需要的类型入口文件，因此可以先执行<code>tsc</code>得到构建输出的<code>*.d.ts</code>文件；</p></li><li><p>最后执行<code>api-extractor run</code>即可，会在<code>dtsRollup.untrimmedFilePath</code>配置的路径下重新生成<code>.d.ts</code>文件，内部汇总项目所有的类型定义。</p></li></ol><p><img loading="lazy" alt="image-20220327234721974" src="/assets/images/image-20220327234721974-8ed46b1ca54f33d7034c7d35e56f499c.png" width="1371" height="304" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="vite-是怎么用-api-extractor-的">vite 是怎么用 api-extractor 的<a href="#vite-是怎么用-api-extractor-的" class="hash-link" aria-label="vite 是怎么用 api-extractor 的的直接链接" title="vite 是怎么用 api-extractor 的的直接链接">​</a></h3><p>从<code>api-extractor</code>官网的介绍里，我根本看不出<code>api-extractor</code>的使用收益在哪，这里只能先学习<code>vite</code>是怎么用的了。</p><p>从<code>vite</code>配置的<code>api-extractor.json</code>来看，其指定的类型文件入口为<code>./temp/node/index.d.ts</code>，汇总生成的<code>.d.ts</code>文件位于<code>./dist/node/index.d.ts</code>。</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"$schema"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://developer.microsoft.com/json-schemas/api-extractor/v7/api-extractor.schema.json"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 项目目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"projectFolder"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"./src/node"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 类型定义入口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"mainEntryPointFilePath"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"./temp/node/index.d.ts"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"dtsRollup"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"untrimmedFilePath"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 整理汇总后的 .d.ts 输出目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"publicTrimmedFilePath"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"./dist/node/index.d.ts"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"apiReport"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"docModel"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"tsdocMetadata"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"enabled"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是在实际项目中并未发现该文件，猜测是经过<code>tsc</code>编译生成的目录，于是查找<code>package.json</code>下<code>scripts</code>的配置，果然找到和<code>tsc</code>相关的命令。</p><p>这里一共四个相关的命令：</p><ul><li><code>build-temp-types</code>：使用<code>tsc</code>编译 TypeScript，但是指定了<code>emitDeclarationOnly</code>，只生成<code>.d.ts</code>文件到<code>temp/node</code>目录</li><li><code>patch-types</code>：使用<code>ts-node</code>运行<code>scripts</code>目录下的<code>patchTypes.ts</code>程序</li><li><code>roll-types</code>：运行<code>api-extractor</code>程序，完事后移除<code>temp</code>文件夹</li><li><code>build-type</code>：使用<a href="https://github.com/mysticatea/npm-run-all" target="_blank" rel="noopener noreferrer">npm-run-all</a>的<code>run-s</code>按顺序执行命令</li></ul><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"scripts"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"build-types"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"run-s build-temp-types patch-types roll-types"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"build-temp-types"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"tsc --emitDeclarationOnly --outDir temp/node -p src/node"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"patch-types"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"ts-node scripts/patchTypes.ts"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"roll-types"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"api-extractor run &amp;&amp; rimraf temp"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面我进入<code>packages/vite</code>分别执行以上命令看看效果。</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> packages/vite</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">pnpm</span><span class="token plain"> run build-temp-types</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行<code>build-temp-types</code>得到所有文件的<code>.d.ts</code>文件</p><p><img loading="lazy" alt="image-20220328204143101" src="/assets/images/image-20220328204143101-670ae2f2a22b3d801efb62f4f06d708a.png" width="625" height="396" class="img_MG2L"></p><p>然后继续执行<code>patch-types</code>，<code>patch-types</code>这个程序会把<code>src/node</code>目录下代码中从<code>types/*</code>引入的类型转换成相对路径，这样<code>api-extractor</code>才能查找得到。</p><p>例如<code>import type { Alias } from "types/alias"</code>转换后得到<code>import type { Alias } from "../../../types/alias"</code>。</p><p>最后执行<code>api-extractor run</code>来汇总所有的类型定义，并输出到<code>./dist/node/index.d.ts</code>目录下，这个目录同时也是<code>rollup</code>打包输出的 JS 文件目录。</p><p>其中关键的地方就在于<code>api-extractor</code>的入口文件，在<code>vite</code>内部的<code>src/node/index.ts</code>只用作类型定义入口，内部负责从其他目录<code>export</code>类型或者方法等成员。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token exports"> resolvePackageEntry </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'./plugins/resolve'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token exports"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token exports">  splitVendorChunkPlugin</span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token exports"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token exports">  splitVendorChunk</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token exports"></span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'./plugins/splitVendorChunk'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token exports"> resolvePackageData </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'./packages'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token exports"> normalizePath </span><span class="token exports punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'./utils'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="最佳实践">最佳实践<a href="#最佳实践" class="hash-link" aria-label="最佳实践的直接链接" title="最佳实践的直接链接">​</a></h2><p>介绍完以上两种工具的使用，下面开搞，项目结构如下：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token operator">-</span><span class="token plain">scripts</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">-</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">js</span><span class="token plain">     </span><span class="token comment" style="color:rgb(98, 114, 164)">// rollup 打包程序</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">-</span><span class="token plain">src                </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">-</span><span class="token plain">debounce</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">-</span><span class="token plain">throttle</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">-</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">ts</span><span class="token plain">           </span><span class="token comment" style="color:rgb(98, 114, 164)">// 导出其他方法</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>安装<code>rollup</code>到项目依赖后，使用<code>rollup</code>的 JavaScript API 来编写打包程序，放在<code>scripts/build.js</code>下，目的是从项目的多个入口进行打包，从而得到多个分离的<code>.js</code>文件。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> bundle </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">rollup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  input</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">pluginTS</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指定生成 *.d.ts 类型文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">tsconfig</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">cwd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'tsconfig.json'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// 这里我们指定 rollup 打包不需要生成 .d.ts 文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">declaration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">nodeResolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    analyze </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">visualizer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">filename</span><span class="token operator">:</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">process</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">cwd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'analyze/stats.html'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">open</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">gzipSize</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token known-class-name class-name">Boolean</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后使用<code>tsc --emitDeclarationOnly --declaration --outDir dts</code>生成<code>.d.ts</code>文件，<code>index.d.ts</code>如下：</p><div class="language-typescript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-typescript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> debounce </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'./debounce'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">export</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">default</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">as</span><span class="token plain"> throttle </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'./throttle'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后执行<code>api-extractor run</code>输出汇总的<code>.d.ts</code>文件，命令配置如下：</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"scripts"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"build"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"run-s bundle build-types rollup-types"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"bundle"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"node scripts/build.js"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"build-types"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"tsc --emitDeclarationOnly --declaration --outDir dts"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"rollup-types"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"api-extractor run &amp;&amp; rimraf dts"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="qa">QA<a href="#qa" class="hash-link" aria-label="QA的直接链接" title="QA的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="ae-missing-release-tag">ae-missing-release-tag<a href="#ae-missing-release-tag" class="hash-link" aria-label="ae-missing-release-tag的直接链接" title="ae-missing-release-tag的直接链接">​</a></h3><p>使用<code>api-extractor</code>的时候，可能会报下面的错误</p><blockquote><p><code>*“___ is exported by the package, but it is missing a release tag (@alpha, @beta, @public, or @internal).”*</code></p></blockquote><p><img loading="lazy" alt="image-20220328220425540" src="/assets/images/image-20220328220425540-c1137e209aa37c4a601babf842cbcfe2.png" width="1371" height="205" class="img_MG2L"></p><p>主要原因是<code>api-extractor</code>使用的注释比较严格，可以通过<code>@public</code>， <code>@alpha</code>(内部测试) 或<code>@beta</code>(公开测试)这些注释来区分一个成员的版本。</p><p>两种方法解决上述问题：</p><ul><li>方法注释上添加<code>@public</code>；</li><li>在<code>api-extractor.json</code>中配置关掉提示</li></ul><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token property">"messages"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"extractorMessageReporting"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"ae-missing-release-tag"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"logLevel"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"none"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[实现 Promise.all 有哪些要点]]></title>
        <id>https://willes.github.io/promiseall</id>
        <link href="https://willes.github.io/promiseall"/>
        <updated>2022-03-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Promise.all]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="promiseall">Promise.all<a href="#promiseall" class="hash-link" aria-label="Promise.all的直接链接" title="Promise.all的直接链接">​</a></h2><p><code>Promise.all</code>是日常使用频率非常高的异步方法，这两天回顾了一下<code>Promise</code>的几个静态方法，对<code>Promise.all</code>又有了一些新的认识。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="promiseall-的定义">Promise.all 的定义<a href="#promiseall-的定义" class="hash-link" aria-label="Promise.all 的定义的直接链接" title="Promise.all 的定义的直接链接">​</a></h2><blockquote><p><code>Promise.all(iterable)</code></p></blockquote><p>理解<code>Promise.all</code>API 需要注意以下几点：</p><ol><li>接收一个<strong>可迭代</strong>对象作为参数，否则<code>throw TypeError</code>的错误；</li><li>当迭代器内部所有<code>Promise</code>对象<code>fulfilled</code>的时候，<code>Promise.all</code>返回<code>fulfilled</code>状态的<code>Promise</code>对象，<code>resolve</code>参数为一个数组，包含所有非<code>Promise</code>对象以及所有<code>Promise</code>对象<code>resolve</code>的值；</li><li>当迭代器内部存在一个<code>Promise</code>对象状态变为<code>rejected</code>或者非<code>Promise</code>元素执行出错时，<code>Promise.all</code>将立即返回<code>rejected</code>状态的<code>Promise</code>对象，<code>reject</code>参数为<code>rejected</code>的<code>Promise</code>对象抛出的信息，或者非<code>Promise</code>元素执行报错的信息；</li><li><code>Promise.all</code>变成<code>fulfilled</code>状态时，<code>resolve</code>的数组元素按照迭代器元素的顺序，非<code>Promise</code>对象会直接放在对应位置返回。</li></ol><p>从<code>Promise.all</code> API 定义来看，首先需要理解什么是可迭代对象。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是可迭代">什么是可迭代<a href="#什么是可迭代" class="hash-link" aria-label="什么是可迭代的直接链接" title="什么是可迭代的直接链接">​</a></h3><p>可迭代是 ES6 提出的语法协议，是指满足以下两个要求的对象：</p><ol><li><p><code>iterable</code>：可迭代。可迭代指的是一个对象内部需要实现<code>Symbol.iterator</code>方法，该方法不接收参数，同时返回一个对象，这个对象必须是<strong>迭代器</strong>。当使用<code>for...of</code>遍历的时候，会调用<code>Symbol.iterator</code>方法。</p></li><li><p><code>iterator</code>：迭代器。<strong>迭代器是一个对象</strong>，包含一个<code>next</code>方法，该方法可接收一个参数，同时返回一个包含以下两个属性的对象。</p></li></ol><ul><li><code>done: boolean</code>：表示当前迭代器是否迭代完毕，结束迭代则设为<code>true</code>，此时<code>value</code>可以省略，因为没东西要输出了嘛。</li><li><code>value:any</code>：迭代器每次调用返回的值</li></ul><p>基于<code>class</code>实现的可迭代对象示例如下：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">SimpleClass</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">constructor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 首先实现 Symbol.iterator 方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">iterator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 返回一个迭代器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// 迭代器内部必须包含 next 方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">index </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">index</span><span class="token operator">++</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token literal-property property">done</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">done</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>目前内置的可迭代对象有以下这些：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token known-class-name class-name">Array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token known-class-name class-name">String</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token known-class-name class-name">Map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token known-class-name class-name">Set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">TypedArray</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这些类型的值都可以使用<code>for...of</code>遍历。</p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_amsr"><div class="admonitionHeading_n8eI"><span class="admonitionIcon_HzUW"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>警告</div><div class="admonitionContent_qhyd"><p>有个需要注意的点是，无法准确判断一个对象是否可迭代，因为要同时满足上述说的两个条件有个 hack 的方法。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> myIterator </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">iterator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>但是对于日常来说，谁会写这么 hack 的代码呢？所以要判断一个对象是否可迭代仍然可以使用：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> sth</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">iterator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="promiseall-的实现">Promise.all 的实现<a href="#promiseall-的实现" class="hash-link" aria-label="Promise.all 的实现的直接链接" title="Promise.all 的实现的直接链接">​</a></h2><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(80, 250, 123)">_all</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">iterable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 判断迭代器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> iterable</span><span class="token operator">?.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">iterator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"function"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"parameter must be iterable"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> count </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token spread operator">...</span><span class="token plain">iterable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 如果是空的迭代器，则直接 resolve 空数组</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> resultArr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> it </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">of</span><span class="token plain"> iterable</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">it</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            count</span><span class="token operator">--</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            resultArr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">count </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resultArr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">err</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> promise1 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> promise2 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">42</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> promise3 </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">Promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'foo'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">_all</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">promise1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> promise2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> promise3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">values</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">values</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">// [ 3, 42, 'foo' ]</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[PureEsm]]></title>
        <id>https://willes.github.io/pureesm</id>
        <link href="https://willes.github.io/pureesm"/>
        <updated>2022-02-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image-20220303224642507]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image-20220303224642507" src="/assets/images/image-20220303224642507-6cd7dc9b4afb568a8210b48c9746f937.png" width="704" height="326" class="img_MG2L"></p><p>Node 从<code>v12.17(LTS)</code>版本开始正式支持 ESM 模块语法，但是 node 本身又支持 CJS 语法，直接迁移的话还是有些成本的。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="模块判定标准">模块判定标准<a href="#模块判定标准" class="hash-link" aria-label="模块判定标准的直接链接" title="模块判定标准的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="esm-模块">ESM 模块<a href="#esm-模块" class="hash-link" aria-label="ESM 模块的直接链接" title="ESM 模块的直接链接">​</a></h3><p>使用的时候 Node 根据以下条件判断传入<code>import</code>或者<code>import()</code>的模块为 ESM：</p><ul><li><code>.mjs</code>模块名后缀</li><li>离模块最近的 <code>package.json</code>内定义的<code>type="module"</code>字段</li><li>在 CLI 内部执行一行代码时传递给<code>node</code>参数<code>--input-type=module</code></li></ul><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">node</span><span class="token plain"> --input-type</span><span class="token operator">=</span><span class="token plain">module --eval </span><span class="token string" style="color:rgb(255, 121, 198)">"import { sep } from 'path'; console.log(sep);"</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="cjs模块">CJS模块<a href="#cjs模块" class="hash-link" aria-label="CJS模块的直接链接" title="CJS模块的直接链接">​</a></h3><p>但是 Node 同时又需要支持 CommonJS 语法，对于使用<code>import</code>或者<code>import()</code>传入的模块根据以下条件判定其为 CJS 模块：</p><ul><li><code>.cjs</code>模块名后缀</li><li>离模块最近的 <code>package.json</code>内定义的<code>type="commonjs"</code>字段</li><li>在 CLI 内部执行一行代码时传递给<code>node</code>参数<code>--input-type=commonjs</code></li></ul><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">node</span><span class="token plain"> --input-type</span><span class="token operator">=</span><span class="token plain">commonjs --eval </span><span class="token string" style="color:rgb(255, 121, 198)">"import { sep } from 'path'; console.log(sep);"</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是-pure-esm">什么是 Pure ESM<a href="#什么是-pure-esm" class="hash-link" aria-label="什么是 Pure ESM的直接链接" title="什么是 Pure ESM的直接链接">​</a></h2><p>Pure ESM 是 <a href="https://gist.github.com/sindresorhus" target="_blank" rel="noopener noreferrer">sindresorhus</a> 提出来的一个概念 —— <a href="https://gist.github.com/sindresorhus/a39789f98801d908bbc7ff3ecc99d99c" target="_blank" rel="noopener noreferrer">Pure ESM package (github.com)</a>，指的是一个使用 Node 开发的模块只能使用 ESM 模块语法导入。</p><p>作者建议 Node  开发应该迁移到 ESM，原因就是上文说的<code>import</code>语法既支持 ESM 也支持 CJS，但是 CJS 的语法<code>require</code>只支持 CJS 模块。</p><p>作者还介绍了 CommonJS 迁移到 ESM 的情况：</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="从-commonjs-迁移到-esm">从 CommonJS 迁移到 ESM<a href="#从-commonjs-迁移到-esm" class="hash-link" aria-label="从 CommonJS 迁移到 ESM的直接链接" title="从 CommonJS 迁移到 ESM的直接链接">​</a></h3><ul><li>在<code>package.json</code>添加<code>"type": "module"</code></li><li>使用<code>exports</code>替换<code>package.json</code>的<code>main</code>字段来指定入口文件，因为<code>main</code>只适用于 CJS 语法</li><li>在<code>package.json</code>指定 Node 版本必须大于<code>12.20</code></li></ul><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token property">"engines"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"node"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"^12.20.0 || ^14.13.1 || &gt;=16.0.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>如果是 TypeScript 项目，还需要在<code>tsconfig.json</code>指定<code>module: "es2020"</code></li><li>最后一步，改造 CJS 语法<code>require()</code>/<code>module.export</code>到 ESM 语法<code>import</code>/<code>export</code>，对于异步模块需要使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#dynamic_import" target="_blank" rel="noopener noreferrer"><code>import()</code></a>或者<code>top level await</code>。</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="升级报错的问题">升级报错的问题<a href="#升级报错的问题" class="hash-link" aria-label="升级报错的问题的直接链接" title="升级报错的问题的直接链接">​</a></h3><p>如果一个 node 开发的 package 是使用的 ESM 模块语法导出，那么只能在 ESM 模块中使用，否则就会报错<code>ERR_REQUIRE_ESM</code>，例如使用<code>chalk5.0+</code></p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// index.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> chalk </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'chalk'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20220303230608412" src="/assets/images/image-20220303230608412-70f8776019c6252158bb6104e5d2f51f.png" width="1343" height="212" class="img_MG2L"></p><p>这时候最简单的方法是直接把当前模块改成<code>.mjs</code>后缀，然后使用 ESM 的<code>import</code>语法引入。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// index.mjs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">import</span><span class="token plain"> </span><span class="token imports">chalk</span><span class="token plain"> </span><span class="token keyword module" style="color:rgb(189, 147, 249);font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'chalk'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">chalk</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">blue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'Hello world!'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样是能在当前模块处理第三方 ESM 模块了，但是使用该<code>.mjs</code>模块的模块也需要是 ESM 模块，同样需要<code>import(xxx.mjs)</code>。可想而知，不断改造下去整个项目都迁移到了 ESM 模块，所以要在 CJS 项目中使用 ESM 模块，整个项目都必须遵循 ESM 模块语法，这时候直接使用<code>type: "module"</code>最好。</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// package.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"type"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"module"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[学习vuecli源码的收获]]></title>
        <id>https://willes.github.io/learncli</id>
        <link href="https://willes.github.io/learncli"/>
        <updated>2022-02-27T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[为什么学习]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="为什么学习">为什么学习<a href="#为什么学习" class="hash-link" aria-label="为什么学习的直接链接" title="为什么学习的直接链接">​</a></h2><p>之所以学习<code>vue-cli</code>的源码，主要是我个人想提升脚手架搭建方面的能力，学习<code>vue-cli</code>插件机制的设计模式和一些脚手架开发的技巧。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="学到了什么">学到了什么<a href="#学到了什么" class="hash-link" aria-label="学到了什么的直接链接" title="学到了什么的直接链接">​</a></h2><p>通过学习<code>vue-cli</code>从输入 CLI 命令、生成代码，安装依赖再到最后开发环境构建的整个流程，我个人收获主要是以下几方面。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="插件模式的实现">插件模式的实现<a href="#插件模式的实现" class="hash-link" aria-label="插件模式的实现的直接链接" title="插件模式的实现的直接链接">​</a></h3><p>首先主要是<code>vue-cli</code>约定的一套插件机制，一个插件就是一个函数，在<code>vue-cli</code>中插件可以用来修改项目<code>webpack</code>配置，添加项目依赖包，写入项目文件以及植入新的<code>vue-cli-service</code>的命令等等。并且使用的插件还支持持久缓存在本地目录下作为<code>preset</code>，这样下次调用<code>vue-cli</code>的命令时可以直接基于<code>preset</code>安装插件。</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// preset 内部保存的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"useConfigFiles"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"cssPreprocessor"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"sass"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"plugins"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"@vue/cli-plugin-babel"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"@vue/cli-plugin-eslint"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"config"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"airbnb"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"lintOn"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"save"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"commit"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"@vue/cli-plugin-router"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"@vue/cli-plugin-vuex"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>以<code>vue-cli-service</code>为例，其生成项目代码的过程用简单的伪代码表示就是以下几步：</p><ol><li>初始化<code>Creator</code>实例，保存一些<code>package.json</code>的配置项，要写入的文件模板数据等；</li></ol><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">Creator</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">constructor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">projectName</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// package.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">pkg</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> projectName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">private</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">devDependencies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 待执行的插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">plugins</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 待生成的文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">files</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// CLI 选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">options</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 拓展 package.json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">extendPackage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">fields</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 插入待生成文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">source，data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>获取指定<code>preset</code>，如果没有指定的话就让用户选择<code>preset</code>，并将<code>preset</code>内部的<code>plugin</code>写入<code>package.json</code>的<code>dependencies</code>内部</li></ol><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function-variable function" style="color:rgb(80, 250, 123)">resolvePreset</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> preset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">preset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> preset </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">load</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">preset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> answers </span><span class="token operator">=</span><span class="token plain"> inquirer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">prompt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'preset'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'list'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">message</span><span class="token operator">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string string" style="color:rgb(255, 121, 198)">Please pick a preset:</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">choices</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Default (Vue 2)'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Default (Vue 2)'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Default (Vue 3)'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Default (Vue 3)'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'Manually select features'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">value</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'__manual__'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    preset </span><span class="token operator">=</span><span class="token plain"> answers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">preset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> deps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">keys</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">preset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">plugins</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  deps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">forEach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">dep</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">plugins</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">pkg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">devDependencies</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">dep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> preset</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">plugins</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">dep</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>生成<code>package.json</code>文件</li></ol><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">fs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">writeFileSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">join</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">cwd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'package.json'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">stringify</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pkg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">'utf8'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>安装初始<code>plugin</code>依赖</li></ol><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shelljs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">exec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'npm install'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li>初始化<code>GeneratorAPI</code>实例，<code>GeneratorAPI</code>实例传入<code>plugin</code>内部的<code>generator</code>函数来拓展<code>Creator</code>实例的待生成文件</li></ol><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// vue-cli-service 内部 generator/index.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(80, 250, 123)">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">api</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">render</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'./template'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">doesCompile</span><span class="token operator">:</span><span class="token plain"> api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">hasPlugin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'babel'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">hasPlugin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'typescript'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">useBabel</span><span class="token operator">:</span><span class="token plain"> api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">hasPlugin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'babel'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  api</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">extendPackage</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">scripts</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">'serve'</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'vue-cli-service serve'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">'build'</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'vue-cli-service build'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">browserslist</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'&gt; 1%'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'last 2 versions'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string" style="color:rgb(255, 121, 198)">'not dead'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token spread operator">...</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">vueVersion</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'3'</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">'not ie 11'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// GeneratorAPI 插件实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">GeneratorAPI</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">constructor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">creator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">creator</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> generator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * 从安装插件的路径中生成并渲染模板文件</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param templatePath</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">path</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">creator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">renderTemplate</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * 拓展package.json字段</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   * @param pkg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">extendPkg</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">pkg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">creator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">extendPkg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">pkg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 调用插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function-variable function" style="color:rgb(80, 250, 123)">resolvePlugins</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">plugins</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">forEach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">plugin</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> apply </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">${</span><span class="token template-string interpolation">plugin</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token template-string string" style="color:rgb(255, 121, 198)">/generator</span><span class="token template-string template-punctuation string" style="color:rgb(255, 121, 198)">`</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">apply</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">GeneratorAPI</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="6"><li>再次安装依赖</li></ol><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">shelljs.exec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'npm install'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="7"><li>生成项目文件</li></ol><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">writeFileTree</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">files</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当然了，这个只是简化的版本，实际上<code>vue-cli</code>内部会再通过一个中间的<code>Generator</code>实例来管理所有插件，并不会完全放在主程序<code>Creator</code>内部，而<code>GeneratorAPI</code>则管理所有注入到<code>plugin</code>的方法。这样每个<code>class</code>内部各司其责，使得后续维护更加方便。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="事件机制">事件机制<a href="#事件机制" class="hash-link" aria-label="事件机制的直接链接" title="事件机制的直接链接">​</a></h3><p><code>vue-cli</code>内部主程序<code>Creator</code>继承了 NodeJS 的<code>EventEmitter</code>，然后在程序执行的过程中暴露一些事件回调。</p><p><code>EventEmitter</code>比较简单，<code>on</code>函数用于绑定事件函数，<code>emit</code>属性用于触发一个事件。<code>emit</code>的第一个参数指定事件名称，后续参数将传入回调函数作为参数。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'creating'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'git-init'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'plugins-install'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'invoking-generators'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'deps-install'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'completion-hooks'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">emit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">event</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'done'</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样后续在其他插件内部可以通过创建<code>Creator</code>实例来注入回调函数，例如</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> creator </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">Creator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onCreationEvent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token parameter"> event </span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    progress</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">set</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">PROGRESS_ID</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token literal-property property">status</span><span class="token operator">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token literal-property property">info</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  creator</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'creation'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> onCreationEvent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="一些nodejs的package">一些nodejs的package<a href="#一些nodejs的package" class="hash-link" aria-label="一些nodejs的package的直接链接" title="一些nodejs的package的直接链接">​</a></h3><p>一般这种 NodeJS CLI 都会大量使用一些第三方<code>package</code>来简化开发逻辑，<code>vue-cli</code>内部也不乏一些经常使用的优质第三方开源项目，例如<code>fs-extra</code>，<code>chalk</code>等这些，就不全部列举了。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="一些nodejs的小方法">一些nodejs的小方法<a href="#一些nodejs的小方法" class="hash-link" aria-label="一些nodejs的小方法的直接链接" title="一些nodejs的小方法的直接链接">​</a></h3><p>在<code>vue-cli</code>内部有一些通用方法可以直接拿过来用，后续我打算抽成一个单独的<code>node-util</code> npm 包的形式，整理一些常用的 NodeJS 方法，这样以后维护比较方便。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// 创建文件夹并写入文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'fs-extra'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">writeFileTree</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">dir</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> files</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">keys</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">forEach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">include </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">include</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">has</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> filePath </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">join</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">dir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">ensureDirSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">dirname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">writeFileSync</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">filePath</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> files</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[vuecli源码解析(1)]]></title>
        <id>https://willes.github.io/2022/01/23/vuecli源码解析1</id>
        <link href="https://willes.github.io/2022/01/23/vuecli源码解析1"/>
        <updated>2022-01-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image-20220122161749258]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image-20220122161749258" src="/assets/images/image-20220122161749258-383f62ef576a853b9ae26397291e6d3f.png" width="988" height="563" class="img_MG2L"></p><p><code>vue-cli</code>是 vue 官方出品的脚手架项目，用来快速搭建<code>vue</code>项目，一键生成项目基础代码。</p><p>一直对其内部的运行原理比较好奇，并且开发脚手架的能力也是一名前端开发人员需要掌握的技能，所以这里以<code>v4.5.15</code>版本为例，记录一下源码研究的过程和学习点。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="入口">入口<a href="#入口" class="hash-link" aria-label="入口的直接链接" title="入口的直接链接">​</a></h2><p><code>vue-cli</code>采用的仍然是通过<code>lerna</code>管理的 monorepo，不知道未来会不会迁移到 pnpm，从<code>package.json</code>可以看到核心仓库就是以下三个，其中<code>@vue</code>就是一些核心代码，包括脚手架<code>@vue/cli</code>、<code>vue-cli-service</code>以及一些插件。</p><p><img loading="lazy" alt="image-20220122103920356" src="/assets/images/image-20220122103920356-e89179755b064eeedf19b5d580f7cc1c.png" width="763" height="141" class="img_MG2L"></p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vue-cli</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├─ docs                                                 // 文档</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├─ packages                                         </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    ├─ @vue</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ babel-preset-app</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli                                // @vue/cli</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-overlay</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-babel</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-e2e-cypress</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-e2e-nightwatch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-e2e-webdriverio</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-eslint</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-pwa</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-router</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-typescript</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-unit-jest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-unit-mocha</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-plugin-vuex</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-service                // vue-cli-service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-shared-utils</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-test-utils         // 一些第三库的源代码，或者一些工具函数等</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-ui</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    ├─ cli-ui-addon-webpack</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│    │    └─ cli-ui-addon-widgets</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├─ scripts                                          // 一些管理monorepo的程序</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="vuecli">@vue/cli<a href="#vuecli" class="hash-link" aria-label="@vue/cli的直接链接" title="@vue/cli的直接链接">​</a></h2><p>先从脚手架启动引导程序<code>@vue/cli</code>开始分析，从<code>package.json</code>注册的<code>bin</code>属性找到入口程序为<code>bin/vue.js</code>.</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"bin"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"vue"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"bin/vue.js"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="检查nodejs版本">检查Nodejs版本<a href="#检查nodejs版本" class="hash-link" aria-label="检查Nodejs版本的直接链接" title="检查Nodejs版本的直接链接">​</a></h3><p>首先会通过<code>semver</code>这个库检查使用者本地 Nodejs 的版本和在<code>@vue/cli</code>的<code>package.json</code>下要求的版本是否符合。</p><p><img loading="lazy" alt="image-20220122105655018" src="/assets/images/image-20220122105655018-2a59e01ca4a44436ff6c9418216d8237.png" width="751" height="310" class="img_MG2L"></p><p>这里简单了解下 Nodejs 的版本管理，Nodejs 版本有以下几种：</p><ul><li><code>CURRENT</code>：当前状态，也就是当前最新的 Nodejs 版本，<code>ACTIVE</code>版本的 Nodejs 会维护持续 6 个月时间，6 个月之后奇数版本会不再维护，而偶数版本会变成<code>ACTIVE</code>状态的<code>LTS</code>版本</li><li><code>ACTIVE</code>：活跃状态，是正在积极维护和升级的版本，包括一些 BUG 修复，功能改进等</li><li><code>MAINTENANCE</code>：维护状态，只修复 BUG，维护时间不定</li><li><code>EOL</code>：End of Life，也就是终止维护的版本</li><li><code>LTS</code>：long-term support，也就是长期维护版本，这意味着重大的 Bug 将在后续的 30 个月内持续得到不断地修复。</li></ul><p>如下图所示，Nodejs 12 已进入维护状态，并且在 2022 年 4 月份就会终止维护，到时候Nodejs 18 也会发布，Nodejs 17 也会终止维护。 反正一个原则是始终用 LTS 版本就行了。可以使用<code>nvm</code>便捷的管理 Nodejs 的版本。</p><p><img loading="lazy" alt="Releases" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NjAiIGhlaWdodD0iNTAwIj48ZGVmcz48c3R5bGU+LmN1cnJlbnR7ZmlsbDojMmFhNzQ4fS5hY3RpdmV7ZmlsbDojNDdiNGZmfS5tYWludGVuYW5jZSwudGljayB0ZXh0e2ZpbGw6Izg5YTE5ZH0udW5zdGFibGV7ZmlsbDojZmZiODAwfS5iYXItam9pbiwubGFiZWx7ZmlsbDojZmZmfS5iYXItam9pbi5jdXJyZW50e2Rpc3BsYXk6bm9uZX0udGljayB0ZXh0e2ZvbnQ6MTZweCBzYW5zLXNlcmlmfS5heGlzLS15IC50aWNrIHRleHR7dGV4dC1hbmNob3I6ZW5kfS5sYWJlbHtmb250OjIwcHggc2Fucy1zZXJpZjtmb250LXdlaWdodDoxMDA7dGV4dC1hbmNob3I6c3RhcnQ7ZG9taW5hbnQtYmFzZWxpbmU6bWlkZGxlO3RleHQtdHJhbnNmb3JtOnVwcGVyY2FzZX08L3N0eWxlPjwvZGVmcz48ZyBpZD0iYmFyLWNvbnRhaW5lciI+PGcgY2xhc3M9ImF4aXMgYXhpcy0teCIgZmlsbD0ibm9uZSIgZm9udC1zaXplPSIxMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiM4OWExOWQiIGQ9Ik0uNSAwdjQ0MCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTQ1LjE5NSAzMCkiLz48dGV4dCBmaWxsPSIjMDAwIiB4PSIuNSIgZHk9Ii0xMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTQ1LjE5NSAzMCkiPkp1bCAyMDIxPC90ZXh0PjwvZz48ZyBjbGFzcz0idGljayI+PHBhdGggc3Ryb2tlPSIjODlhMTlkIiBzdHJva2UtZGFzaGFycmF5PSIyLDIiIGQ9Ik0uNSAwdjQ0MCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUzLjI3NSAzMCkiLz48dGV4dCBmaWxsPSIjMDAwIiB4PSIuNSIgZHk9Ii0xMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUzLjI3NSAzMCkiPk9jdCAyMDIxPC90ZXh0PjwvZz48ZyBjbGFzcz0idGljayI+PHBhdGggc3Ryb2tlPSIjODlhMTlkIiBkPSJNLjUgMHY0NDAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM2MS40MDQgMzApIi8+PHRleHQgZmlsbD0iIzAwMCIgeD0iLjUiIGR5PSItMTAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDM2MS40MDQgMzApIj5KYW4gMjAyMjwvdGV4dD48L2c+PGcgY2xhc3M9InRpY2siPjxwYXRoIHN0cm9rZT0iIzg5YTE5ZCIgc3Ryb2tlLWRhc2hhcnJheT0iMiwyIiBkPSJNLjUgMHY0NDAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ2Ny4wODYgMzApIi8+PHRleHQgZmlsbD0iIzAwMCIgeD0iLjUiIGR5PSItMTAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ2Ny4wODYgMzApIj5BcHIgMjAyMjwvdGV4dD48L2c+PGcgY2xhc3M9InRpY2siPjxwYXRoIHN0cm9rZT0iIzg5YTE5ZCIgZD0iTS41IDB2NDQwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1NzMuOTkxIDMwKSIvPjx0ZXh0IGZpbGw9IiMwMDAiIHg9Ii41IiBkeT0iLTEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1NzMuOTkxIDMwKSI+SnVsIDIwMjI8L3RleHQ+PC9nPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiM4OWExOWQiIHN0cm9rZS1kYXNoYXJyYXk9IjIsMiIgZD0iTS41IDB2NDQwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2ODIuMDcxIDMwKSIvPjx0ZXh0IGZpbGw9IiMwMDAiIHg9Ii41IiBkeT0iLTEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2ODIuMDcxIDMwKSI+T2N0IDIwMjI8L3RleHQ+PC9nPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiM4OWExOWQiIGQ9Ik0uNSAwdjQ0MCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNzkwLjIgMzApIi8+PHRleHQgZmlsbD0iIzAwMCIgeD0iLjUiIGR5PSItMTAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDc5MC4yIDMwKSI+SmFuIDIwMjM8L3RleHQ+PC9nPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiM4OWExOWQiIHN0cm9rZS1kYXNoYXJyYXk9IjIsMiIgZD0iTS41IDB2NDQwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4OTUuODgyIDMwKSIvPjx0ZXh0IGZpbGw9IiMwMDAiIHg9Ii41IiBkeT0iLTEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4OTUuODgyIDMwKSI+QXByIDIwMjM8L3RleHQ+PC9nPjwvZz48ZyBjbGFzcz0iYXhpcyBheGlzLS15IiBmaWxsPSJub25lIiBmb250LXNpemU9IjEwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiI+PGcgY2xhc3M9InRpY2siPjxwYXRoIHN0cm9rZT0iI2UxZTdlNyIgZD0iTTAgLjVoODIwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgNzUuMzk3KSIvPjx0ZXh0IGZpbGw9IiMwMDAiIHk9Ii41IiBkeT0iLjMyZW0iIGR4PSItMTAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCA3NS4zOTcpIj5NYXN0ZXI8L3RleHQ+PC9nPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiNlMWU3ZTciIGQ9Ik0wIC41aDgyMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDE0NS4yMzgpIi8+PHRleHQgZmlsbD0iIzAwMCIgeT0iLjUiIGR5PSIuMzJlbSIgZHg9Ii0xMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDE0NS4yMzgpIj5Ob2RlLmpzIDEyPC90ZXh0PjwvZz48ZyBjbGFzcz0idGljayI+PHBhdGggc3Ryb2tlPSIjZTFlN2U3IiBkPSJNMCAuNWg4MjAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAyMTUuMDgpIi8+PHRleHQgZmlsbD0iIzAwMCIgeT0iLjUiIGR5PSIuMzJlbSIgZHg9Ii0xMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDIxNS4wOCkiPk5vZGUuanMgMTQ8L3RleHQ+PC9nPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiNlMWU3ZTciIGQ9Ik0wIC41aDgyMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDI4NC45MikiLz48dGV4dCBmaWxsPSIjMDAwIiB5PSIuNSIgZHk9Ii4zMmVtIiBkeD0iLTEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMjg0LjkyKSI+Tm9kZS5qcyAxNjwvdGV4dD48L2c+PGcgY2xhc3M9InRpY2siPjxwYXRoIHN0cm9rZT0iI2UxZTdlNyIgZD0iTTAgLjVoODIwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzU0Ljc2MikiLz48dGV4dCBmaWxsPSIjMDAwIiB5PSIuNSIgZHk9Ii4zMmVtIiBkeD0iLTEwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzU0Ljc2MikiPk5vZGUuanMgMTc8L3RleHQ+PC9nPjxnIGNsYXNzPSJ0aWNrIj48cGF0aCBzdHJva2U9IiNlMWU3ZTciIGQ9Ik0wIC41aDgyMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDQyNC42MDMpIi8+PHRleHQgZmlsbD0iIzAwMCIgeT0iLjUiIGR5PSIuMzJlbSIgZHg9Ii0xMCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDQyNC42MDMpIj5Ob2RlLmpzIDE4PC90ZXh0PjwvZz48cGF0aCBzdHJva2U9IiM4OWExOWQiIGQ9Ik0wIDQ0MGg4MjAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48L2c+PHBhdGggY2xhc3M9ImJhciB1bnN0YWJsZSIgZD0iTTAgMjAuOTUyaDgyMHY0OC44ODlIMHoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48dGV4dCBjbGFzcz0ibGFiZWwiIHg9IjE1IiB5PSI0Ny4zOTciIHN0eWxlPSJvcGFjaXR5OjEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiPnVuc3RhYmxlPC90ZXh0PjxwYXRoIGNsYXNzPSJiYXIgbWFpbnRlbmFuY2UiIGQ9Ik0wIDkwLjc5NGgzOTEuMjAzdjQ4Ljg4OUgweiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSIvPjx0ZXh0IGNsYXNzPSJsYWJlbCIgeD0iMTUiIHk9IjExNy4yMzgiIHN0eWxlPSJvcGFjaXR5OjEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiPm1haW50ZW5hbmNlPC90ZXh0PjxwYXRoIGNsYXNzPSJiYXIgbWFpbnRlbmFuY2UiIGQ9Ik0xNjQuNDcgMTYwLjYzNUg4MjB2NDguODg5SDE2NC40N3oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48cGF0aCBjbGFzcz0iYmFyLWpvaW4gbWFpbnRlbmFuY2UiIHN0eWxlPSJvcGFjaXR5OjEiIGQ9Ik0xNjMuNDcgMTYwLjYzNWgydjQ4Ljg4OWgtMnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48dGV4dCBjbGFzcz0ibGFiZWwiIHg9IjE3OS40NyIgeT0iMTg3LjA3OSIgc3R5bGU9Im9wYWNpdHk6MSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSI+bWFpbnRlbmFuY2U8L3RleHQ+PHBhdGggY2xhc3M9ImJhciBhY3RpdmUiIGQ9Ik0wIDE2MC42MzVoMTY0LjQ3djQ4Ljg4OUgweiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSIvPjx0ZXh0IGNsYXNzPSJsYWJlbCIgeD0iMTUiIHk9IjE4Ny4wNzkiIHN0eWxlPSJvcGFjaXR5OjEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiPmFjdGl2ZTwvdGV4dD48cGF0aCBjbGFzcz0iYmFyIG1haW50ZW5hbmNlIiBkPSJNNTkyLjA5MiAyMzAuNDc2SDgyMHY0OC44ODlINTkyLjA5MnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48cGF0aCBjbGFzcz0iYmFyLWpvaW4gbWFpbnRlbmFuY2UiIHN0eWxlPSJvcGFjaXR5OjEiIGQ9Ik01OTEuMDkyIDIzMC40NzZoMnY0OC44ODloLTJ6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIi8+PHRleHQgY2xhc3M9ImxhYmVsIiB4PSI2MDcuMDkyIiB5PSIyNTYuOTIxIiBzdHlsZT0ib3BhY2l0eToxIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIj5tYWludGVuYW5jZTwvdGV4dD48Zz48cGF0aCBjbGFzcz0iYmFyIGFjdGl2ZSIgZD0iTTE3Mi42OTMgMjMwLjQ3Nmg0MTkuMzk4djQ4Ljg4OUgxNzIuNjkzeiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSIvPjxwYXRoIGNsYXNzPSJiYXItam9pbiBhY3RpdmUiIHN0eWxlPSJvcGFjaXR5OjEiIGQ9Ik0xNzEuNjkzIDIzMC40NzZoMnY0OC44ODloLTJ6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIi8+PHRleHQgY2xhc3M9ImxhYmVsIiB4PSIxODcuNjkzIiB5PSIyNTYuOTIxIiBzdHlsZT0ib3BhY2l0eToxIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIj5hY3RpdmU8L3RleHQ+PC9nPjxnPjxwYXRoIGNsYXNzPSJiYXIgY3VycmVudCIgZD0iTTAgMjMwLjQ3NmgxNzIuNjkzdjQ4Ljg4OUgweiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSIvPjx0ZXh0IGNsYXNzPSJsYWJlbCIgeD0iMTUiIHk9IjI1Ni45MjEiIHN0eWxlPSJvcGFjaXR5OjEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiPmN1cnJlbnQ8L3RleHQ+PC9nPjxnPjxwYXRoIGNsYXNzPSJiYXIgbWFpbnRlbmFuY2UiIGQ9Ik0zNTcuMTM1IDMwMC4zMTdoNzEuNjYydjQ4Ljg4OWgtNzEuNjYyeiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSIvPjxwYXRoIGNsYXNzPSJiYXItam9pbiBtYWludGVuYW5jZSIgc3R5bGU9Im9wYWNpdHk6MSIgZD0iTTM1Ni4xMzUgMzAwLjMxN2gydjQ4Ljg4OWgtMnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48L2c+PGc+PHBhdGggY2xhc3M9ImJhciBjdXJyZW50IiBkPSJNMTY0LjQ3IDMwMC4zMTdoMTkyLjY2NXY0OC44ODlIMTY0LjQ3eiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTEwIDMwKSIvPjx0ZXh0IGNsYXNzPSJsYWJlbCIgeD0iMTc5LjQ3IiB5PSIzMjYuNzYyIiBzdHlsZT0ib3BhY2l0eToxIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIj5jdXJyZW50PC90ZXh0PjwvZz48Zz48cGF0aCBjbGFzcz0iYmFyIGFjdGl2ZSIgZD0iTTYwMC4zMTUgMzcwLjE1OUg4MjB2NDguODg5SDYwMC4zMTV6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIi8+PHBhdGggY2xhc3M9ImJhci1qb2luIGFjdGl2ZSIgc3R5bGU9Im9wYWNpdHk6MSIgZD0iTTU5OS4zMTUgMzcwLjE1OWgydjQ4Ljg4OWgtMnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiLz48dGV4dCBjbGFzcz0ibGFiZWwiIHg9IjYxNS4zMTUiIHk9IjM5Ni42MDMiIHN0eWxlPSJvcGFjaXR5OjEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMCAzMCkiPmFjdGl2ZTwvdGV4dD48L2c+PGc+PHBhdGggY2xhc3M9ImJhciBjdXJyZW50IiBkPSJNMzc4LjI4MSAzNzAuMTU5aDIyMi4wMzR2NDguODg5SDM3OC4yODF6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIi8+PHRleHQgY2xhc3M9ImxhYmVsIiB4PSIzOTMuMjgxIiB5PSIzOTYuNjAzIiBzdHlsZT0ib3BhY2l0eToxIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMTAgMzApIj5jdXJyZW50PC90ZXh0PjwvZz48L2c+PC9zdmc+" width="960" height="500" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="注册命令">注册命令<a href="#注册命令" class="hash-link" aria-label="注册命令的直接链接" title="注册命令的直接链接">​</a></h3><p>然后使用<code>commanderjs</code>注册命令<code>create</code>，并且包含必填的<code>app-name</code>参数，可以看到<code>create</code>注册以后，会去加载上层<code>lib</code>下的<code>create.js</code>程序，这里还传递了项目名称和额外的 CLI 参数。</p><p><img loading="lazy" alt="image-20220122125035080" src="/assets/images/image-20220122125035080-24427345132120b9bc9ef93da02b990c.png" width="1417" height="545" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="校验项目名称">校验项目名称<a href="#校验项目名称" class="hash-link" aria-label="校验项目名称的直接链接" title="校验项目名称的直接链接">​</a></h3><p><code>create.js</code>内部首先会通过<code>validate-npm-package-name</code>这个库去校验项目名称，并且会额外处理使用<code>.</code>作为当前目录的情况，考虑的非常周到。</p><p><img loading="lazy" alt="image-20220122150200380" src="/assets/images/image-20220122150200380-542f8c4c464b1ddf0a47efb71e6dba44.png" width="1070" height="151" class="img_MG2L"></p><p>如果通过 CLI 指定<code>--merge</code>，则会清空目标文件夹，否则会使用<code>inquirer</code>在 CLI 发起选项选择是否合并目录文件或者选择清空。这里使用了<code>fs-extra</code>来操作文件系统。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="初始化creator实例">初始化Creator实例<a href="#初始化creator实例" class="hash-link" aria-label="初始化Creator实例的直接链接" title="初始化Creator实例的直接链接">​</a></h3><p>在确认了目标文件夹以后，会初始化<code>Creator</code>的实例，并传递 CLI 参数来调用实例的<code>create</code>方法。</p><p><img loading="lazy" alt="image-20220122131148494" src="/assets/images/image-20220122131148494-8c1580e427fbf12b2c2529d62a84d835.png" width="1133" height="84" class="img_MG2L"></p><p>这里传递了三个初始化参数：</p><ul><li><code>name</code>：项目名称</li><li><code>targetDir</code>：创建项目的文件夹</li><li><code>getPromptModules()</code>：加载位于上层<code>promptModules</code>文件夹下的一些函数</li></ul><p><img loading="lazy" alt="image-20220122134405339" src="/assets/images/image-20220122134405339-97c651ae244647793dab917a9baef396.png" width="987" height="375" class="img_MG2L"></p><p>位于<code>promptModules</code>下的都是一些用户在创建项目时手动选择的功能项，例如<code>vue</code>的版本，是否使用 TS，CSS预处理器等。</p><p>以<code>../promptModules/babel.js</code>为例，可以看到其内部是一个函数，接收一个<code>cli</code>对象，并且调用了<code>cli</code>对象暴露的<code>injectFeature</code>和<code>onPromptComplete</code>这两个方法。</p><p><img loading="lazy" alt="image-20220122143703009" src="/assets/images/image-20220122143703009-513ef3844ba30f08507530e64a9fdf74.png" width="1120" height="526" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="获取prompt选项">获取prompt选项<a href="#获取prompt选项" class="hash-link" aria-label="获取prompt选项的直接链接" title="获取prompt选项的直接链接">​</a></h3><p><img loading="lazy" alt="image-20220122132912054" src="/assets/images/image-20220122132912054-be4f13282b0c60743908586426676f87.png" width="1222" height="507" class="img_MG2L"></p><p>在<code>Creator</code>的构造函数内部会初始化一些实例属性：</p><ul><li><p><code>name</code>：项目名称</p></li><li><p><code>context</code>：当前创建的目录</p></li><li><p><code>presetPrompt</code>：<code>preset</code>的选项；通过<code>resolveIntroPrompts</code>获取<code>preset</code>信息，其中包括加载用户创建的保存在本地<code>.vuerc</code>下的<code>preset</code>，以及<code>@vue/cli</code>内置默认的<code>preset</code>信息，然后组合成<code>inquirer</code>选项参数保存在这个属性下</p></li></ul><p><img loading="lazy" alt="image-20220122155504150" src="/assets/images/image-20220122155504150-38f59d0305f5ffad78dd1bd2304e85c0.png" width="1130" height="830" class="img_MG2L"></p><p>默认的<code>preset</code>只有两个：选择<code>vue2</code>和<code>vue3</code>的版本，并且都会包含<code>@vue/cli-plugin-babel</code>和<code>@vue/cli-plugin-eslint</code>两个<code>plugin</code></p><p><img loading="lazy" alt="image-20220122143427655" src="/assets/images/image-20220122143427655-cdedc8637bc125a0aa6acfbbb3d29a60.png" width="1120" height="577" class="img_MG2L"></p><ul><li><code>featurePrompt</code>：如果用户选择不使用任何<code>preset</code>而是手动选择一些功能来创建项目，例如是否使用 TS，选择 CSS 预处理器等，那么就会从<code>featurePrompt</code>加载一些选项</li></ul><p><img loading="lazy" alt="image-20220122135142250" src="/assets/images/image-20220122135142250-6fb804ccbb759927bdba55d812c84d50.png" width="1118" height="625" class="img_MG2L"></p><ul><li><code>outroPrompts</code>：主要是通过<code>inquirer</code>指定的一些选项，例如保存配置文件的方式、选择使用的依赖管理工具npm,yarn,pnpm等</li></ul><p>之后会通过传入当前实例对象<code>this</code>来初始化一个<code>PromptModuleAPI</code>的实例。</p><p><img loading="lazy" alt="image-20220122135843585" src="/assets/images/image-20220122135843585-90887d2e397c38afe1f971a04c3bec80.png" width="889" height="85" class="img_MG2L"></p><p><code>PromptModuleAPI</code>内部会往自身的实例上挂载一个<code>creator</code>对象，也就是<code>Creator</code>的实例，这样在<code>PromptModuleAPI</code>内部的实例就可以通过<code>creator</code>对象访问<code>Creator</code>的实例内部的属性和方法。</p><p><img loading="lazy" alt="image-20220122135238009" src="/assets/images/image-20220122135238009-cbab834c5827e0a82f2b06e69ccce4af.png" width="1022" height="578" class="img_MG2L"></p><p>这时候初始化<code>Creator</code>实例时传入的<code>promptModules</code>内部的每个函数就会被调用，并传入<code>PromptModuleAPI</code>的实例作为参数，每个函数内部通过调用<code>PromptModuleAPI</code>内部的方法再向<code>Creator</code>实例内部的属性注入自身的<code>prompt</code>选项，不得不说逻辑有点绕，但是提高了程序的拓展性，以后<code>@vue/cli</code>内部想拓展一些功能，只需要在<code>promptModules</code>文件夹下编写程序即可。</p><ul><li><code>injectFeature</code>：往实例的<code>featurePrompt.choices</code>推入一些<code>feature</code></li><li><code>injectPrompt</code>：往实例的<code>injectedPrompts</code>推入一些<code>prompt</code></li><li><code>injectOptionForPrompt</code>：往<code>injectedPrompts.choices</code>推入一些选项</li><li><code>onPromptComplete</code>：往实例的<code>promptCompleteCbs</code>推入回调函数，在<code>prompt</code>执行完以后执行</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="组合prompt并获取preset">组合prompt并获取preset<a href="#组合prompt并获取preset" class="hash-link" aria-label="组合prompt并获取preset的直接链接" title="组合prompt并获取preset的直接链接">​</a></h3><p>初始化<code>Creator</code>实例以后会调用<code>create</code>方法，接收 CLI 命令行指定的所有参数，在使用<code>vue create xx</code>命令没有指定任何其他参数的情况下会进入<code>promptAndResolvePreset</code>方法。<code>promptAndResolvePreset</code>内部主要做了两件事：</p><ul><li>合并<code>Creator</code>实例的<code>presetPrompt</code>，<code>featurePrompt</code>，<code>injectedPrompts</code>以及<code>outroPrompts</code>这些选项，并且默认的选项<code>presetPrompt</code>作为第一个，后续的<code>prompt</code>会通过<code>inquirer</code>的<code>when</code>函数来判断其是否需要执行，如果用户选择不使用<code>preset</code>，那么才会执行后续手动选择<code>feature</code>的部分</li></ul><p><img loading="lazy" alt="image-20220122154431693" src="/assets/images/image-20220122154431693-8b8c773f904db75ccc28434e00b8209a.png" width="976" height="454" class="img_MG2L"></p><ul><li>当用户选择了<code>preset</code>以后，就会通过<code>resolvePreset</code>再次获取<code>preset</code>的信息</li></ul><p><img loading="lazy" alt="image-20220122154736822" src="/assets/images/image-20220122154736822-d551d5312864aad9fc9bcadc882cd9d3.png" width="984" height="80" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="注入vue-cli-service">注入vue-cli-service<a href="#注入vue-cli-service" class="hash-link" aria-label="注入vue-cli-service的直接链接" title="注入vue-cli-service的直接链接">​</a></h3><p><code>vue-cli-service</code>在这里也是作为一个<code>plugin</code>，上文获取<code>preset</code>信息以后，会在其默认<code>plugins</code>的基础上再注册<code>vue-cli-service</code></p><p><img loading="lazy" alt="image-20220122160008434" src="/assets/images/image-20220122160008434-71a95cc243476732b86a24c61e0022d7.png" width="893" height="152" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="生成packagejson">生成package.json<a href="#生成packagejson" class="hash-link" aria-label="生成package.json的直接链接" title="生成package.json的直接链接">​</a></h3><p>获取所有<code>plugin</code>以后，会创建<code>package.json</code>对象，写入<code>plugin</code>的版本，并生成文件</p><p><img loading="lazy" alt="image-20220122161035813" src="/assets/images/image-20220122161035813-d08a5b88545c3059628ce0a5d0a5903a.png" width="1081" height="851" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="初始化git">初始化git<a href="#初始化git" class="hash-link" aria-label="初始化git的直接链接" title="初始化git的直接链接">​</a></h3><p>如果通过 CLI 指定初始化 git，这里还会调用<code>git init</code>命令，初始化 git 本地存储服务。</p><p><img loading="lazy" alt="image-20220123221844974" src="/assets/images/image-20220123221844974-d78075b1046217f1d268c52d278f9166.png" width="1129" height="151" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="安装依赖">安装依赖<a href="#安装依赖" class="hash-link" aria-label="安装依赖的直接链接" title="安装依赖的直接链接">​</a></h3><p><code>@vue/cli</code>内部定义了依赖管理基类<code>PackageManager</code>，内部会判断客户端使用的依赖管理工具，使用的源地址等信息，代码很多，就不一一展开了。这里安装的依赖从前面来看主要有三个：</p><ul><li><code>@vue/cli-plugin-babel</code></li><li><code>@vue/cli-plugin-eslint</code></li><li><code>@vue/cli-service</code></li></ul><p><img loading="lazy" alt="image-20220123222843578" src="/assets/images/image-20220123222843578-5b0503cf895dd9cefa7dccaf82db2e69.png" width="1099" height="280" class="img_MG2L"></p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[vuecli源码解析(2)]]></title>
        <id>https://willes.github.io/2022/01/23/vuecli源码解析2</id>
        <link href="https://willes.github.io/2022/01/23/vuecli源码解析2"/>
        <updated>2022-01-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image-20220122161800174]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image-20220122161800174" src="/assets/images/image-20220122161800174-383f62ef576a853b9ae26397291e6d3f.png" width="988" height="563" class="img_MG2L"></p><p>上文说到创建完<code>package.json</code>文件并安装<code>plugins</code>的依赖，然后后续会初始化<code>Generator</code>实例，<code>Generator</code>内部会调用各个<code>plugin</code>，涉及到插件机制的实现，这里单独起一篇介绍。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="plugin程序">plugin程序<a href="#plugin程序" class="hash-link" aria-label="plugin程序的直接链接" title="plugin程序的直接链接">​</a></h2><p>首先了解一下<code>@vue/cli</code>中<code>plugin</code>的开发方式，<code>plugin</code>由一个 Service 插件<code>index.js</code>文件作为引导，此外还可以包含<code>generator.js </code>，<code>prompts.js</code>这些文件。</p><p><code>index.js</code>可以修改 webpack 配置，创建新的 vue-cli service 命令或者修改已经存在的命令。</p><p><code>generator</code>主要用于拓展项目依赖，创建新的文件或者编辑已经存在的文件；且必须是一个函数。</p><p><code>prompts.js</code>则在创建一个新的项目或者在已有项目中添加新的插件时处理用户选项，通过<code>inquirer</code>实现。</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── README.md</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── generator.js  </span><span class="token comment" style="color:rgb(98, 114, 164)"># generator（可选）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── index.js      </span><span class="token comment" style="color:rgb(98, 114, 164)"># service 插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── package.json</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── prompts.js    </span><span class="token comment" style="color:rgb(98, 114, 164)"># prompt 文件（可选）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└── ui.js         </span><span class="token comment" style="color:rgb(98, 114, 164)"># Vue UI 集成（可选）</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="加载plugin">加载plugin<a href="#加载plugin" class="hash-link" aria-label="加载plugin的直接链接" title="加载plugin的直接链接">​</a></h2><p>紧接上文继续分析<code>Creator</code>内部的<code>create</code>方法，在安装完<code>@vue/cli</code>内部的<code>vue-cli-service</code>等插件的依赖后，会通过<code>resolvePlugins</code>方法对<code>preset</code>的<code>plugins</code>执行顺序进行排列，保证<code>vue-cli-service</code>始终第一个执行，并且加载<code>plugin</code>内部的<code>generator.js</code>和<code>prompts.js</code>程序，推入<code>apply</code>方法。</p><p><img loading="lazy" alt="image-20220122165140480" src="/assets/images/image-20220122165140480-b41f70a2dd1918b8e3e92deae833d865.png" width="1114" height="779" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="初始化generator">初始化Generator<a href="#初始化generator" class="hash-link" aria-label="初始化Generator的直接链接" title="初始化Generator的直接链接">​</a></h2><p>加载完<code>plugin</code>之后，会初始化<code>Generator</code>实例。</p><p><img loading="lazy" alt="image-20220122162924717" src="/assets/images/image-20220122162924717-30d891a7dc25ebd5ab49ecd840b4e5ca.png" width="1220" height="247" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="plugins排序">plugins排序<a href="#plugins排序" class="hash-link" aria-label="plugins排序的直接链接" title="plugins排序的直接链接">​</a></h3><p>在<code>Generator</code>构造函数内部会对<code>plugins</code>进行排序，这个排序有点讲究的，根据代码里的注释来看使用了 leetcode 210 题的算法，这里以后探索。</p><p><img loading="lazy" alt="image-20220123224513408" src="/assets/images/image-20220123224513408-515199eec534ee2095d73e53f6e17eb7.png" width="1224" height="383" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220123225127884" src="/assets/images/image-20220123225127884-5b6179bd8191e94b3b38e36bbf21043f.png" width="872" height="805" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="加载generator程序">加载generator程序<a href="#加载generator程序" class="hash-link" aria-label="加载generator程序的直接链接" title="加载generator程序的直接链接">​</a></h3><p>初始化的时候还会加载<code>package.json</code>内部的其他插件，放入实例的<code>allPlugins</code>内部。</p><p><img loading="lazy" alt="image-20220123231305314" src="/assets/images/image-20220123231305314-164f0732b862cb9ec1642e99ab76695c.png" width="916" height="61" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220123231340125" src="/assets/images/image-20220123231340125-952d70e4385d6021a689935b328654c4.png" width="1139" height="307" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="调用generate方法">调用generate方法<a href="#调用generate方法" class="hash-link" aria-label="调用generate方法的直接链接" title="调用generate方法的直接链接">​</a></h2><p>初始化完<code>Generator</code>会调用实例的<code>generate</code>方法，<code>generate</code>内部首先会调用<code>initPlugins</code></p><p><img loading="lazy" alt="image-20220123230342636" src="/assets/images/image-20220123230342636-17666fe2cec53b8c6ebe3882a913d391.png" width="1262" height="462" class="img_MG2L"></p><p><code>initPlugins</code>内部会为每一个<code>plugin</code>初始化一个<code>GeneratorAPI</code>的实例，然后将实例对象传入<code>apply</code>方法，上文说到<code>apply</code>就是<code>plugin</code>内部的<code>generator</code>程序，所以这里就是执行<code>plugin</code>内部的<code>generator</code>。</p><p><img loading="lazy" alt="image-20220123232325784" src="/assets/images/image-20220123232325784-bd6c4d67e7ebe53788032fdecd4a32c9.png" width="1133" height="321" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="generatorapi">GeneratorAPI<a href="#generatorapi" class="hash-link" aria-label="GeneratorAPI的直接链接" title="GeneratorAPI的直接链接">​</a></h2><p><code>GeneratorAPI</code>这个类内部包含编写<code>plugin</code>的<code>generator</code>所需要的所有方法，其在初始化的时候接收<code>plugin</code>的名称<code>id</code>，<code>Generator</code>的实例，插件的参数<code>options</code>。其内部定义了生成模板文件的方法<code>render</code>，拓展<code>package.json</code>的依赖项<code>extendPackage</code>等。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="vue-cli-service">vue-cli-service<a href="#vue-cli-service" class="hash-link" aria-label="vue-cli-service的直接链接" title="vue-cli-service的直接链接">​</a></h3><p>以<code>vue-cli-service</code>为例，其内部<code>generator</code>程序如下，使用<code>render</code>方法渲染<code>template</code>内部的模板文件，拓展<code>package.json</code>的依赖项以及注入<code>scripts</code>和<code>browserslist</code>字段。</p><p><img loading="lazy" alt="image-20220123233651940" src="/assets/images/image-20220123233651940-eb38f9861c162e90dc1be967e733ae76.png" width="985" height="882" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="render">render<a href="#render" class="hash-link" aria-label="render的直接链接" title="render的直接链接">​</a></h3><p><code>render</code>方法会解析传入的文件夹路径，使用<code>globby</code>匹配获取文件夹下的所有文件。对于<code>ejs</code>模板还会调用<code>renderFile</code>方法将参数填入模板内部。</p><p><img loading="lazy" alt="image-20220124000415280" src="/assets/images/image-20220124000415280-3abfa6f8a6a02ad51dec22de9fee7429.png" width="1167" height="701" class="img_MG2L"></p><p>最后通过<code>_injectFileMiddleware</code>推入<code>Generator</code>实例的<code>fileMiddlewares</code>中。</p><p><img loading="lazy" alt="image-20220124000509280" src="/assets/images/image-20220124000509280-bfcd27a161538dded77f228358a9ae39.png" width="1097" height="252" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="extendpackage">extendPackage<a href="#extendpackage" class="hash-link" aria-label="extendPackage的直接链接" title="extendPackage的直接链接">​</a></h3><p><img loading="lazy" alt="image-20220124000730967" src="/assets/images/image-20220124000730967-cf4c7ee8d4ae27eed7582b3882a47131.png" width="1132" height="594" class="img_MG2L"></p><p><code>extendPackage</code>内部会拓展<code>Generator</code>实例的<code>pkg</code>属性，也就对应<code>package.json</code>内部的字段。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="生成配置文件">生成配置文件<a href="#生成配置文件" class="hash-link" aria-label="生成配置文件的直接链接" title="生成配置文件的直接链接">​</a></h2><p>继续看<code>generate</code>方法，之后会调用<code>extractConfigFiles</code>方法，<code>extractConfigFiles</code>会获取在<code>package.json</code>内部的配置项字段，例如<code>babel</code>，<code>eslintConfig</code>，<code>browserslist</code>等，将它们对应的有效配置文件名称推入实例的<code>files</code>属性内部，然后删除<code>package.json</code>内部的这些字段。</p><p><img loading="lazy" alt="image-20220123235424070" src="/assets/images/image-20220123235424070-78cb23141d399e05f16e4143db458ad5.png" width="671" height="720" class="img_MG2L"></p><p>之后会调用<code>writeFileTree</code>生成所有文件，<code>writeFileTree</code>内部使用<code>fs-extra</code>来操作文件。这样<code>plugin</code>的<code>generator</code>就执行完了。</p><p><img loading="lazy" alt="image-20220123235711778" src="/assets/images/image-20220123235711778-dcf5e371f604b727fe4ea3766073e9fd.png" width="1141" height="457" class="img_MG2L"></p>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[vuecli源码解析(3)]]></title>
        <id>https://willes.github.io/2022/01/23/vuecli源码解析3</id>
        <link href="https://willes.github.io/2022/01/23/vuecli源码解析3"/>
        <updated>2022-01-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image-20220122161800174]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image-20220122161800174" src="/assets/images/image-20220122161800174-383f62ef576a853b9ae26397291e6d3f.png" width="988" height="563" class="img_MG2L"></p><p><code>vue-cli-service</code>作为第一个必然会被调用的<code>plugin</code>，其功能主要是生成项目模板文件，以及通过<code>serve</code>、<code>build</code>等命令进行开发环境<code>server</code>的启动和生产环境的构建打包等。下面分析其内部逻辑。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="检查-node-版本">检查 Node 版本<a href="#检查-node-版本" class="hash-link" aria-label="检查 Node 版本的直接链接" title="检查 Node 版本的直接链接">​</a></h2><p><code>vue-cli-service</code>位于<code>@vue/cli-service</code>目录下，通过<code>package.json</code>找到其入口程序为<code>bin/vue-cli-service.js</code>，首先依旧是检查 Node 版本。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="初始化service实例">初始化Service实例<a href="#初始化service实例" class="hash-link" aria-label="初始化Service实例的直接链接" title="初始化Service实例的直接链接">​</a></h2><p>传入执行当前命令的目录，也就是创建项目的文件夹，来初始化<code>Service</code>实例。</p><p><img loading="lazy" alt="image-20220122182531357" src="/assets/images/image-20220122182531357-78b52c4632e6658ecd438105d502ba97.png" width="1070" height="62" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="加载项目运行程序和webpack配置项">加载项目运行程序和webpack配置项<a href="#加载项目运行程序和webpack配置项" class="hash-link" aria-label="加载项目运行程序和webpack配置项的直接链接" title="加载项目运行程序和webpack配置项的直接链接">​</a></h2><p><img loading="lazy" alt="image-20220122183108440" src="/assets/images/image-20220122183108440-72ab20bb5ce533e084493d2c3a83be03.png" width="1193" height="673" class="img_MG2L"></p><p><code>resolvePlugins</code>会从上层的<code>commands</code>以及<code>config</code>目录加载进来所有<code>index.js</code>文件。<code>commands</code>目录下包括开发环境执行程序<code>serve.js</code>以及生产环境打包<code>build.js</code>等，<code>config</code>目录包含<code>webpack</code>的配置程序，都是项目运行所需的程序，因为通过<code>@vue/cli</code>创建的项目不会暴露<code>webpack</code>等配置项，所以需要这些程序来执行。</p><p>这些程序被看做<code>plugin</code>，包含一个<code>id</code>作为标识符，和一个<code>apply</code>方法，需要执行的时候调用<code>apply</code>方法即可。</p><p><img loading="lazy" alt="image-20220123135153677" src="/assets/images/image-20220123135153677-b0a37c009668e9268f092aa0b0303ed0.png" width="1108" height="502" class="img_MG2L"></p><p>然后还会对<code>plugins</code>进行排序。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="servejs">serve.js<a href="#servejs" class="hash-link" aria-label="serve.js的直接链接" title="serve.js的直接链接">​</a></h3><p><code>serve.js</code>是开发环境下启动 webpack dev server 的程序，其返回的是一个函数，函数内部通过调用<code>api.registerCommand</code>传递了三个参数，那么<code>serve.js</code>通过<code>plugin</code>的方式注册，肯定会有执行的时候，见下文继续探索。</p><p><img loading="lazy" alt="image-20220122184906777" src="/assets/images/image-20220122184906777-7b136a690c785be22bb44042305178a6.png" width="1090" height="455" class="img_MG2L"></p><p>并且导出的模块还有一个<code>defaultModes</code>对象，包含命令名称和环境变量参数的映射关系，这样<code>Service</code>实例内部可以通过<code>defaultModes</code>获取当前程序执行的环境。</p><p><img loading="lazy" alt="image-20220122184932953" src="/assets/images/image-20220122184932953-5a73d7c98b00074b929a41ec6ddc174f.png" width="969" height="85" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220122190528586" src="/assets/images/image-20220122190528586-466a26f1ee97608e13f7564db5f25d55.png" width="1176" height="79" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="buildjs">build.js<a href="#buildjs" class="hash-link" aria-label="build.js的直接链接" title="build.js的直接链接">​</a></h3><p><code>build.js</code>是生产环境的打包程序，则通过调用<code>api.registerCommand</code>传递<code>build</code>字符串等参数，以及暴露了<code>production</code>的环境变量。</p><p><img loading="lazy" alt="image-20220123153348102" src="/assets/images/image-20220123153348102-0f4299d983852b7d82b439bf404dca0f.png" width="1248" height="494" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220123153415916" src="/assets/images/image-20220123153415916-ad9bdb1df39f7da16f73362aade8838f.png" width="829" height="76" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="cssjs">css.js<a href="#cssjs" class="hash-link" aria-label="css.js的直接链接" title="css.js的直接链接">​</a></h3><p>在<code>config</code>目录下的<code>css.js</code>为例，其通过<code>api.chainWebpack</code>来配置<code>webpack</code></p><p><img loading="lazy" alt="image-20220123200053836" src="/assets/images/image-20220123200053836-fb935aa6c73a39545e4fc24ea291c601.png" width="859" height="137" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="注册命令行参数">注册命令行参数<a href="#注册命令行参数" class="hash-link" aria-label="注册命令行参数的直接链接" title="注册命令行参数的直接链接">​</a></h2><p>初始化完<code>Service</code>实例，加载完项目所需要的所有执行程序，然后会执行<code>run</code>方法，<code>run</code>内部首先会走<code>init</code>方法。</p><p><img loading="lazy" alt="image-20220122185844560" src="/assets/images/image-20220122185844560-17263354ada263fa02bf74bbe8292dbb.png" width="1058" height="108" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220122190940124" src="/assets/images/image-20220122190940124-ae598bec0885903757ed74174031eb3a.png" width="1243" height="676" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="加载env">加载env<a href="#加载env" class="hash-link" aria-label="加载env的直接链接" title="加载env的直接链接">​</a></h3><p>在<code>init</code>方法内部会加载指定环境的<code>.env</code>文件内部设置环境变量参数，这里使用了<code>dotenv</code>和<code>dotenv-expand</code>这两个库来加载<code>.env</code>文件的环境变量到<code>process.env</code>中。</p><p><img loading="lazy" alt="image-20220123153707199" src="/assets/images/image-20220123153707199-86a5c8e3cca465bbd849e346a39c601f.png" width="1100" height="162" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220123160135916" src="/assets/images/image-20220123160135916-030f4402dcc8f19af8921b4bf60662aa.png" width="1062" height="573" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="获取项目配置项">获取项目配置项<a href="#获取项目配置项" class="hash-link" aria-label="获取项目配置项的直接链接" title="获取项目配置项的直接链接">​</a></h3><p>在加载了环境变量参数以后，会调用<code>loadUserOptions</code>方法，<code>loadUserOptions</code>内部会调用<code>loadFileConfig</code>获取项目内部的<code>vue.config.js</code>等形式的配置文件。</p><p><img loading="lazy" alt="image-20220123160527552" src="/assets/images/image-20220123160527552-c708831ddde5c0298cdcde569a2e4b00.png" width="967" height="661" class="img_MG2L"></p><p>然后用户项目配置项会传入<code>loadedCallback</code>函数内部，使用<code>lodash.defaultsDeep</code>和<code>vue-cli-service</code>内部的默认配置合并。</p><p><img loading="lazy" alt="image-20220123161123293" src="/assets/images/image-20220123161123293-a05708786da869852a9fb1ee87cc620e.png" width="1193" height="142" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220123160841575" src="/assets/images/image-20220123160841575-c5fe55dc1fde12dfb7f036b90b788f7c.png" width="887" height="707" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="注入pluginapi实例">注入PluginAPI实例<a href="#注入pluginapi实例" class="hash-link" aria-label="注入PluginAPI实例的直接链接" title="注入PluginAPI实例的直接链接">​</a></h3><p><code>loadedCallback</code>内部会调用每个<code>plugin</code>的<code>apply</code>方法，传入<code>PluginAPI</code>的实例和当前项目的配置项作为参数。</p><p><img loading="lazy" alt="image-20220123160950689" src="/assets/images/image-20220123160950689-ed1f811fac9205c04fc0b5fb39ba8860.png" width="1063" height="507" class="img_MG2L"></p><p>其中<code>PluginAPI</code>在初始化的时候传递了两个参数：</p><ul><li><code>id</code>：<code>plugin</code>程序的名称</li><li><code>this</code>：指向当前的<code>Service</code>实例</li></ul><p>在构造函数内部初始化以后，<code>Service</code>实例会挂载在<code>PluginAPI</code>实例的<code>service</code>属性上。</p><p><img loading="lazy" alt="image-20220123162103664" src="/assets/images/image-20220123162103664-f87c07c90599c259fec378a9d6c90e41.png" width="1095" height="338" class="img_MG2L"></p><p>上文介绍到<code>apply</code>也就是<code>serve.js</code>等构建模块导出的函数，其接收两个参数：</p><ul><li><code>api</code>：<code>PluginAPI</code>的实例</li><li><code>options</code>：项目的配置项</li></ul><p><code>PluginAPI</code>内部定义了一系列方法可以通过<code>api</code>来调用，其中<code>api.registerCommand</code>是往<code>Service</code>实例的<code>commands</code>上注册<code>vue-cli-service</code>的 CLI 命令参数名称<code>serve</code>，不过这里只是注册，并没有开始执行，所以到这里程序的目的只是将构建项目需要的程序加载进来，并且和命令行参数对应起来而已。</p><p><img loading="lazy" alt="image-20220122184906777" src="/assets/images/image-20220122184906777-7b136a690c785be22bb44042305178a6.png" width="1090" height="455" class="img_MG2L"></p><p><img loading="lazy" alt="image-20220123162213927" src="/assets/images/image-20220123162213927-25b82548a14eb155457c2d90364a85da.png" width="1156" height="499" class="img_MG2L"></p><p>后面的话，如果在配置文件中包含<code>chainWebpack</code>和<code>webpackConfig</code>配置项也会挂载到<code>Service</code>实例的<code>webpackChainFns</code>和<code>webpackRawConfigFns</code>属性上。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="组合webpack配置项">组合webpack配置项<a href="#组合webpack配置项" class="hash-link" aria-label="组合webpack配置项的直接链接" title="组合webpack配置项的直接链接">​</a></h3><p>上文说到<code>config</code>目录下的程序会通过<code>api.chainWebpack</code>注册一些 webpack 的配置项，这些配置项会保存在<code>Service</code>实例的<code>webpackChainFns</code>和<code>webpackRawConfigFns</code>内部。</p><p><img loading="lazy" alt="image-20220123200323198" src="/assets/images/image-20220123200323198-5f7f5b514511b9b798bf70231e1c4f84.png" width="1150" height="514" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="执行程序">执行程序<a href="#执行程序" class="hash-link" aria-label="执行程序的直接链接" title="执行程序的直接链接">​</a></h2><p>命令行参数现在和执行程序已经通过<code>init</code>方法关联起来了，接下来便是找到在 CLI 输入的命令参数对应的执行程序，然后执行。</p><p>接着看<code>run</code>方法内部的逻辑。这里通过<code>this.commands</code>找到了和命令行参数<code>name</code>对应的执行程序<code>command</code>，然后便调用<code>command.fn</code>这个方法，也就是<code>serve.js</code>内部传递的回调函数，也就是开发环境启动 webpack dev server 等操作。</p><p><img loading="lazy" alt="image-20220123162926937" src="/assets/images/image-20220123162926937-67e5cb578ecf9bd54a9fc28f5c5b3751.png" width="1045" height="357" class="img_MG2L"></p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[vuecli源码解析(4)]]></title>
        <id>https://willes.github.io/2022/01/23/vuecli源码解析4</id>
        <link href="https://willes.github.io/2022/01/23/vuecli源码解析4"/>
        <updated>2022-01-23T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image-20220122161800174]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image-20220122161800174" src="/assets/images/image-20220122161800174-383f62ef576a853b9ae26397291e6d3f.png" width="988" height="563" class="img_MG2L"></p><p>上文说到通过<code>@vue/cli-service</code>会加载执行文件，并通过插件机制注册命令行参数和执行文件的对应关系，这样在输入特定 CLI 命令参数的时候就能找到对应的执行程序，例如<code>vue-cli-service serve</code>会去执行<code>servs.js</code>程序。</p><p>这篇文章就来分析<code>servs.js</code>在开发环境下是如何构建运行<code>vue</code>项目的。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="获取webpack配置项">获取webpack配置项<a href="#获取webpack配置项" class="hash-link" aria-label="获取webpack配置项的直接链接" title="获取webpack配置项的直接链接">​</a></h2><p>从在控制台打印<code>Starting development server...</code>开始，首先获取<code>webpack</code>的配置项并校验，<code>vue.config.js</code>支持<code>chainWebpack</code>和<code>configureWebpack</code>两种拓展<code>webpack</code>配置项的方式，所以这里都要考虑到。</p><p><img loading="lazy" alt="image-20220123170238131" src="/assets/images/image-20220123170238131-15bab0621732945314912d43da1f2049.png" width="1028" height="132" class="img_MG2L"></p><p>通过<code>chainWebpack</code>拓展的配置项会使用<code>webpack-chain</code>获取；通过<code> configureWebpack</code>拓展的配置项保存在<code>Service</code>实例的<code>webpackRawConfigFns</code>内部，其中还包括上篇文章提到的位于<code>config</code>目录下通过<code>api.chainWebpack</code>插入的 webpack 配置项。</p><p>这些配置项会依次读取并和<code>chainWebpack</code>合并；最后使用<code>webpack-merge</code>进行合并。</p><p><img loading="lazy" alt="image-20220123172545004" src="/assets/images/image-20220123172545004-93ffee406c931c7abcd2b5c134d8e34c.png" width="1277" height="732" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="获取-wds-配置项">获取 WDS 配置项<a href="#获取-wds-配置项" class="hash-link" aria-label="获取 WDS 配置项的直接链接" title="获取 WDS 配置项的直接链接">​</a></h2><p>将通过<code>chainWebpack</code>和<code>configureWebpack</code>内部的<code>devServer</code>配置项和<code>vue.config.js</code>中的<code>devServer</code>配置项进行合并。</p><p><img loading="lazy" alt="image-20220123173807288" src="/assets/images/image-20220123173807288-b30d3c87f66ccbd20f801b081f2d1360.png" width="849" height="131" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="查找可用端口">查找可用端口<a href="#查找可用端口" class="hash-link" aria-label="查找可用端口的直接链接" title="查找可用端口的直接链接">​</a></h2><p>通过第三方库<code>portfinder</code>来查找可用端口</p><p><img loading="lazy" alt="image-20220123174410248" src="/assets/images/image-20220123174410248-760f6b68be89c83696772a54a1d14da2.png" width="1340" height="51" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="获取url和proxy信息">获取URL和proxy信息<a href="#获取url和proxy信息" class="hash-link" aria-label="获取URL和proxy信息的直接链接" title="获取URL和proxy信息的直接链接">​</a></h2><p>这里用了两个<code>create-react-app</code>的库来获取 URL，以及 WDS 的<code>proxy</code>配置</p><p><img loading="lazy" alt="image-20220123175455350" src="/assets/images/image-20220123175455350-95abed9b8f8d40a95dd9dd6f17ef0b71.png" width="1100" height="310" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="隐藏webpack的控制台信息">隐藏webpack的控制台信息<a href="#隐藏webpack的控制台信息" class="hash-link" aria-label="隐藏webpack的控制台信息的直接链接" title="隐藏webpack的控制台信息的直接链接">​</a></h2><p>通过设置 webpack 的<code>infrastructureLogging: { level: 'none' }</code>来隐藏 WDS 的输出信息，设置<code>stats: 'errors-only'</code>让<code>webpack</code>仅在出错时报错。</p><p><img loading="lazy" alt="image-20220123175744041" src="/assets/images/image-20220123175744041-73c278ba2aa9ba2d4bcd4afe0e56ed9b.png" width="1348" height="99" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="创建webpack编译实例">创建webpack编译实例<a href="#创建webpack编译实例" class="hash-link" aria-label="创建webpack编译实例的直接链接" title="创建webpack编译实例的直接链接">​</a></h2><p><img loading="lazy" alt="image-20220123192338019" src="/assets/images/image-20220123192338019-c0439be83cd08e2a2710cb1932ba18bc.png" width="901" height="61" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="创建-wds-实例">创建 WDS 实例<a href="#创建-wds-实例" class="hash-link" aria-label="创建 WDS 实例的直接链接" title="创建 WDS 实例的直接链接">​</a></h2><p>通过 WDS 提供的 <a href="https://webpack.js.org/api/webpack-dev-server/" target="_blank" rel="noopener noreferrer">Nodejs API</a> 来初始化一个实例</p><p><img loading="lazy" alt="image-20220123192020709" src="/assets/images/image-20220123192020709-53af1a918693c6932e85cb37f3e7be64.png" width="1265" height="326" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="注册webpack编译完成事件">注册webpack编译完成事件<a href="#注册webpack编译完成事件" class="hash-link" aria-label="注册webpack编译完成事件的直接链接" title="注册webpack编译完成事件的直接链接">​</a></h2><p><code>webpack</code>的 Nodejs API在初始化以后具有<a href="https://webpack.js.org/api/compiler-hooks/#hooks" target="_blank" rel="noopener noreferrer">Compiler Hooks</a>，hooks 暴露了在 webpack 运行中的每个生命周期事件，可以来注册定期执行的回调函数。</p><p>这里注册了一个在 webpack 编译完成后的回调事件 —— <a href="https://webpack.js.org/api/compiler-hooks/#done" target="_blank" rel="noopener noreferrer"><code>compiler.hooks.done</code></a>，主要是在 webpack 编译完成以后在控制台打印 URL 等一些信息。</p><p><img loading="lazy" alt="image-20220123193247965" src="/assets/images/image-20220123193247965-c1f9a8a0ed31f4b4620cb495bcf7882e.png" width="1331" height="614" class="img_MG2L"></p><p>这里这么做的原因是 WDS 本身的 Nodejs API 比较简陋，只提供了以下四个方法，并未暴露 webpack 编译完成的方法，所以这里需要利用 webpack 的 hooks 来注册。</p><ul><li><code>start</code>：启动 WDS 的异步方法</li><li><code>startCallback</code>：启动之后的回调函数</li><li><code>stop</code>：停止 WDS</li><li><code>stopCallback</code>：停止 WDS 后的回调</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="启动-wds">启动 WDS<a href="#启动-wds" class="hash-link" aria-label="启动 WDS的直接链接" title="启动 WDS的直接链接">​</a></h2><p>通过<code>start</code>方法启动 WDS，可以看到这里最后返回的是一个 Promise 实例。</p><p><img loading="lazy" alt="image-20220123193658453" src="/assets/images/image-20220123193658453-24db6158863fbce8c248c3d1e4876567.png" width="1209" height="200" class="img_MG2L"></p><p>主要的逻辑就是这些，到此，从使用<code>vue create [app name]</code>开始到开发环境执行<code>vue-cli-service serve</code>的整个流程全部分析完毕。</p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[webpack监听代理地址修改自动重启devServer]]></title>
        <id>https://willes.github.io/2022/01/05/webpack监听代理地址修改自动重启devServer</id>
        <link href="https://willes.github.io/2022/01/05/webpack监听代理地址修改自动重启devServer"/>
        <updated>2022-01-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image-20220105213328676]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image-20220105213328676" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAjIAAACyCAYAAABY4yWoAAAREklEQVR4nO3deXCc9X3H8c/z7OpYHZa0unzJhyzb2C4Yy0dsg69AnACxcachMIWk6QDNTEsIBMq0ZVqTENKmUEwnQybTAE1DKFPCtAwGUoiJBRjkA59gSLF8Scay7sM61pL2efrHmonxIe/zrA7/dt+vv/fZfcKMnrz9PL/n+7Nc13UFAABgIHu0TwAAAMAvQgYAABiLkAEAAMYiZAAAgLEIGQAAYCxCBgAAGIuQAQAAxiJkAACAsQgZAABgLEIGAAAYi5ABAADGImQAAICxCBkAAGAsQgYAABiLkAEAAMYiZAAAgLEIGQAAYCxCBgAAGIuQAQAAxiJkAACAsQgZAABgLEIGAAAYi5ABAADGImQAAICxCBkAAGAsQgYAABiLkAEAAMYiZAAAgLEIGQAAYCxCBgAAGIuQAQAAxiJkAACAsQgZAABgLEIGAAAYi5ABAADGImQAAICxCBkAAGAsQgYAABiLkAEAAMYiZAAAgLEIGQAAYCxCBgAAGIuQAQAAxiJkAACAsYKjfQIAktu+dkdHu1z1O1I4w9KCQls5XHkADBHLdV13tE8CQPI53uvq7QZH9b2fv8Sk21Jl2FZloa0M7gkDSBAhA2BItfdJW5ocHeh0Bv1cTtDSkmJLc/JtWSN0bgCSDyEDYEhEotKOFkd72xz1D94wn1OSaWl5ia2ybHIGgHeEDICERF1pb5ujHS2Oegb8f095jqVlJbbCGQQNgPgRMgB8O9Tl6p1GR62nhuYyErSkKwpsLSq0FWJBMIA4EDIAPGuMuHq70VFd9/BcPkIBaWGhrblhW0Fu0AAYBCEDIG5dA1J1k6P9HY5G4spRkB573DQtl5oBcH6EDICL6nOknS2Odrc5OhUd+d+fmGVpeWlApZkj/9sALm2EDIALciXtb3dV3RRVVwILeWeMsTU5W3qvyVX3gL9LjmVJs/NsLS1moB6APyBkAJxXXXdsHUxjxP8lYmzI0opSW+NDsUdD/U7sFe2dLY589owyAtK8sK3KMAP1ABAyAM7Sckra0hjVoS7/l4bctNjalpljzr+2pWsg9hsfd/j/jZygtKQ4oDn5FgP1gBRGyACQJPUM/GGgXTSBuyULC2N3SwJx1EVDxNVbDY4+7fF/GWKgHpDaCBkgxQ040p42R++3OOpNYCHv3AJbS4pthQLej605GduXqaPf/+WoPMfS8lJbBekEDZBKCBkghX3S6WpLk6OOPv+Xgak5llaWBpSfnti5OJJ2tzra3uwo4jOoglYsqBYU2spiQTCQEggZIAXVn96Z+niv/z//oozYQt5JQ/xIJxKVtjY72tPqyO/ZMVAPSB2EDJBCOvqldxsd/d9FdqYeTHbQ0tJiS3+UP7yvDHX0S1UnElt0zEA9IPkRMkAKiESl91sc7fG4M/WZ0mxpfjj22CbNR8O09Ayo0MfznroeV1UNjpoTeA08NlDPVmkmQQMkG0IGSGJRV/qw3dW25qi6ExhoNyfP0lUlAWX7WHdyoCmi9a/UaE9dp+69doruXDre1zl82O4kNlBPpwfqlTBQD0gmhAyQpI73utpU76glgZ2py7Jj62CKM7zfyWjtHdCjvz2q57Z+qjMvM1OKs/WDtRVaVZHv+Ts/G6i3q9X/naUMW6ostLW4iGl6QDIgZIAkVHPS1cZj/t+lzk+PBUx5jr9HMU9V12vDpsPq7Om/4Ge+OKtID321QlPDGZ6/v2tAercxqo8SGKg3Y4ylGyb4eFccwCWFkAGSjONK/1YTVa+PRzChgLS4KPa2j5+E+d2Bdj20sUaHm7rj+nwwYOtbV5Xp3i+WaUyG96hojEhVDVHfA/VuLAv4jjUAlwZCBkgyzRHp2cPeFsQErNj+RYuK/O1fdKg1ovUbD6rq983eD5YUzsnQA1+eqlsXlPo6/uDJ2IRgrwP15uTbWj2OR0yAyQgZIMnUdTt6sTb+BSQzcm0tK7U1Js37b7X1RrVhc61++d4xRaP+X+n+zKzxufr+mulaMiXX87GOK+1u8zZQb2KWdNNkVv4CJiNkgCQTb8icvTO1V89U12vDm0fU3t3n6/jBrJk7Vn/7lakq8zEuuDcqbYtzoB4hA5iPkAGSTDwhc8OEgGZcYGfqi6k62KGHNtboYEOXr+PjlZke0O3LyvSdFWXK9jG4pr1PeuXTqJoGmT9DyADm4+EwkIL8RMyh1oi++cv9+sZTe4Y9YiQp0hfVk28e0bLHduh/9nlfe5OfLpX4eG0cgFn4pwiAQbX1RvXE5lo9W31M/QOJr4Pxqqkzoruf36+n38vX9786TfMn5oz4OQC4dBEyAC7o37fW6/FNw7MOxqu9R9u17smd+tqC8br/S5M1YUyC220DSAqEDIBzNHb168+e/Ugf1raP9qmc48X3j+u1Dxq14ebZun5WwWifDoBRxhoZAOcoyUnTz265TF+5vGS0T+Uc4wtC2nDzLCIGgCTuyAC4gMkFGfr5n87S24fGa/3Gg6o5cXJUzyeUEdRfLC/Td5aXKSPIIl4AMYQMgEEtL8/T5u9W6qnqej3x5hF1jMJ6mXWV4/TA6ikqy2NdDIDPI2QAxOWOJeO0bm6x/uXNWj2/9ZiizvCPoJo5LlcPr/U36RdAamCNDIC4FWUF9Y9ryvXGPQu1pCI8bL+Tl52uR/54pjbdXZlQxERGILYAjC7uyADwbEZxSC/cfrl+83Gr1m+sUX1b75B8b8C2dOviibrv2kkKhxK/PJ2Kc88lAOYiZAD4dt2ssFZftkg/eeuYflp1VL2nvO26faal08N6eE2FZhSHhvAMASQ7QgZAQgKWdM/Kifp6Zal+/MZh/ffOek/HjysI6aE1Fbp+1vA9qgKQvFgjA+Acvf3etyIYPyZN//q1GXr5r+brirK8i34+Mz2o760uV/VfLyJiAPhGyAA4x8OvH9ULuxt9HTtvYo5e/csr9cQts1WYm3Hez6ybN1ZV9y3UvavKFPAxEuaTpl7d8swHvs4PQHLh0RKAc7Se7NN9L9TqF9XH9cO1Far0sVHjn8wt1vWzC/X45lo9/U6d+gcczZ4wRo/cOF0Lyvxt/Ngeieqf3jii56qP+ToeQPIhZABc0Ad1HbrxyZ1aN2+sHryuXGNz0zwdH0qz9eDqKbpt4ThtPdyhmyv9b3nwH9vq9c9vHFZnT7/v7wCQfAgZAOc663HPS7tP6H/3N+uuVZN01wrvj4MmF2RocoG/iHn7UIf+4eUaHWzo8nU8gOTGGhkAcYn0Deix1w9p6aPb9dpHrcP+e7Xtp3Tncx/r1p/vIWIAXBB3ZAB4crytV99+9gMtqQjrkbUVmj7Ec196+h1t2Fynp9+pVf+A97enAKQWQgaAL9U1rbrm8e26dclE3X/tZBVmJX45eXFPkx557aCaT54agjMEkAoIGQC+uZJ+VX1ML+9t1D3XTNadS8f7+p5dx7r09xtrtK+2Y2hPEEDSY40MgIR19vTpBxsPaPmGnaqqiT9Gjnf26bsvfqIbn9xJxADwhTsyAIbM4cYufePpPbpmVrF+8c3Zg372Vzsa9PCrNepJYH8mAOCODIAh9+bHTRf9zJaadiIGQMIIGQAAYCxCBgAAGIuQATA6fGwWCQBnI2QAAICxCBkA5/ibL0/Rl+YUj/ZpXNDY/Ez97LbLR/s0AFwCeP0awDmmFGTomdtmq+pgh9a/XKNDjZfGXkeh9KC+vXKS7l4xUWk2z6YAcEcGwCBWTsvTW/fO1/o105WblTaq57Ju3lj97nsLdd+qsrgjJi+N2AGSHXdkAFzUHUvHa93cEj266aie33ZMrjtyvz17whj9cO10LZyUM3I/CsAY3JEBUtD2ZkdRjzFSlB3Uj2+cpt/es0iLK8LDc2JnKMjJ0GM3zdLrd83zFTF1Pa7qIyNYXABGBXdkgBT0bpOjfe2ulhVbmpnn7d8zM0tC+vXtl+vV/S166JUanWiPDOm5BQO2vnVVme6/ZpKy073/W6u9T3qrIapDXUQMkAoIGSDJ2FZ860JO9rt67birXW2uVpTaGh/ytp7khjmFumFOoTZsrtNPq44q0hf1c7qfs3pOsR68vlzl4UzPx/ZGpW3Njva0Ooo3YeL9bwXg0kXIAEkmK+jt/5xP9Lr6ryNRTc+1tLw0oDEe1/Teu6pMtywYqx/95pBe2n3C28GnTSnO1sNrK7SyIt/zsY4r7W51tL3FUcRjSxVlEjKA6QgZIMkUpEv56Zba+7w9Wjlw0tXBrgFdWWDrC0W2MgPxHzsuN00/+fpM3XH1RP3dSwe0r64jruNyQml6YPVU/fnicZ7O9TM1J1291eCos9/fY6Rp2YQMYDrLdUfy/QMAI6Ex4uqlOkfdA/7+vEMBS18osnRl2Pa1k8Cvdzfqpnklg37mP3c26rrZhSoIeSim0xoisYD5tMf/5Wtxka0lxbzvAJiOkAGSVGe/tKk+qqPd/v/E89ItrSixNS330rhz0TUgbWl09HGH4/s7ctIsLS+xNXPMpfG/CUBiCBkgyR3pdvVOg6PmU/7/1CdmWVpeaqt0lNaU9DuxV8Z3tTka8NkwGQFpXtjW/LAtHy9DAbhEETJACnBc6YN2R9uaXd+PmyRpdp6tq0ps5Yzg6roP21291+T/MZklaXa+raXFI3veAEYGIQOkkEhU2tnqaHero36fdzaCtjS/wNbCIltpw3hno7Y7tg7G5DtJAIYfIQOkoM5+V+82Ovp9p/8//6ygtLQ4oMvzhzYS2vukqoaoDicw0K4g3dKyS2htD4DhQ8gAKay+19XbDY6O9/q/DIQzLK0stTU5wVeZe6PS1iZHe9viH2h3tlBAWlhoa27YlsdxOgAMRcgA0Cedjt5tcj3PnjnTlGxLK8baCqd7KwjHlXadHmh3yudw4KAlzS2wtaDQVhbrYICUQsgAkBR7M2hvm6P3W1z1et1R8gxXFMTms2TFMR7mwMnYHSG/A+0kqTwnNpG4IN33VwAwGCED4HN6BqQdLVHtbXM975D9mXQ79ohnfqGtwHlu0DREXFWdSOyRVklmbB5MGdN5gZRGyAA4r9ZTrt5pdBLaRTo3zdLVJbYuOz18bkgG2gWlJcW25uT7mzoMILkQMgAGVdcdC5qGiP9LRWmmpSk5lna2OPI7xibdlirDtioLbWUw0A7AaYQMgItyJe1vd1Td7KorgfUsfliSZuVZuqokwEA7AOcgZADErc+JvWG0q8XRKf9Ph+I2IcvSCgbaARgEIQPAs64Bqbopqv0drobjClKQbunqEksVuTxDAjA4QgaAb42R2OvTdT1DcxkJBa3YQLsCi4F2AOJCyABI2OGu2ILgFp/7IgWt2PyZRUW2QnHMnwGAzxAyAIZE1JX2tTna3uKqx8OrSeU5tpaVWApncAsGgHeEDIAhFYlKO1pieyYNtsM2A+0ADAVCBsCw6OhztaXJ0Sdn7bCdE7ROD7SzGGgHIGGEDIBh1RBxdaTLVc9A7HXqqTmW0ngZCcAQIWQAAICx+HcRAAAwFiEDAACMRcgAAABjETIAAMBYhAwAADAWIQMAAIxFyAAAAGMRMgAAwFiEDAAAMBYhAwAAjEXIAAAAYxEyAADAWIQMAAAwFiEDAACMRcgAAABjETIAAMBYhAwAADAWIQMAAIxFyAAAAGMRMgAAwFiEDAAAMBYhAwAAjEXIAAAAYxEyAADAWIQMAAAwFiEDAACMRcgAAABjETIAAMBYhAwAADAWIQMAAIxFyAAAAGMRMgAAwFiEDAAAMBYhAwAAjEXIAAAAYxEyAADAWIQMAAAwFiEDAACMRcgAAABjETIAAMBYhAwAADAWIQMAAIxFyAAAAGMRMgAAwFiEDAAAMBYhAwAAjEXIAAAAYxEyAADAWP8P4XaI/1926xUAAAAASUVORK5CYII=" width="562" height="178" class="img_MG2L"></p><p>本文介绍解决监听开发环境代理地址更改后自动重启<code>webpack-dev-server</code>的问题。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>日常开发经常遇到的一个问题是切换 webpack 的<code>proxy</code>地址，需要重启<code>webpack-dev-server</code>或者另开一个终端去创建一个新的<code>webpack-dev-server</code>实例。</p><p>为了简化这个变态的过程，于是探索借助<code>chokidar</code>监听系统文件的能力，来监听<code>proxy</code>配置文件的修改并配合<code>webpack-dev-server</code>的 Nodejs  API达到自动重启的目的。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是chokidar">什么是chokidar<a href="#什么是chokidar" class="hash-link" aria-label="什么是chokidar的直接链接" title="什么是chokidar的直接链接">​</a></h2><p><a href="https://github.com/paulmillr/chokidar" target="_blank" rel="noopener noreferrer">chokidar</a> 是一个基于 Nodejs 的<code>fs</code>模块开发的监听文件的工具，跨平台，同时解决了<code>fs</code>模块提供的原生方法<code>fs.watch</code>和<code>fs.watchFile</code>的不足。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="fswatchfile">fs.watchFile<a href="#fswatchfile" class="hash-link" aria-label="fs.watchFile的直接链接" title="fs.watchFile的直接链接">​</a></h3><p><code>fs.watchFile(filename[, options], listener)</code>用来监听单个文件的变化，其采用轮询的方法，可以指定<code>interval</code>设置轮询时间间隔，默认是<code>5007ms</code>，并且当文件被访问就会触发回调函数<code>listener</code>。</p><p><code>fs.watchFile</code>的主要问题在于采用轮询的方式导致监听不精确，并且 CPU 占用高。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="fswatch">fs.watch<a href="#fswatch" class="hash-link" aria-label="fs.watch的直接链接" title="fs.watch的直接链接">​</a></h3><p><code>fs.watch(filename[, options][, listener])</code>可以监听单个文件或者文件夹，可以通过<code>eventType</code>指定监听文件命名或者修改文件内容导致的变化，但是<code>fs.watch</code> API 跨平台并非 100% 一致，并且在某些情况下不可用，至于什么情况下不可用，官方文档也没解释。在 Windows 上，如果监视目录被移动或重命名，则不会触发任何事件。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="chokidarwatchpaths-options">chokidar.watch(paths, <!-- -->[options]<!-- -->)<a href="#chokidarwatchpaths-options" class="hash-link" aria-label="chokidarwatchpaths-options的直接链接" title="chokidarwatchpaths-options的直接链接">​</a></h3><p>chokidar 解决了<code>fs.watch</code>和<code>fs.watchFile</code>的不足，并且 API 简单易用且监听效率更加高效，使得 vscode 内部的监听文件也使用了这个工具。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="api">API<a href="#api" class="hash-link" aria-label="API的直接链接" title="API的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="配置项">配置项<a href="#配置项" class="hash-link" aria-label="配置项的直接链接" title="配置项的直接链接">​</a></h3><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">chokidar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">watch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'file'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 是否持久化触发监听事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">persistent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 忽略监听的文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">ignored</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'*.txt'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当设置为false时候，在 chokidar 初始化完成之前新增文件或者文件夹也会触发 add 和 addDir事件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">ignoreInitial</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当设置成 false 时，只有 symlink 本身会被观察到变化，而不是跟随链接引用和冒泡事件通过链接的路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">followSymlinks</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 监听文件或者文件夹的相对根目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">cwd</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'.'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当设置成 true 的时候，会忽略 glob 模式的path设置，把它们当成文件名的一部分</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">disableGlobbing</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 当设置成 false，使用 fs.watchFile 或者 fs.watch 监听文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">usePolling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 针对 fs.watchFile 设置的轮询间隔</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">interval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">binaryInterval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">300</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">alwaysStat</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 设置多少层的子文件目录会被递归监听</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">depth</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">99</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 默认情况下，add事件将在文件首次出现在磁盘上时触发，此时还没有写入整个文件。此外，在某些情况下，在写入文件时将触发一些更改事件。在某些情况下，特别是在监视大文件时，将需要等待写操作完成，然后才能响应文件的创建或修改。将awaitWriteFinish设置为true(或true值)将轮询文件大小，保持其添加和更改事件，直到大小在可配置的时间内不变。适当的持续时间设置在很大程度上依赖于操作系统和硬件。为了准确的检测，这个参数应该相对较高，使得文件监视的响应更少。谨慎使用。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">awaitWriteFinish</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">stabilityThreshold</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">pollInterval</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指示是否监视没有读权限的文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">ignorePermissionErrors</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 监听更为细节的控制，如果一个文件在被删除后的100毫秒内被重新添加，Chokidar会发出一个change事件，而不是unlink然后添加。如果默认的100毫秒不适合你，可以通过设置一个自定义值来覆盖它，以毫秒为单位。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">atomic</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="监听事件">监听事件<a href="#监听事件" class="hash-link" aria-label="监听事件的直接链接" title="监听事件的直接链接">​</a></h3><p><code>chokidar.watch</code>返回一个对象，可以使用该对象的<code>.on(event, callback)</code>方法设置监听事件<code>event</code>和回调函数<code>callback</code>，<code>event</code>类型如下：</p><ul><li><code>add</code>：新增文件</li><li><code>addDir</code>：新增文件夹</li><li><code>change</code>：文件内容变化</li><li><code>unlink</code>：删除文件</li><li><code>unlink</code>：删除文件夹</li><li><code>ready</code>：扫描文件或文件夹结束，开始监听</li><li><code>error</code>：监听程序报错</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="wds-的-nodejs-api">WDS 的 Nodejs API<a href="#wds-的-nodejs-api" class="hash-link" aria-label="WDS 的 Nodejs API的直接链接" title="WDS 的 Nodejs API的直接链接">​</a></h2><p><code>webpack-dev-server</code>提供 <a href="https://webpack.js.org/api/webpack-dev-server/" target="_blank" rel="noopener noreferrer">Nodejs 的 API</a>，也就几个：</p><ul><li><code>start</code>：启动 WDS；</li><li><code>startCallback</code>：启动并指定启动完的回调；</li><li><code>stop</code>：停止 WDS；</li><li><code>stopCallback</code>：停止并指定停止后的回调】</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="实现思路">实现思路<a href="#实现思路" class="hash-link" aria-label="实现思路的直接链接" title="实现思路的直接链接">​</a></h3><p>在 WDS 提供的 Nodejs API 的基础上，我们利用<code>startCallback</code>回调注册<code>chokidar</code>监听文件的程序，当检测到<code>proxy</code>配置的文件变化后，<code>stop</code> WDS 并重启一个新的 WDS 实例。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// server.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token maybe-class-name">Webpack</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'webpack'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> </span><span class="token maybe-class-name">WebpackDevServer</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'webpack-dev-server'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> webpackConfig </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'./webpack.config.js'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> proxy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'./proxyConfig'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> chokidar </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'chokidar'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> compiler </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:rgb(80, 250, 123)">Webpack</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">webpackConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">WebpackDevServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token spread operator">...</span><span class="token plain">webpackConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">devServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  proxy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> compiler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">createServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">WebpackDevServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token spread operator">...</span><span class="token plain">webpackConfig</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">devServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    proxy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> compiler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">startCallback</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> watcher </span><span class="token operator">=</span><span class="token plain"> chokidar</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">watch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'./proxyConfig.js'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'change'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">"checked dev-server proxy changes, restarting server"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      server</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">stopCallback</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        watcher</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">close</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">createServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">createServer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// proxyConfig.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string-property property">"/api"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">target</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"http://127.0.0.2"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后开发环境的情况下使用我们的<code>server.js</code>程序替代 webpack 的 cli 命令，即<code>node server.js</code>，这样就可以了。</p><p><img loading="lazy" alt="image-20220105224129440" src="/assets/images/image-20220105224129440-a325a3446ec18500d614f10086a749a3.png" width="987" height="334" class="img_MG2L"></p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[个人网站迁移]]></title>
        <id>https://willes.github.io/2022/01/04/个人网站迁移</id>
        <link href="https://willes.github.io/2022/01/04/个人网站迁移"/>
        <updated>2022-01-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[image20220104221756]]></summary>
        <content type="html"><![CDATA[<p><img loading="lazy" alt="image_20220104221756" src="/assets/images/image_20220104221756-cfc5beff3e5457b7afc1d90da027fbd9.png" width="853" height="287" class="img_MG2L"></p><p>新年伊始，将个人网站从 dumi 迁移到了 docusaurus。</p><blockquote><p>地址：<a href="https://icodex.me" target="_blank" rel="noopener noreferrer">https://icodex.me</a></p><p>仓库：<a href="https://github.com/wood3n/icodex-next" target="_blank" rel="noopener noreferrer">wood3n/icodex-next: blog (github.com)</a></p></blockquote><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2><p>过去一年多的时间，我都在用 dumi 构建自己的前端知识体系文档，期间升级过很多次 dumi 的版本，也看着 dumi 从 200 多 star 逐渐增长到 2k 多 star。</p><p>过去选择 dumi，主要看中的是 dumi 对于在线文档的交互能力，因为有时候学习一个新的知识点总想着用 demo 的方式去实现，尤其是 CSS 这种的。而 dumi 提供的交互能力恰好可以满足我的这一个需求。同时配合 Typora 编写 markdown 文档十分的方便。</p><p>不过同时我也注意到了 docusaurus （这个取自<code>document</code>和<code>saurus</code>组合词的名称真的太难记了）这个文档生成工具，不过一年前这个工具还比较稚嫩，提供的能力不太全面，所以就放弃了。不过随着越来越多的网站开始使用 docusaurus，我也开始了迁移之路。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="迁移步骤">迁移步骤<a href="#迁移步骤" class="hash-link" aria-label="迁移步骤的直接链接" title="迁移步骤的直接链接">​</a></h2><p>docusaurus 提供脚手架工具直接生成站点项目代码，这里直接利用脚手架来创建。</p><div class="language-bash codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-bash codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">npx create-docusaurus@latest my-website classic --typescript</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>生成的项目目录如下：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">my</span><span class="token operator">-</span><span class="token plain">website</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── blog</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── </span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">28</span><span class="token operator">-</span><span class="token plain">hola</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── </span><span class="token number">2019</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">29</span><span class="token operator">-</span><span class="token plain">hello</span><span class="token operator">-</span><span class="token plain">world</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   └── </span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span><span class="token number">30</span><span class="token operator">-</span><span class="token plain">welcome</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── docs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── doc1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── doc2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── doc3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   └── mdx</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── src</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   ├── css</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   │   └── custom</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">css</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   └── pages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       ├── styles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">css</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│       └── index</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">static</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">│   └── img</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── docusaurus</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">package</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── </span><span class="token constant" style="color:rgb(189, 147, 249)">README</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">md</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">├── sidebars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">└── yarn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">lock</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="插件和预设能力">插件和预设能力<a href="#插件和预设能力" class="hash-link" aria-label="插件和预设能力的直接链接" title="插件和预设能力的直接链接">​</a></h3><p>docusaurus 提供插件和预设的配置，类似于 babel，webpack 这些工具的能力，使用 CLI 指定<code>@docusaurus/preset-classic</code>预设会同时包含至关重要的三个插件：</p><ul><li><code>@docusaurus/plugin-content-docs</code>：提供文档编写能力，对应生成的<code>docs</code>目录</li><li><code>@docusaurus/plugin-content-blog</code>：提供博客渲染能力，对应生成的<code>blog</code>目录</li><li><code>@docusaurus/plugin-content-pages</code>：提供普通前端页面的渲染能力，对应生成的<code>pages</code>目录</li></ul><p>这三种插件的配置都在<code>docusaurus.config.js</code>这个文件下，对于我个人需求来说这三种能力都需要，因此我都开启了，如果不需要的话，直接在<code>presets.docs|blog|pages</code>设置成<code>false</code>即可。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="修改主页指向">修改主页指向<a href="#修改主页指向" class="hash-link" aria-label="修改主页指向的直接链接" title="修改主页指向的直接链接">​</a></h3><p>我希望将个人博客页面作为站点主页，那么需要在<code>docusaurus.config.js</code>将<code>blog</code>对应的<a href="https://www.docusaurus.cn/docs/api/plugins/@docusaurus/plugin-content-blog#routeBasePath" target="_blank" rel="noopener noreferrer"><code>routeBasePath</code></a>设置成<code>/</code>，同时指定博客文档所在的目录<code>path</code>；这样其他在<code>docs</code>或者<code>pages</code>就是相对于<code>blog</code>的路由路径。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// docusaurus.config.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">presets</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">"classic"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">blog</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// blog作为主页</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">routeBasePath</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"./blog"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token spread operator">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">pages</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"src/pages"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// 指定 pages 的路由路径，因为 blog 作为主页了</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">routeBasePath</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/pages"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token spread operator">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="顶部导航栏配置">顶部导航栏配置<a href="#顶部导航栏配置" class="hash-link" aria-label="顶部导航栏配置的直接链接" title="顶部导航栏配置的直接链接">​</a></h3><p>顶栏无非就是 Logo，导航栏这些，对应 docusaurus 提供的主题配置项的<a href="https://docusaurus.io/docs/api/themes/configuration#navbar" target="_blank" rel="noopener noreferrer"><code>navbar</code></a>。</p><table><thead><tr><th>配置项</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>title</code></td><td><code>string</code></td><td><code>undefined</code></td><td>顶部标题</td></tr><tr><td><code>logo</code></td><td><code>object</code></td><td><code>undefined</code></td><td>顶部 logo</td></tr><tr><td><code>items</code></td><td><code>NavbarItem[]</code></td><td><code>[]</code></td><td>顶部菜单导航</td></tr><tr><td><code>hideOnScroll</code></td><td><code>boolean</code></td><td><code>false</code></td><td>是否在页面向下滚动时自动隐藏导航栏</td></tr><tr><td><code>style</code></td><td>`'primary'</td><td>'dark'`</td><td></td></tr></tbody></table><p>导航菜单通过<code>items</code>配置，docusaurus 提供 5 种菜单配置类型：</p><ul><li><code>type="link"</code>：默认形式，配置<code>to</code>或者<code>href</code>指定菜单点击跳转路由；</li><li><code>type="dropdown"</code>：下拉菜单导航</li></ul><p><img loading="lazy" alt="image-20220104231019549" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANMAAAEMCAYAAABeGIOXAAAgAElEQVR4nO2df3RU1bn3v0DQgq7V6zKDpBrzAwiIIEmoBQkI3ttCQgSnEFNrbdUYoEUGoVHkwsu69y4XaaDijwxwr5By+2r7ViB2TWOTGbxr3YYGKEgzQ41YpTEQBzrIUL3vatG3CJz3j3POzD5nzu/ZM5NMns9akzln73322TPZ3/M8e58z+xkmCIKADJHBUxNEjGHDhnGpJ4dLLTYhEREDCbk/Jiuq4TwaYwcSEjFQSbZvplVMJCRioJNMH02Lm5dpEWX6/IQzeI1l7OLU7RuWigmIdHdeEsvQJN1iMzsfVzGlq1OTeAgt0iUuvfNwE1OqOjgJh0iGVAlMq14uYuLd4TMlIBJuesjUWIj3edX1JSUmXp2PrBphRDqtSzL12BLTQLRAJJihDQ9B8BKVpftMgiBw7bTJ1Ccfy7tNevVbe0Xxq1UTULhqP6KOjh+Er74OTOp6FVv69MuEgq9iUlcHQswxd3S9ii190pd94bdY0fUqVpyMcPt/JVNHspiKiWeHjbbV4fbCcSgo+hGCRgUj+7GiaDwKin6EbiCpL6vbOwGFxYmv7SHtDuAUQQDAXdsh7BhXgh+8eZF3xeZEu/D9Q6/hjtirFa3R5KsVpL+CICi+Ll4XyGTqsXxcZB9WFI7DijblF2J405a3NRKZi8qFP8GRE/+M8lLtstHjAQTiBzo8D0sd3vhwPcqlvYtvLsPdSycAb/wJT+q0wR65eGD7KTzAoyqWSC96kBKVGhI9uR/3fvo5Hv/K9/AfxXJqD7Ye60LUNQcuyE0SDJtWWvZd/JFNEGJ/YvuCxucz6nd2XDK2HrvHOXH9dC0Tz8kFuS7x73gsrJyLH+/eD/WFTiwbxOtPAU+vnQuj/5Sea6FRMiEld1EjXqoCnm+JtyHjbpPWi2l++s4bwcG/fg6MLsUzRWz6FDzztdnITWibg8+j/j/Z6GrW/+/6x9k5jx00xcRDSEaNue2rlajsCOBwJLFs9M0deH7tk/hWoZQnpiaMSWSib9ajaFw9fqXjdguC/GK//FzcNlHuCwIE4QLaPCUo8rQi+OtlKBonbstCi8ppsVeTyk2N4lce5TEAgEgrfsAep85nj1WVCW4vQVHFBgQABJ6ahaJxJfjBmxz8LFOi+PALK+XYC6TIidBrmHzoNUwO9TD7fpzQOEYUl2B6sTj5t7/ovt5jXif/ehEn/3rRkghSJaoEN4+XkLQzpPe8B7H8h/+MJa1BPLCqjCkQxZEDB/H0Ey3A2VhlEJCLWfPnAmsCOLyhBg/kKctjzV4sHiskXPASTxw/LvwBgInjkMuW6NiApRP3oq93V+zcwR0TsfTFOrzRuwtyS0M7JmLpuA/x0qFdWDxWdR75Cny+FStnbwReOoy++3MBXETb6gp8zSPg7eYa8bxSmcDavehrlvzN861oCwlY/OQH6Fsar2Pn/bnG3y03clE8UgAuhbC1bwqeKdIpFnPzxO/94nutePiSgHtv+gb+ffLYuFggCwcYJrDHMu8GpunDz/4vnv3gUGKGhhe2pWQOJt94c+ycsaI6LpsdN9CK66ewTCkVkrIQymc/AbxwQHmFD7XgKTTiW6WJvnjuV+djgXAQ/t9H41euSCf8HUDD7DJYQT4uuL0Cazrm4qWlpVKaXKIOrewg6sQWLH0ReLr1WbBnKHvydTTgINa0huSaIbv+siVt27wRgarN+Lf7ZbnmYnFdHdDxFo5ElGWOseccW4PFpfFqVRtpYCyWfq0UjwnAT8+9hjsPBRjLokJu1ukA5n7yeUxIinxBXVxMjLl90pem54YtchWhqWS29rmZ15aS2Vg8Rlv5Vq2VGWwZrdLDtQo6wbaPWfoEXl74E+xiXJfuQ3tQOX8ecgEwX7X4PrYGy9YCgQOdkOe2or8/gMDCRtSqJhES/HTswdJxJSgePxHF40VL09rLWhVJBVXjkM/UEzy0B0AdZibUX4p71gD44EPJ7WT7vQAhchB+P7Bg/tz4GEMQINwyDgtwEOGPBQjCWYS1yqjaLg8x0jdmEsdHT1c8gs6bRgGI4juHXsOdx7oSpv0BQPisC98/FwVuKFUKKf5tsV+cshfG9hMnINjXIlchmkoqNOoW2VIyG4tcRabjIrM+atlFTPxkADj9BMOq6pXycGHWgrl46kAnovfXIPd8K3a9eC+qDuUyxyHuNgEon10HvHhAcvVEF69yfqPYGXVPDgB1aO19FmWC8h8rqIuxbpqcVlWMfI36BQDw9+IjALnMEfI4DAAOrJ2NcWs12hSOAmN68S6AKbflahRgv4B469JN7uSleBdA9L1W3Pfpacw7/Df8rKIS8WuLgP/96WkALvysdEpCP5B3BfV3zXgDcW/R2OVa5BKtzvpTSpevqWQ2FmlYJKP65Dwz98/ujN5w9Ynt4NR8ygPQ3PtX4umODdh7QpwOP7D2STyQxx6j+udMW4CncRCB30chRDoR6JiLyunKzqg9y2PWTsZ8q4/1f4iPNK7eAERLpnAToRBjw/4/ovdU4mtHdVx+756NJtSttKranyudr9w7lqInLxcQovgv5iYtBODRvFI8KkTxyCE/TiR8R7L7K6eBuUBANrmJ/2eddtyfW4imCRUx165pQqJF0uxvJulGlkw7Q7uM41/aWjKHuo2R08twz1oBz3c1Ye9TB9FQURq3YkK8bLyuUsxcI7p6wd+/hUDVfNwz1uSLRGI9iS+N8gDKZj0O4D/xu4RBQwi/ewlY8I17pQkMIWbZBAAYey8WVAHbDoXUB8aRyhx4q1Njhk/1PTm82HHlhhsxRzNjCp6eUIg5uIhH3j6k+CyCZHYSRhrqi4WOG6vF/a4i/KikAj8qqcD9rkJbInEiHGODIcTKAA7F5MQaMedWUL60EQte/Ame1xj7aB1StnQzFvgPYPeBg2ioWwrWLmn+QwTtehLLI3aljKVNexwvVAIv1G5BkEkP7ngYL+AxPFGdyxwrvwQIQi4WPf4Y8PLDWPlrdsKkFStXt0pjD6mMfxPu2RFSlGk7IW2PHYc7ARzoP5tGS9SDHx9qxRsXlOknzp1Gl5CLrxcqvy9BECC4KrAjLxe4fBr/GOoxtUwCc29Ka8xk9P8UBAGLXEUxt09dTq8OszSjdDnPCEEQ7I+ZnApJr/EYOw9VCwHMnwuXUTmZsXNRWbURa/2Po77ZQnvkv+yV0LS8TC4Wvfwebt05GbUTfxpPrnwOR95fwozV4nXHrrh3PYNTe4GSb92LCT9kjntpCW5my3SOw6p5D2PCy2wZ2VpOw/f3PoYXviXmz992ENurDcZYXLgTDbMEbDvyM9x1ikkePQ1/mDWF+R5ZFxpA4Xy8gwO4688ncNfhs3i1ojImlETLBCZFeXVXozVuYcvqjYfUeXK6WZqcrndeNj2w+h4UrGbaeu3aNcs+BC8hmQrGMC2KN5+ag7UTf4HelaWGZa22L3mieHPNPDSU/BynVnJ5PmlIY2Xgr/trV60f7TlMs3MOgOOCKk4FYrvM+YMI+O/FC+tLLYtXD37iOouzAWD+129NoWCzFyProlfOzAKx6Vatktry2LVclsVk1EmciMaZ0KJoa/xfOPDU/8H2sYJBOePzGOFEDBc7XsGLmIPny28mMZlg5rYZlVeXU4tFr7wdUVkRmV6aJTGlWkhW9kM7J6P2ZYhjipXaVomnqMzruYhf//A+PHMAAObgx/+9E9W3KGcGhyJWHsuxU49WeSMRWbFMVq2SXUFZGjPZnlTgtO90rGWUbpbHi2yzUOlYt8HoHMmMkRQd3mRcZHefTTMVU6qElIyIrIjMKN1qPpEeTNejsygkO/s8BSenGYqJl5B45PGcEXRShuCP01m7ZKxRqgQGGFimdAvJqYh4WSmrZYjk4Tn17dQa8RYbwEFMPCxLqgVmlu60HGEPq+MuHkJKlYgMy2mJyalVstv5B7KgnJYnlNiduMikkJKu06qYeAjJbHsgCorElBx2xJRuIfGyZLqzeU7cO6eWJ9XispNmBAnKGTysklkaT/Eka7kUN22djpPM8qwKZcSIEcjJycGIESPScl+DGDoIgoCrV6/iypUruHr1KgQhfsNV3tZKU9eh1y8FQVBapmStklVLoyWo66+/Hjk5GQmxSwwxrly5gr///e+xfbXlceoGmq4BkWohCYJAQiLSSk5ODq6//npLfVPGyrbhjwOdDOjtCiknJ4eERKQdud/xEJSM4zUgzI6x2kgSEpEp5L5nR1BayPlJR1s3m1wwOkYQBIwYMSLZJhCEI0aMGOGoz6rTZIbzmAo3SzNqMM3aEZlCq+9Z6bN6aUlZJjsC0nqn+zdEpmH7oRN3z3QCgodV0sq3alIJIt04HSexcF03z46SSVDEQMFOfzUqYytyIC+3jgRFDBTs9FOz/psgplR0cCczfgSRLqzM1Fkh55NPPtGt3O62elJBT+Xs9pe//GXbjSYIXnzyySeKx4e0HilSPz6k97hRzujRoxWVG6nTrvnTExBZJ2KgMGrUKF0xmT2zp37Pue6662IVW5nFM7NIdoREYiIyzciRIw1FZCSgBDENHx4fNqmFovU4OisG9rF1tUjUeeptthEEkSnk/i+Lw6rLp/Vua2rcydy73hjKSn0EkWrs9k+jPusoDKfdO8NG7iNBDAScPqjAvtu6z2S3USQoYjBgVUhmfdbS40R2G2S0TW4eMZCw2j+t9FvLYya9CqwIIl1Wqbu5GPnNwZTUnUCoEfkFxbHX8jbdYJoWCMKbdB1EMjjpo5pPQDgZL5nlmTVuUE+NhxqR7+6F92gfwv3ia8WZZ+GLpLMRogC9BmFzCXO0+qHd8ZOM45+5OjGHg1pAMaLw7W5BlfcY3Hnx1Omr92C64zrL4env49A2Ihm0btkY3SJSb9taAyKZBvKu1xKRfViu5YpJ6cqrehS+lXE3MdpWx7hxdQlWx38mbOvc8rmibXXIX7kP3XL9zUEkWJlQI/ILGtGtU4eYX4OtALa6tdtH2INHP+X240C7Fin1VioK335gs+SGhY82AZ4ZYofMuw8Lq4GeMDNGifwGHe3z4H2wHIjsw+vYEnPhgl7AM7MR3QAAF9zL6oFtNfrjs8g+LJ+5HlN9cTdwVngfYmdrX49X5PpXl+u0vwXu55j2++qx1S2JpmwDwv2tWAdgna8P4f49CitJWMdq37TS11P21HhGLRIAwAX36lq45F2FgFyoqJwHf+A3sQ4ePR6Av7oSFXkA8mrhWeyK13R3JarQi7B89S/bgLBPEpTGuKV7/3r4G1rhKYunTV/MtAX1WMHUr808eDcxx5Qtg7e6Ex3HaZIilSTTby1ZJis3abXS9RqWPlGJ7pPoJs2Apz2e47q7ElXtARyOAEAUhwOdqKq8L9552dm6mevhV1ddtgHh/j74GiRXa6VseYI4sg1YN0fP4gCoHo/bTds+HvkKa+NC/iQL7iXhCL1+aXWWz9JNWyuNcHryVIiqqjBf3Ijsw/KCGiDmah2Dt5opmHcfFspXesnFW3i3KKVoWx3y3YCPcRGrdM43fbWU374eG2lqe9Bh1A/t9m3d1Yl4kh5LFEX4fWBqviSI4wH4q5vwUJle+bir1308AH/DKmncIVkp7zLrs3N5tVjRIO/kI189HnME41ZCbFf4feZiQaQUJ31W1zIlc+8pI+5daDc87fWYxYqnvRcfSZvRtmcVbh4gu3q9OHKmM8Eti7tTUfieY928KHwrVbNnkX14ZZssZHGCwi9PdsjHNDMTEJbohOe5+DFi+xPHWsmLlmBJxt3juqCKlXzeoopNYbt74T26IWZNXIu3wFvdArc07tmIVUo3D5AsSgu2bmNF6IJ7UxOqpMmF/IJngWWsm+eCe+cW4LliZkwVwMKjffEJB2mCQpy2lup4kJ2AsEI9fMt6US6do9wzHr7+DYy1LMdD3nnwe2bQ1DgH7Lh7evnDrly5ImhlaE3/sSdUp1nZ13rdcsst9j71UCDUKI3ZNiRxI5iwwscff6z4LZPWC9D/vZPu75mMzJuTKcPB/7QDMdSx08eTns1LtjEEMVCx23e5hqBI9zR41lK2AeH+TDdi6KL1jB6bp7fcQsotk7ohJCpioJJs/+QuJiuNIVERAwmr/dGsDPcnINJ1LEHwgGf/TYmbRyIhsg0rfdqRmEgsBKGEy4OuRpUTRDbA9ScYvE5GENlC0s/m2RUNiYwY7Njpw9zWzSOIoU5ab9oSRDbjaK1xLehRIiKbcPKTDMNn83iKQO8nGASRSfT6oJNwR+TmEQQnSEwEwYm4m3fajzvOXQQgAAKAkYU4+LXZyI3lBzD1nLTegCBg9k1fx447mF/JXjwMz6l+HBIEQBCA0Xfh+F2TTU5/AQCtnkhkBzkAEAq+im9fysUvZn8XpZD8yNN+TD7Rg5OlUyH0+THlz3/Dv5U8giUuMf9E6A38MroE38wFEBWFVJT3MJoLxbFQ9I+/xEtnJuOpAoOzf9QD5E1LywcliFQh/8YpJ3pyPx7+zIVfzK5EKVuiqAonBQFABL+MXsScm/4JS5gVQaaVLsE0iEboD3/ux6EbpsFbJO4DQO6kb2KNIEB/juEC3rz4FyxPxacjiAwwfM+nn+Oxr1QphaRB198v6mcKAnD5f2BQIpH+HjR9McrOEQQxoBneh1EYd6NRkTwsceUCn53A1BPvapaYdmshZn/Rj28cP2xRUO/Be/4v9ltLEAOYnN/iRnx/DMRJBz2KKvEuAphy7gSmHj6B7+V9Bw2FTL6rAl5BgOdPZzD/yBlU/MN9eHmS/hJePT3v4vXRN+Pbly7x+hwS76CpK4Q9sf1R2DyxFg+Okfcj2H/0LWz8ItZw7J2zEPF1K83yiaEOnzUgiirRU/EIXhsNvPrnn2Ha24eVK5S6KtB8z8N466Yv4fCn/42v/u4tvKNZ0cc4g9vRNpXzLF5fB0q6QsCtj+LUHPk1CR9+0AFxYVVJKNeVxfMn3oidQbmVZvkEYcywJzr3CMVf+R7WFWkvOqn5fqELK0+dAf7hn7D9jls0Fp7swQtH3sHPR03F23dN1nn64SS8R/+Eze4VyX+KC7/Fsg9OY9ytj2J9sU6Zvg6UnIO+pTHLJ7KSSCRiugil0QKUikUof3AD8NMLXfYmD1yzsXy0UYEp+O5NX3L6+WwTOnsaB28o0xdSjL+h90Iy+QShz/DSsjI8duU05hxTCeq0H3ee6AEQwS/ffgNvsJ0segi7PgOKRo0FAPzhxM/xwhn24Hfx2qf/D7OuvznlHwCIoPcyMPd6k5W8i8uweeTn2PjBPuzXEoxZPkGYEFtrXLxxC8SegLihFCdLpwAABCGCN479F/5FHpgLX8K/TliCb7riD7D+4cTP8egl6VhBwHfyvo01BUbrjPNy88RJBxi5eDGYCYaRRTg8817VYvpm+US2wdPNi4lJb6F+vXe9hfm10gaOmCSkMdZBAHVax5nlE1kD1zFT5j7GZKyasZhDPS6MGwns+R8bs25j7sXuOY9i7w3AnnPybJ+NfILQIAueGs/Dg2NcwKX3bY91ym4rwtwk8gmCJQvEBKB4IfbeoDV58A6auiTL0teBEtU9o9DZ0zg48kbcZiWfIEzI4JhJfOXlcbx529eBknPsrWTVEwzq/BvKcKr8Lv3j1flE1pElExApEBNB2CRLJiAIIrsgMREEJ0hMBMEJEhNBcILERBCcIDERBCdITATBCRITQXCCxEQQnCAxEQQnSEwEwQkSE0FwgsREEJwgMREEJ0hMBMEJEhNBcILERBCcIDERBCdITATBCRITQXCCxEQQnCAxEQQnSEwEwYnBL6ZQI/ILinVedfBF0tGIKHwr2fM2ojuZ2trqkq6DSD+DX0xlGxDu7xNfvnoA9fDJ+/174E75GpdR+FbOgGdSa7wdR8fjleZgqk+sJNRIAswwOZluwKAntBue9nr4dpbH0/JqsWu18ypdi/cgzCNACJFWBr9lMiKyD8sLiuFVxYTpbi5GfnMQsnu2vC0qpslu2sp9yuDXkF0vPTeuF2ETd1L7ePn8wZib6A1JZWNtMG9jd3Mx8t0tAFrg1mk/kXqyW0x592FhNbC1i3W5gjiyDVg3J25J/J4ZODJHdg2PwYv1KGfctO7mYpQHKhGU3LigtxduucOWLYO3uhOemfrjs2hbHco94xn3sxLhtnh393u2A5vEPI9OdGqjNk5frXJxd9ZSxMMMkN1iggvuZfXAtkDckoQC2FrdhIfYTtvQynRi1TGRfXhl2zx4N8U7qGvxKqxrD+BwRCq/85gkKC2rEMTrnk6s823A9FhaOdyLme7esMp8bGfURmJAkOViAlBWiXVowRHJ1evuakFV5X2KK3dVYb7ymLHjUSW7bud74YcklJibVoOt6ET4vHyAC+6dfQgfbUJV+3qUs65lKICtqMcsHYujeX4rZdg2EgOCITABUY5ZDYC7KwjP2F68sm0eFh616wTVw9fPWhYd8mqxq78W3c3FcLsbMcvKMUTWkP2WCcD0B5tQtS0A3/EA/Boulf9MWJlwvhd+jEd+HiQLELdsls8n73CyIIZtJAYEQ0JM4kRECzyeTsXEQ4xtNcyMXxBedwuqvMtEq5JXixUNwFY3O4MXhFceG4UapZnBON3718NfPR63x47vhGcmc3xkH7xtNufbjNoYg9y+TDIE3DwAcKGich6ASuXEg0SVtxX5u4uR3y7vH8MuZoJg+upj8L4/A+6CFilFdPtcgHjTGI3IL6iJV9jQijBz32n66j74UBw/vroJwZ0uwMYEtlkbxVnFGfDMLIanuglBmtFLO0MkDKf4lEJHpaoD6qYPJAZDGwcvFIbTLtJTCiuoMxIpJLvFJD0Bke/uhfcozawRqWWIuHkEoQ25eQQxACExEQQnSEwEwQkSE0FwgsREEJwgMREEJ0hMBMEJEhNBcILERBCcIDERBCdITATBCRITQXCCxEQQnCAxEQQnSEwEwQkSE0FwgsREEJwgMREEJ0hMBMGJ7BCTVvRACqtCpJnsEBMAZcRAKeRKmgSljKdEDFWySEwsUsiV9l58lOmmEEOGLBWTNsbR/4Lwsm6iRkzaxMh9YlS/ck8nIIWS0TqOGBpkqZii8O1WLmxvGP0PQHdzALNibmIr1m2rwXJmcf3u5mK432+KHR/eBBwOiXGZgt554vrh/X0Ir9YIDEAMCbJo4f4WZmH9efAe7cMueX1LOfrfUVX0P892HI7Uwp0HTF+9galLjOm09UwYgEvzeOTVpiGSOzGYyCIxyQHJxIXuPfuDcMtWQor+559ZDI/qqHXnAeQB8gL5nnYms0F8ix4PwF9dic0kHsKALBKTjAvuTU3omFkD7xw24LJR9L8gvAU16PEeQ3inaHu6m4vhTk+DiSwhO8dMcoCy3dKYyCz6nxR3Vi9Khit/PM0MEqZkp5gghcJsX4+NbVHz6H8AFFH3Qo1wb2MqK1sGb3WLYsICoUYmkh9IbET2ikkWkN/zLHwRKfpfdQvcsenvAGbJ0fXKNsDXwERU76qEr4GtzAX3TulGcEG8jOxCuhavwjpIddPU+JCFQsoQQxoKKUMQAxASE0FwgsREEJwgMREEJ0hMBMEJEhNBcILERBCcIDERBCdITATBCRITQXCCxEQQnCAxEQQnSEwEwQkSE0FwgsREEJwgMREEJ0hMBMEJEhNBcILERBCcIDERBCdITATBCRITQXAiO8QkRw7UDDgmhorx6q3maoPuZvvr4mkFQlOEpimogy+iezgxiMgOMcnIK7gOYBJC0/SvQvg5ijqYDWSRmOqxrgHwe3argpgNIOTQNJuY0DQoh2cnu08MVrJITMCsB5tQhRa4LbhiSldLyw0UowLK+cs1LZ4y2qB2GTWdCJ+3UIwYdGSVmJBXi83eecC2GoMxkigShat1tAk9blZQUqwmxMtsxrPKxfwj+7C8oAbwxaMNTvXMMB6bxQII8BnDEQOL7BITANfiLfBWqyNeMIR2w9OucrUkEcZC0ER+gw5VGbleme796+FvaGXiP5XjIe88bO0ytorTV/fBJwkqMa4uMZjJOjHJwc6q0IJXNNyuaLgXqK5EhSpeABuDSY4UqCzjQv6kWC0Ivw9gW43CVSz3dALv95pOJkxfLcXNlSJnWHMPiYFOFkYOhGRpAij3PAvf3atSdpoq7zHs0gmQpmDSeI0JhnJ4+vvwUFud1M49FCN3kJOFlklEdMs64XluO3rYdJ0ogKLFGo/bdcsEcSQ2ZhKtlD/wG1Mr9NGZTlQV5hu0cxXWWftIxAAna8UUc/faO+Fnk7WiAEb2YaOnE+uWycHPKkUXjJkV7G6uwVamGkVkQoloW51yYkGaCl94tyu2v1x1Azfath1bMR75ZJUGPdnp5slI7p7f08kkilEAsXIGygvWS2nz4D3ax7hZ5fD0twIFNciXrFGV9xh8DTPiQaPzarHL14t89wzke+JldpVBfCLD3QIAWOdj6s2rxa5N+7C8oDgu8OomBPvpPlM2QJEDiSENRQ4kiAEIiYkgOEFiIghOkJgIghMkJoLgBImJIDhBYiIITpCYCIITJCaC4ARXMcl3gwkiWzHq42SZCIITJCaC4ASJiSA4YUlMWn4ijY8IQkTWAlkmguAEiYkgOEFiIghOGP5sfdiwYYpf4CYDjbGIgYjRL2rtErNMyXZ2veOTaRxBZAqjfquXTm4eQXBCU0xkSQjCPrYsk12RkSiJwY6dPszFzSPREEMNrT6fsjFTWgUmh+EsSGF4y1Ajhcwcoljty45WdOU5Zc6Pevj6N2B6pptBDEmGDRuWmuWRB6bYkqRsA8L9mW4EkSmsWKek3bxk3Ln0uIJipMDlbVFl6M2EUJ3KsJv5zUFldPVQoyI4WSyKusLFTAxeFm2rc5gvR4mXQ32Si5kKePZf7mMmK43LxI1cv2cGjsyRQmb66lWhOhPDbgYLtyvDbmrRvh7lXZWxMJyJkTOKUR6ojNfp7VVE3zDLB4Ct7gBm9fch3E/xm1KF1f5oViatN+xwhHEAAAQ3SURBVG1TKyIxCl/sKq/qlGBDZpYtg7ca6AlLJSyE3dSmHr7V5dK2GIYzFjlQI7K6a/EqrGsP4HDEQr5ElXcZjQPTRLL9k+uYSW+sJDcwteMo4wkIo4BjctjNzbphN3WQgqNpcr4XfnTCP7MYHlXWuvMAYJIvtWVqPgWbSTdOHiUC0hCfKSsnIyxjIPCQST6RcexaKYWbZ/SLWie/th0sN3PNw246YOx4VKEFR0IO84kBgZ0+bnvM5MT86ZUfMGKzEHbTNnm1WNEAbHWrZujksZxZPpEWnPRDvfKO3Twz9y3946cWuAtaFCnrfH3xSQdD9MNuvmIw1jJj+upj8L4/g2mX6Na5LOYT6cPpOInNj4XhlOERjlO9bxSec8yYMTY+cjoRp8vDy6wKkhiMXLhwwXa4Ta19ABieDldrwLhzugThVd1Q7W6eAU97PWaRkIYkTvps0rN5anfObJ9NHziUw3O0l6KgD0HsuHem+1evXhW0XDu9bSMXj9226u65XNRdicwRjUaTdu/k7YTZPF4WgxauJAYjyfTbpB4nYk+ity3vW0kjiHRjtW9a6euGYuLR2clCEYMBHv3UsWWyolSyRsRgwqlFik2NqzOsnNBKnpWZEBIWkWnMBKTeN+qzli1TMo8RmTWWIDKNkz6qLsNt3Tyr5tCqygkiHVjtn1b6rallSuYhQDtuH0FkCifjJC0crTXO3qzSO5aERAwm7I6TtDTAdUVXK6JS7w/dHw4SmUYQBNvDEEcTEHaVaZan1+grV67oNo4gUonc96yMlaz0c9Nf2upVYFax3jHq7cuXL5uekyBSweXLl22Nj4z6OJCG5ZHNGnv58mUSFJF22H7nxCppYflxIqOTmL0bHT9s2DBcunSJBEWkjcuXL+PSpUsK945HX0/4PVMqJgXYOuVtddqlS5fwxRdf4LrrrkNOTg7N+BFcEQQBV65ciVkkMwvk6F7r1atXE5SjFpPR75q00qz+zN1umpV3o22tfb00J2WIOE7H33bv+dh5TybN6F3e5rqgitrqWCmjdxyLVp1OrhxGdRN8sfqd2p2wUm+bCczOEMTKpINRGU0xqUWg1fGNyuvVZ1VIVkWjVS4V4iDBOYOHdbJiqZJ9N8uz2u6k1oCwY530RGK1rBOrRCLILOl29bTSnLp/Ru+6bbt27ZqgZ1WSHTtppTkZD9ktY9Reo8+nB42XnJEKV08vz4nVsSMsK2lcVycyGitpHWPV4jixTmSVMg8vMan3rVqqVLh1RiLPkRPtXn2TEYyTyQar4ydi4JAqMbH7qRSWbaFdu3ZNAPRdGauuk9l2Mq6cWZrRtp3Ppge5ec5IRkxa6U6sk1ZasqLTrUMWE5A5QdnNM9q2sq+XpgeJyRl2PIVkrJPeNi9BWd1OyZhJva0uq3bbrMz2WUVdnty/zJGsmLTS7XZwp4Kye04A+P/hnf3vObturwAAAABJRU5ErkJggg==" width="211" height="268" class="img_MG2L"></p><ul><li><code>type="docsVersionDropdown"</code>：文档版本下拉菜单</li><li><code>type="localeDropdown"</code>：文档多国语选择下拉菜单</li><li><code>type="search"</code>：搜索框，需要配置<a href="https://docusaurus.io/docs/search#using-algolia-docsearch" target="_blank" rel="noopener noreferrer">搜索引擎</a>才可用</li></ul><p>同时顶部默认是提供网站夜间和白天主题的切换按钮。</p><p>我觉得唯一的不足就是不支持自定义菜单项的<code>icon</code>，例如需要显示 GitHub 链接，需要自己在<code>src/custom.css</code>里进行样式覆盖：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">href</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://github.com/wood3n/icodex"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">position</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"right"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// custom logo in custom.css</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">className</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"header-github-link"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token string-property property">"aria-label"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"GitHub repository"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-css codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-css codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">/* GitHub Link */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token selector class" style="color:rgb(255, 121, 198)">.header-github-link</span><span class="token selector pseudo-class" style="color:rgb(255, 121, 198)">:hover</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">opacity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">0.6</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token selector class" style="color:rgb(255, 121, 198)">.header-github-link</span><span class="token selector pseudo-element" style="color:rgb(255, 121, 198)">:before</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">content</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">""</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">width</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">24</span><span class="token unit">px</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">height</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">24</span><span class="token unit">px</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">display</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> flex</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">background</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token url function" style="color:rgb(80, 250, 123)">url</span><span class="token url punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token url string url" style="color:rgb(255, 121, 198)">"data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12'/%3E%3C/svg%3E"</span><span class="token url punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    no-repeat</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token selector" style="color:rgb(255, 121, 198)">html</span><span class="token selector attribute punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token selector attribute attr-name" style="color:rgb(241, 250, 140)">data-theme</span><span class="token selector attribute operator" style="color:rgb(255, 121, 198)">=</span><span class="token selector attribute attr-value" style="color:rgb(255, 121, 198)">"dark"</span><span class="token selector attribute punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token selector" style="color:rgb(255, 121, 198)"> </span><span class="token selector class" style="color:rgb(255, 121, 198)">.header-github-link</span><span class="token selector pseudo-element" style="color:rgb(255, 121, 198)">:before</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">background</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token url function" style="color:rgb(80, 250, 123)">url</span><span class="token url punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token url string url" style="color:rgb(255, 121, 198)">"data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='white' d='M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12'/%3E%3C/svg%3E"</span><span class="token url punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    no-repeat</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="文档侧栏菜单配置">文档侧栏菜单配置<a href="#文档侧栏菜单配置" class="hash-link" aria-label="文档侧栏菜单配置的直接链接" title="文档侧栏菜单配置的直接链接">​</a></h3><p><code>docusaurus</code>默认是会渲染在<code>blog</code>文件夹下的<code>.md</code>或者<code>.mdx</code>文件，对于<code>src/pages</code>目录的任何文件都会渲染成页面，而对于<code>docs</code>目录的 markdown 文件可以通过<a href="https://docusaurus.io/docs/api/plugins/@docusaurus/plugin-content-docs#sidebarPath" target="_blank" rel="noopener noreferrer"><code>sidebarPath</code></a>来配置生成不同的侧边菜单栏。</p><p>如果使用脚手架创建文档站点，ducusaurus 会默认生成一个<code>sidebars.js</code>文件，包含下面这个默认配置项：</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">mySidebar</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'autogenerated'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">dirName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'.'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>默认情况下，在<code>docs</code>目录的 markdown 文件会全部显示出来，不会自动归类，而我的需求是能够根据我在 <code>docs</code>目录下创建的文件夹进行分类，并自动生成每篇文档的路由地址。来看一下 docusaurus 提供的能力 —— <a href="https://docusaurus.io/docs/sidebar#understanding-sidebar-items" target="_blank" rel="noopener noreferrer">Sidebar | Docusaurus</a>，对于侧边栏生成的类型有以下几种：</p><ul><li><code>type="doc"</code>：配合<code>id</code>指定单个文档的标题和链接</li><li><code>type="link"</code>：配合<code>href</code>指定任意跳转链接</li><li><code>type="category"</code>：配合<code>items</code>指定分类包含的文档</li><li><code>type="autogenerated"</code>：配合<code>dirName</code>自动生成侧边栏</li></ul><p>看起来<code>type="category"</code>可以满足我的需求，但是每篇文章写完我都要配置一下侧边栏这也太麻烦了，于是我尝试了下<code>type="autogenerated"</code>这个自动生成的，<code>dirname</code>配置成在<code>docs</code>下创建的目录名称就可以自动对该目录下文档进行分类，再配合顶部导航栏的<code>docId</code>指向每个文档分类下的第一篇文章，点击以后就会自动打开不同目录下归类的文档列表。</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// sidebars.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> sidebars </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">javascript</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"autogenerated"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">dirName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"javascript"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">typescript</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"autogenerated"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">dirName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"typescript"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">css</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"autogenerated"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">dirName</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"css"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// docusaurus.config.js</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">module</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">themeConfig</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">navbar</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">items</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"dropdown"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">label</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Skill"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">position</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"right"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token literal-property property">items</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"doc"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token literal-property property">label</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"JavaScript"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token literal-property property">docId</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"javascript/类型/类型定义"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token spread operator">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="图片目录">图片目录<a href="#图片目录" class="hash-link" aria-label="图片目录的直接链接" title="图片目录的直接链接">​</a></h3><p>对于图片的处理，我这边没有选择图床，直接复制到指定目录下，docusaurus 提供<a href="https://docusaurus.io/docs/static-assets" target="_blank" rel="noopener noreferrer"><code>staticDirectories</code></a>配置项用于指定静态资源目录，默认是<code>static</code>文件夹，对于<code>static</code>文件夹的文件，全部都会在构建以后复制到网站根目录下。</p><p>而对于<code>staticDirectories</code>没有包含的文件目录，包括 markdown 中引用的图片文件等，都会在构建后复制到网站根目录的<code>assets</code>目录下(图片的话就是<code>assets/images</code>)，并且会对路径自动进行转换。利用这个能力，我在网站代码根目录下创建了<code>public/images</code>目录用于保存所有在 markdown 页面包含的图片，配合 Typora 复制图片并转换图片相对路径的能力，就可以做到在任何地方打开 markdown 都能正常显示图片。</p><p><img loading="lazy" alt="image-20220104234147642" src="/assets/images/image-20220104234147642-b31d2a03bc13cec3ef839326a9a0e17b.png" width="763" height="272" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="网站部署">网站部署<a href="#网站部署" class="hash-link" aria-label="网站部署的直接链接" title="网站部署的直接链接">​</a></h3><p>网站部署不用多说了，依旧白嫖 GitHub Pages，docusaurus 也提供了集成 GitHub Actions 自动部署的配置参考 —— <a href="https://docusaurus.io/docs/deployment#triggering-deployment-with-github-actions" target="_blank" rel="noopener noreferrer">Deployment | Docusaurus</a>：</p><div class="language-yaml codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-yaml codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">branches</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">main</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">paths</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">website/</span><span class="token important">**</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">jobs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">deploy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">runs-on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ubuntu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">latest</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">steps</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/checkout@v2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> actions/setup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">node@v2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">node-version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 14.x</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">cache</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> yarn</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Build website</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          yarn install --frozen-lockfile</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          yarn build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># Popular action to deploy to GitHub Pages:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)"># Docs: https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-docusaurus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> Deploy to GitHub Pages</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">uses</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> peaceiris/actions</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">gh</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">pages@v3</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">with</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">github_token</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> secrets.GITHUB_TOKEN </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token comment" style="color:rgb(98, 114, 164)"># Build output to publish to the `gh-pages` branch:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">publish_dir</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./build</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样在使用 Typora 写完文档或者博客以后，直接<code>push</code>到 GitHub 仓库，触发 GitHub Actions 完成自动构建打包和部署，一气呵成，妈妈再也不用担心我写博客时候手忙脚乱的部署了。</p><p><img loading="lazy" alt="image-20220104235311387" src="/assets/images/image-20220104235311387-593105280aa6fcb8c8ef3c0114dfb600.png" width="1108" height="528" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="网站全局搜索">网站全局搜索<a href="#网站全局搜索" class="hash-link" aria-label="网站全局搜索的直接链接" title="网站全局搜索的直接链接">​</a></h3><p>docusaurus 优先提供支持 Algolia 的能力，使用起来也很简单，分为三步：</p><ol><li>首先在<a href="https://github.com/algolia/docsearch-configs" target="_blank" rel="noopener noreferrer"><code>algolia</code>仓库</a>提交一个配置网站索引的 pr；</li><li>等 PR 合并以后在<a href="https://docsearch.algolia.com/apply/" target="_blank" rel="noopener noreferrer">DocSearch</a>网站提交网站的域名和联系邮箱获取<code>appId</code>和<code>apiKey</code>；</li><li>在<code>docusaurus.config.js</code>完成<a href="https://docusaurus.io/docs/search#connecting-algolia" target="_blank" rel="noopener noreferrer">配置</a>即可</li></ol>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[webpack代理配置]]></title>
        <id>https://willes.github.io/2022/01/03/webpack代理配置</id>
        <link href="https://willes.github.io/2022/01/03/webpack代理配置"/>
        <updated>2022-01-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[devServer]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="devserver">devServer<a href="#devserver" class="hash-link" aria-label="devServer的直接链接" title="devServer的直接链接">​</a></h2><p><a href="https://webpack.docschina.org/configuration/dev-server/#devserver" target="_blank" rel="noopener noreferrer"><code>webpack-devServer</code></a>，一般简称<code>WDS</code>，是 webpack 内置的用于开发环境的服务器配置。<code>webpack</code>本身提供三种方式用于开发环境修改代码以后自动编译，以提高开发效率：</p><ul><li><p><a href="https://webpack.docschina.org/guides/development/#using-watch-mode" target="_blank" rel="noopener noreferrer">观察模式</a></p></li><li><p><a href="https://webpack.docschina.org/configuration/dev-server/#devserver" target="_blank" rel="noopener noreferrer">WDS</a></p></li><li><p><a href="https://webpack.docschina.org/guides/development/#using-webpack-dev-middleware" target="_blank" rel="noopener noreferrer">webpack-dev-middleware</a></p></li></ul><p>总体来说，WDS 配置最容易，并且提供 HMR 的功能，只需要配置<code>devServer.hot: true</code>就直接启用，方便到了极致！下面就重点看一下 WDS 的<code>proxy</code>配置。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="http-proxy-middleware">http-proxy-middleware<a href="#http-proxy-middleware" class="hash-link" aria-label="http-proxy-middleware的直接链接" title="http-proxy-middleware的直接链接">​</a></h2><p><code>webpack</code>的 WDS 内置的<code>proxy</code>功能来自于<a href="https://github.com/chimurai/http-proxy-middleware" target="_blank" rel="noopener noreferrer"><code>http-proxy-middleware</code></a>这个第三方工具，正如我以前看到的一句话所说，<strong>开源最重要的不是贡献自己的代码，而是把别人的拿过来用</strong>，从开源社区的发展角度来看，这的确是核心，只有开源带动开源，才能让社区氛围更好。</p><p>废话不多说了，来看一下<code>http-proxy-middleware</code>都有哪些配置吧。</p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="配置">配置<a href="#配置" class="hash-link" aria-label="配置的直接链接" title="配置的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="url">URL<a href="#url" class="hash-link" aria-label="URL的直接链接" title="URL的直接链接">​</a></h3><p>在了解详细配置之前，先来回顾一下 HTTP 协议下 URL 的构成：</p><p><img loading="lazy" alt="image-20201220170902676" src="/assets/images/image-20201220170902676-f6c233de87de8e8dd1d8cd84f4bd3c8c.png" width="1297" height="366" class="img_MG2L"></p><p><code>http-proxy-middleware</code>本身融合了<code>http-proxy</code>的一些配置，但是文档配置写的比较抽象，并且多数配置实际开发的时候根本用不到，这里重点关注几个比较重要的属性。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="target--string">target | string<a href="#target--string" class="hash-link" aria-label="target | string的直接链接" title="target | string的直接链接">​</a></h3><p><code>target</code>用于指定代理转发的目标域名，在 WDS 中可以按照如下设置，这样当本地请求<code>localhost:3000/api</code>的时候，就会被 WDS 转发请求<code>https://xxx.com/api</code>去</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token literal-property property">devServer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">proxy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">"/api"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">target</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://xxx.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="router--objectfunction">router | object/function<a href="#router--objectfunction" class="hash-link" aria-label="router | object/function的直接链接" title="router | object/function的直接链接">​</a></h3><p><code>router</code>和<code>target</code>有点类似，也是重定向转发域名的，区别是<code>target</code>只能设置一个<code>string</code>类型的域名，<code>router</code>可以指定多个域名转发的映射对象或者函数，并且会覆盖<code>target</code></p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token literal-property property">router</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">'integration.localhost:3000'</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http://localhost:8001'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// host only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">'staging.localhost:3000'</span><span class="token plain">     </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http://localhost:8002'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// host only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">'localhost:3000/api'</span><span class="token plain">         </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http://localhost:8003'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// host + path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">'/rest'</span><span class="token plain">                      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http://localhost:8004'</span><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)">// path only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function-variable function" style="color:rgb(80, 250, 123)">router</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">req</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http://localhost:8004'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="pathrewrite--objectfunction">pathRewrite | object/function<a href="#pathrewrite--objectfunction" class="hash-link" aria-label="pathRewrite | object/function的直接链接" title="pathRewrite | object/function的直接链接">​</a></h3><p>重写本地请求的 URL 中的<code>path</code>部分，设置的<code>key</code>字符串会被构造成一个正则表达式来匹配请求的 URL，需要注意的是只会重写<code>path</code>部分，前面的<code>host</code>以及后面的<code>queryString</code>都会保留下来和重写后的域名进行拼接。</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token literal-property property">devServer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token literal-property property">proxy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string-property property">"/api"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token literal-property property">pathRewrite</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string-property property">"^/api"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/newApi"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// rewrite path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function-variable function" style="color:rgb(80, 250, 123)">pathRewrite</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">path</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> req</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> should_add_something </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">await</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">httpRequestToDecideSomething</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">should_add_something</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> path </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"something"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> path</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="changeorigin--boolean">changeOrigin | boolean<a href="#changeorigin--boolean" class="hash-link" aria-label="changeOrigin | boolean的直接链接" title="changeOrigin | boolean的直接链接">​</a></h3><p>因为<code>http-proxy-middleware</code>依赖于<a href="https://github.com/http-party/node-http-proxy" target="_blank" rel="noopener noreferrer">node-http-proxy</a>实现的，<code>changeOrigin</code>这个参数是从<code>http-proxy</code>中直接拿过来的，找到<code>node-http-proxy</code>的源码部分，可以发现如下有关<code>changeOrigin</code>的实现 —— <a href="https://github.com/http-party/node-http-proxy/blob/9b96cd725127a024dabebec6c7ea8c807272223d/lib/http-proxy/common.js#L99" target="_blank" rel="noopener noreferrer">changeOrigin</a>，用到的地方在这里 —— <a href="https://github.com/http-party/node-http-proxy/blob/9b96cd725127a024dabebec6c7ea8c807272223d/lib/http-proxy/passes/web-incoming.js#L126" target="_blank" rel="noopener noreferrer">Request initalization</a></p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">// requires-port是判断指定端口在当前协议下是否要求添加在 host 后面，如果是协议默认的端口就不用添加，例如HTTP默认80，会返回false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">var</span><span class="token plain"> required </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">require</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'requires-port'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">changeOrigin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  outgoing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">headers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">host</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">required</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">outgoing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">forward </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'target'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">protocol</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token operator">!</span><span class="token function" style="color:rgb(80, 250, 123)">hasPort</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">outgoing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> outgoing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">host</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">':'</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> outgoing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">port</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> outgoing</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设置<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Host" target="_blank" rel="noopener noreferrer"><code>request.header.host</code></a>到底有啥用呢？首先在 HTTP 1.1 的时候要求必须设置这个请求头参数，因为部分网站的部署是<a href="https://en.wikipedia.org/wiki/Virtual_hosting#Name-based" target="_blank" rel="noopener noreferrer">基于域名</a>的部署方案，也就是一个后台服务器的 IP 地址绑定多个域名，这很容器做到，只需要在域名管理机构的 DNS 解析处添加域名解析规则即可。</p><p>基于域名的部署方案取决于支持 HTTP 1.1 的浏览器能够在请求域名绑定的 IP 地址的时候发送<code>host</code>这个请求头参数，以标识当前请求的是什么域名，不然即使是不同域名，服务器接收到的都是相同的 IP 地址，仍然无法区分。</p><p>但是基于域名部署的方案最大问题是难以托管多个 HTTPS 的网站，因为在建立正式的 TCP 连接前，需要通过 TCP 进行一段 SSL/TLS 的握手过程，来验证双方身份，这边还没发送<code>host</code>呢，SSL/TLS 已经开始了。TLS 提供了一种拓展方法 <a href="https://en.wikipedia.org/wiki/Server_Name_Indication" target="_blank" rel="noopener noreferrer">SNI</a> 来保证握手开始前将请求域名发送到服务器，这样就可以让服务器明确知道对方是谁，发送什么样的证书给它。</p><p>所以在请求<code>https</code>协议的网站时，一定要配置<code>changeOrigin</code>这个请求头，不然就会出现以下错误：</p><p><img loading="lazy" alt="image-20201220183752961" src="/assets/images/image-20201220183752961-ac88f19c0ed885ee8f28336829e6e548.png" width="1528" height="130" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="实践">实践<a href="#实践" class="hash-link" aria-label="实践的直接链接" title="实践的直接链接">​</a></h2><p>比如现在本地我要把知乎专栏《阿里妈妈前端快爆》的内容抓取下来，首先看一下请求是啥，大致是这个地址：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token maybe-class-name">Request</span><span class="token plain"> </span><span class="token constant" style="color:rgb(189, 147, 249)">URL</span><span class="token operator">:</span><span class="token plain"> https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token plain">www</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">zhihu</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">com</span><span class="token operator">/</span><span class="token plain">api</span><span class="token operator">/</span><span class="token plain">v4</span><span class="token operator">/</span><span class="token plain">columns</span><span class="token operator">/</span><span class="token plain">mm</span><span class="token operator">-</span><span class="token plain">fe</span><span class="token operator">/</span><span class="token plain">items</span><span class="token operator">?</span><span class="token plain">limit</span><span class="token operator">=</span><span class="token number">10</span><span class="token operator">&amp;</span><span class="token plain">offset</span><span class="token operator">=</span><span class="token number">10</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20201220190635496" src="/assets/images/image-20201220190635496-ce518376dd77ce63b470736c0e7c21df.png" width="1762" height="628" class="img_MG2L"></p><p>那么我本地<code>webpack</code>的 WDS 可以这样配置：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">proxy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">"/api"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">target</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://www.zhihu.com"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">changeOrigin</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">pathRewrite</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string-property property">"^/api"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"/api/v4/columns/mm-fe/items"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">// rewrite path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请求的地址是<code>/api?limit=10&amp;offset=20</code>：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">fetch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'/api?limit=10&amp;offset=20'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">response</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">myJson</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">myJson</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样就可以成功转发请求获取数据了，可以看到这样一种重写 URL 的方式首先根据<code>/api</code>匹配请求 URL，如果包含则使用<code>target</code>定义的路径重写<code>host</code>，最后根据<code>pathRewrite</code>重写 URL 中的<code>path</code>部分，得到最后的 URL 为：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token constant" style="color:rgb(189, 147, 249)">URL</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> target </span><span class="token operator">+</span><span class="token plain"> pathRewrite </span><span class="token operator">+</span><span class="token plain"> queryString </span><span class="token operator">+</span><span class="token plain"> hash</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20201220191120749" src="/assets/images/image-20201220191120749-266030d23e5f99d7221b31cf2f2b24f4.png" width="1117" height="442" class="img_MG2L"></p><p><img loading="lazy" alt="image-20201220191129915" src="/assets/images/image-20201220191129915-bd95fefd135eb578ecc8cf13a4cfa359.png" width="1127" height="469" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="通用配置">通用配置<a href="#通用配置" class="hash-link" aria-label="通用配置的直接链接" title="通用配置的直接链接">​</a></h3><p>在实际使用过程中，针对<code>pathRewrite</code>这样配置：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token literal-property property">proxy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token string-property property">'/api'</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">target</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'http://localhost:3000'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">changeOrigin</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token literal-property property">pathRewrite</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token string-property property">'^/api'</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'/'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这样在项目中请求的 URL 都是这种形式，以达到通用性：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">fetch</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'/api/xxx?name=xxx'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">res</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">json</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">res</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">log</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">res</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[meta标签]]></title>
        <id>https://willes.github.io/2022/01/02/meta标签</id>
        <link href="https://willes.github.io/2022/01/02/meta标签"/>
        <updated>2022-01-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[head]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="head">head<a href="#head" class="hash-link" aria-label="head的直接链接" title="head的直接链接">​</a></h2><p><code>head</code>标签是在 HTML 的根元素<code>html</code>里的第一个标签，它的内容如下：</p><ul><li>允许包含一个<code>title</code>标签，表示文档的标题，显示在浏览器的标签栏上；如果时<code>iframe</code>则可以允许不包含<code>title</code>标签</li></ul><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">title</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain">My test page</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">title</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>最多只能包含一个<code>base</code>标签，给页面上所有的 URL 相对地址提供一个基础路径，因此它会影响全局的链接地址。<code>base</code>是一个非常危险的标签，容易造成跟 JavaScript 的配合问题</li><li><code>meta</code>标签</li></ul><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">base</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">target</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">_top</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">http://www.example.com/</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>link</code>标签，规定了当前文档与外部资源的关系，例如标识<code>favicon</code>，<code>css</code>等静态资源</li></ul><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">link</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">rel</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">icon</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">favicon.ico</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">link</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">rel</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">stylesheet</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">my-css-file.css</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>style</code>，即直接指定的<code>CSS</code>样式表</li></ul><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">style</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token style language-css">    </span><span class="token style language-css selector" style="color:rgb(255, 121, 198)">h1</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token style language-css property">color</span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token style language-css color">red</span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token style language-css">    </span><span class="token style language-css selector" style="color:rgb(255, 121, 198)">p</span><span class="token style language-css"> </span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token style language-css property">color</span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token style language-css color">blue</span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token style language-css punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token style language-css"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token style language-css">  </span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">style</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;/</span><span class="token tag" style="color:rgb(255, 121, 198)">head</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>script</code>标签，但是一般不会至于<code>head</code>中，如果要放在<code>head</code>中一般需要使用<code>async</code>来异步加载资源</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="link-标签">link 标签<a href="#link-标签" class="hash-link" aria-label="link 标签的直接链接" title="link 标签的直接链接">​</a></h2><p><code>link</code>一般用于指定网页的<code>favicon</code>和<code>css</code>资源，其具有以下属性：</p><ul><li><p><code>crossorigin</code>：指定在加载相关资源时是否必须使用 CORS，例如图片加载，它的值可以是以下两种:</p><ul><li><code>"anonymous"</code>：会发起一个跨域请求(即包含 <code>Origin:</code> HTTP 头)，但是不会发送任何客户端信息（<code>cookie</code>，<code>HTTP Authorization</code>请求头），如果服务端没有设置<code>Access-Control-Allow-Origin</code>响应头，则资源会被限制访问</li><li><code>"use-credentials"</code>：发起跨域请求的同时发送认证信息，如果服务端没有设置<code>Access-Control-Allow-Origin</code>响应头，则资源会被限制访问</li><li>如果未设置<code>crossorigin</code>，那么图片会被禁止在<code>canvas</code>等元素中使用</li></ul></li><li><p><code>rel</code>：表示外部资源和当前 HTML 文档的关系，它的值可以是<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Link_types" target="_blank" rel="noopener noreferrer">链接类型</a>中指定的值，例如常见的有：</p><ul><li><code>stylesheet</code>：<code>CSS</code>样式表文件</li><li><code>alternate</code>备用资源，可以是<code>CSS</code>，或者一份<code>HTML</code>，例如更换主题的网页可以使用<code>alternate</code>备用一份<code>CSS</code></li><li><code>icon</code>，HTML 文档的<code>favicon</code></li><li><code>preload</code>：指定预加载资源，可以配合使用 <code>as</code> 来指定将要预加载的内容的类型，具体见<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Preloading_content#%E5%93%AA%E4%BA%9B%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%86%85%E5%AE%B9%E5%8F%AF%E4%BB%A5%E8%A2%AB%E9%A2%84%E5%8A%A0%E8%BD%BD%EF%BC%9F" target="_blank" rel="noopener noreferrer">哪些类型的内容可以被预加载？</a></li><li><code>prefetch</code>：建议浏览器提前获取链接的资源，因为它很可能会被用户请求</li></ul></li><li><p><code>href</code>：外部资源的链接地址，可以是绝对路径或者相对路径</p></li><li><p><code>type</code>：指定链接内容的 MIME 类型，最常用的就是<code>text/html</code>，<code>text/css</code></p></li></ul><div class="language-html codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-html codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">link</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">rel</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">preload</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">as</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">font</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">type</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">font/woff2</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">crossorigin</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">/static/media/ZillaSlab-Bold.subset.0beac26b.woff2</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">link</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">rel</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">alternate</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">title</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">&lt;head&gt;标签里有什么? Metadata-HTML中的元数据</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">https://developer.mozilla.org/zh-CN/docs/learn/HTML/Introduction_to_HTML/The_head_metadata_in_HTML</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">hreflang</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">zh</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">link</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">rel</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">alternate</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">title</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">What’s in the head? Metadata in HTML</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">https://developer.mozilla.org/en-US/docs/Learn/HTML/Introduction_to_HTML/The_head_metadata_in_HTML</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">hreflang</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">en</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&lt;</span><span class="token tag" style="color:rgb(255, 121, 198)">link</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">href</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">/static/css/main.d00647ab.chunk.css</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag" style="color:rgb(255, 121, 198)"> </span><span class="token tag attr-name" style="color:rgb(241, 250, 140)">rel</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(248, 248, 242)">=</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag attr-value" style="color:rgb(255, 121, 198)">stylesheet</span><span class="token tag attr-value punctuation" style="color:rgb(248, 248, 242)">"</span><span class="token tag punctuation" style="color:rgb(248, 248, 242)">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="meta-标签">meta 标签<a href="#meta-标签" class="hash-link" aria-label="meta 标签的直接链接" title="meta 标签的直接链接">​</a></h2><p><code>meta</code>标签是一组键值对，是一种通用的元信息表示标签，也就是描述当前 HTML 文档的除了<code>link</code>，<code>title</code>等无法表示的信息。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="name-和-content">name 和 content<a href="#name-和-content" class="hash-link" aria-label="name 和 content的直接链接" title="name 和 content的直接链接">​</a></h3><p><code>meta</code>可以由<code>name</code>和<code>content</code>两个键值对组成，<code>name</code>和<code>content</code>属性可以一起使用，以键值对的方式给文档提供元数据，其中<code>name</code>的值作为元数据的名称，<code>content</code> 的值作为元数据的值。</p><p>HTML 规范中定义了以下标准的元数据名称，可以指定给<code>name</code>：</p><ul><li><p><code>application-name</code>：网页中所运行的应用程序的名称</p></li><li><p><code>author</code>：文档作者的名字。</p></li><li><p><code>description</code>：一段简短而精确的、对页面内容的描述。一些浏览器，比如 Firefox 和 Opera，将其用作书签的默认描述。</p></li><li><p><code>generator</code>：生成此页面的软件的标识符（identifier）。</p></li><li><p><code>keywords</code>：与页面内容相关的关键词，使用逗号分隔。</p></li><li><p><code>referrer</code>：控制由当前文档发出的请求的 HTTP <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referer" target="_blank" rel="noopener noreferrer"><code>Referer</code></a> 请求头。</p></li><li><p><code>theme-color</code>：页面风格颜色，实际并不会影响页面，但是浏览器可能据此调整页面之外的 UI（如窗口边框或者 tab 的颜色）。<code>content</code> 属性应当包含一个有效的 CSS 颜色值（十六进制，渐变色，或者颜色关键字等）</p></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="charset">charset<a href="#charset" class="hash-link" aria-label="charset的直接链接" title="charset的直接链接">​</a></h3><p>从 HTML5 开始，为了简化写法，<code>meta</code>标签新增了<code>charset</code>属性，用来描述 HTML 文档自身的编码格式。添加了 <code>charset</code> 属性的 <code>meta</code> 标签无需再有 <code>name</code>和<code>content</code>。指定<code>charset</code>的<code>meta</code>通常放在<code>head</code>的第一个。</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&lt;</span><span class="token plain">meta charset</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"UTF-8"</span><span class="token plain"> </span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="http-equiv">http-equiv<a href="#http-equiv" class="hash-link" aria-label="http-equiv的直接链接" title="http-equiv的直接链接">​</a></h3><p>具有 <code>http-equiv</code> 属性的 <code>meta</code> 标签，表示执行一个命令，这样的 <code>meta</code> 标签可以不需要 <code>name</code> 属性。例如下面一段代码相当于指定<code>content-type</code>这个 HTTP 首部，并且指定了 HTTP 编码方式</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&lt;</span><span class="token plain">meta http</span><span class="token operator">-</span><span class="token plain">equiv</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"content-type"</span><span class="token plain"> content</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"text/html; charset=UTF-8"</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>除了<code>content-type</code>，还有以下几种命令：</p><ul><li><p><code>content-language</code>指定内容的语言；</p></li><li><p><code>default-style</code>指定默认样式表；</p></li><li><p><code>refresh</code>刷新；</p></li><li><p><code>set-cookie</code>模拟 HTTP 响应头 <code>set-cookie</code>，设置 cookie；</p></li><li><p><code>x-ua-compatible</code> 模拟 HTTP 头 <code>x-ua-compatible</code>，声明浏览器兼容性；</p></li><li><p><code>content-security-policy</code> 模拟 HTTP 头 <code>content-security-policy</code>，声明内容安全策略</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="x-ua-compatible">x-ua-compatible<a href="#x-ua-compatible" class="hash-link" aria-label="x-ua-compatible的直接链接" title="x-ua-compatible的直接链接">​</a></h4><p>关于<code>http-equiv</code>，比较常用的是<code>X-UA-Compatible</code>，这个标识主要为了在老版本的 IE8 上标识应该以 IE7（兼容性视图）还是 IE8（标准视图）来渲染页面，而在 IE11（2013年发布） 以后，这个标识就废弃不用了。如果 web 页面需要兼容 IE9或者IE8，那么应该指定这个标识，而 IE11 以及 edge 版本，那完全不需要这个标识。</p><p>这个标识的值以 IE 开头，指定 IE 的版本，例如：</p><ul><li><code>"IE=edge"</code>：指定 IE 使用 edge 的渲染引擎来显示页面</li><li><code>"IE=11"</code>：指定 IE 使用 IE11 的模式渲染页面</li><li><code>chrome=1</code>：如果额外指 chrome，则指定 IE 在安装了<a href="https://en.wikipedia.org/wiki/Google_Chrome_Frame" target="_blank" rel="noopener noreferrer">Google Chrome Frame - Wikipedia</a>的情况下使用这个 chrome 的渲染引擎</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="viewport">viewport<a href="#viewport" class="hash-link" aria-label="viewport的直接链接" title="viewport的直接链接">​</a></h3><p><code>viewport</code>并未由标准定义，但是移动端开发必须使用，其表示移动端网页物理像素和逻辑像素的缩放逻辑。其属性值是一个很复杂的结构，用逗号分隔的键值对，键值对可以是以下几种：</p><ul><li><p><code>width</code>：页面宽度，可以取值具体的数字，也可以是 device-width，表示跟设备宽度相等。</p></li><li><p><code>height</code>：页面高度，可以取值具体的数字，也可以是 device-height，表示跟设备高度相等。</p></li><li><p><code>initial-scale</code>：初始缩放比例。</p></li><li><p><code>minimum-scale</code>：最小缩放比例。</p></li><li><p><code>maximum-scale</code>：最大缩放比例。</p></li><li><p><code>user-scalable</code>：是否允许用户缩放。</p></li></ul><p>对于已经做好了移动端适配的网页，应该把用户缩放功能禁止掉，宽度设为设备宽度，一个标准的指定<code>viewport</code>的<code>meta</code>如下：</p><div class="language-javascript codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-javascript codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&lt;</span><span class="token plain">meta name</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"viewport"</span><span class="token plain"> content</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">"width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="seo">SEO<a href="#seo" class="hash-link" aria-label="SEO的直接链接" title="SEO的直接链接">​</a></h3><p><code>meta</code>标签另外一个最大的用处就是进行网站的<code>SEO</code>（Search engine optimization，搜索引擎优化）。这其中常用的属性为：</p><ul><li><code>author</code>：文档作者的名字。</li><li><code>description</code>：一段简短而精确的、对页面内容的描述。一些浏览器，比如 Firefox 和 Opera，将其用作书签的默认描述。</li><li><code>generator</code>：生成此页面的软件的标识符（identifier）。</li><li><code>keywords</code>：与页面内容相关的关键词，使用逗号分隔。</li></ul>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[monorepo]]></title>
        <id>https://willes.github.io/2022/01/02/monorepo</id>
        <link href="https://willes.github.io/2022/01/02/monorepo"/>
        <updated>2022-01-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[monorepo]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="monorepo">monorepo<a href="#monorepo" class="hash-link" aria-label="monorepo的直接链接" title="monorepo的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="什么是-monorepo">什么是 monorepo<a href="#什么是-monorepo" class="hash-link" aria-label="什么是 monorepo的直接链接" title="什么是 monorepo的直接链接">​</a></h3><p><code>monorepo</code>这个词是<code>meno</code>和<code>repo</code>两个缩写词的组合，<code>meno</code>是更少的意思，<code>repo</code>是<code>repository</code>的缩写，也就是仓库，合起来就是使用更少的仓库来进行版本管理控制，将所有项目都放在一个代码仓库进行管理。</p><p>截止到目前，主流的前端开源项目基本全部使用<code>monorepo</code>，例如<code>react</code>，<code>vue</code>，<code>babel</code>等。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="为什么要使用-monorepo">为什么要使用 monorepo<a href="#为什么要使用-monorepo" class="hash-link" aria-label="为什么要使用 monorepo的直接链接" title="为什么要使用 monorepo的直接链接">​</a></h3><p>使用<code>monorepo</code>有以下好处：</p><ul><li>代码复用更简单，<strong>类似的功能或通信协议可以抽象到共享库中</strong>，而不需要依赖包管理器；</li><li>原子级别的提交使得不同项目版本管理更加方便，例如<code>babel</code>内部包含<code>@babel/parser</code>，<code>@babel/traverse</code>等许多子项目，这些模块同时修改都在一个仓库代码内，修改完一次提交就行了；</li><li>避免重复安装第三方依赖，在大型项目中肯定会使用大量第三方依赖包，这些包的版本管理和安装需要不断重复进行，而<code>monorepo</code>内部只需要管理和安装一次，其他<code>package</code>都可以共享；</li><li>跨团队协作更加方便，由于代码都在一个仓库内部，所以基本没有权限限制，大家都可以参与和维护</li></ul><p>不过，使用<code>monorepo</code>也有一些不便：</p><ul><li><code>package</code>划分的粒度不好控制，这一般取决于架构的水平</li><li>随着不同项目的进行，整个<code>monorepo</code>会越来越大</li><li>权限控制没有<code>multirepo</code>那样精细到项目</li><li>团队协作导致的修改可能因为沟通不及时的问题而影响很多面，不过这都是开发者不规范使用的问题</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna">lerna<a href="#lerna" class="hash-link" aria-label="lerna的直接链接" title="lerna的直接链接">​</a></h2><blockquote><p>lerna 是一个工具，它优化了使用 git 和 npm 管理多包存储库的工作流。</p></blockquote><p>在<code>lerna</code>架构中，每个单独的项目都是放在<code>package</code>目录的子文件夹下进行管理，每个<code>package</code>内部都有管理自身配置项的<code>package.json</code>文件，依赖也都会安装在各个<code>package</code>文件夹内的<code>node_modules</code>内部。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="使用">使用<a href="#使用" class="hash-link" aria-label="使用的直接链接" title="使用的直接链接">​</a></h3><p>使用<code>lerna</code>需要全局安装 CLI 工具</p><div class="language-bash codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-bash codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> global </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> lerna</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">lerna init</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">lerna bootstrap</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">lerna publish</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="image-20211212143303117" src="/assets/images/image-20211212143303117-dde4957d3df2ead233f215ce98998bf8.png" width="433" height="528" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="版本控制">版本控制<a href="#版本控制" class="hash-link" aria-label="版本控制的直接链接" title="版本控制的直接链接">​</a></h3><p><code>lerna</code>提供两种版本控制的方式：</p><ol><li>一种是所有项目固定使用一个版本号，位于<code>monorepo</code>内部的<code>lerna.json</code>内部指定的<code>version</code>，这样就会导致执行<code>lerna publish</code>会更新所有<code>package</code>的版本号；</li><li>另一种是使用<code>lerna init --independent</code>创建的项目，可以独立管理每个<code>package.json</code>内部的版本号，每次执行<code>lerna publish</code>的时候，可以单独选择每个修改过的<code>package</code>内部的版本号。</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="配置项">配置项<a href="#配置项" class="hash-link" aria-label="配置项的直接链接" title="配置项的直接链接">​</a></h3><p>在<code>lerna.json</code>中可以指定以下配置项：</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"version"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"1.1.3"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"npmClient"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"npm"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"command"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"publish"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"ignoreChanges"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"ignored-file"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"*.md"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"message"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"chore(release): publish"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"registry"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"https://npm.pkg.github.com"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token property">"bootstrap"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"ignore"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"component-*"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token property">"npmClientArgs"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"--no-package-lock"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"packages"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"packages/*"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>version</code>：版本号，指定为<code>independent</code>表示每个<code>package</code>单独管理</li><li><code>npmClient</code>：使用<code>npm</code>还是<code>yarn</code>安装依赖</li><li><code>command.publish.ignoreChanges</code>：忽略以某些文件修改导致的发布更新，使用<code>glob</code>模式</li><li><code>command.publish.message</code>：执行发布的提交信息</li><li><code>command.publish.registry</code>：发布源</li><li><code>command.bootstrap.ignore</code>：取消引导安装依赖的文件</li><li><code>command.bootstrap.npmClientArgs</code>：执行<code>lerna bootstrap</code>时传递给<code>npm install</code>或者<code>yarn install</code>命令的参数</li><li><code>command.bootstrap.scope</code>：限制<code>lerna bootstrap</code>引导的<code>package</code></li><li><code>packages</code>：指定<code>lerna package</code>目录，默认就是<code>packages</code>文件夹</li><li><code>useWorkspaces</code>：是否使用<code>yarn workspace</code>，如果开启需要在仓库根目录下的<code>package.json</code>指定<code>workspaces</code></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="命令行">命令行<a href="#命令行" class="hash-link" aria-label="命令行的直接链接" title="命令行的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna-init">lerna init<a href="#lerna-init" class="hash-link" aria-label="lerna init的直接链接" title="lerna init的直接链接">​</a></h4><p>创建基于<code>lerna</code>的<code>monorepo</code>仓库，或者更新当前仓库的<code>lerna</code>版本。</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna-bootstrap">lerna bootstrap<a href="#lerna-bootstrap" class="hash-link" aria-label="lerna bootstrap的直接链接" title="lerna bootstrap的直接链接">​</a></h4><p>安装所有<code>package</code>的依赖项。<code>lerna</code>为项目内的每个<code>package</code>执行<code>npm install</code>或者<code>yarn install</code>，然后在这些包之间创建<a href="https://zh.wikipedia.org/wiki/%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5" target="_blank" rel="noopener noreferrer"><code>symlink</code></a>，以相互引用。</p><p>例如<code>babel</code>项目中<code>babel-core</code>依赖<code>@babel/generator</code>，而且它们都在同一个<code>monorepo</code>中，那么在<code>packages/babel-core</code>下安装的<code>@babel/generator</code>会通过<code>symlink</code>链接到同级的<code>@babel/generator</code>目录。</p><p><code>symlink</code>是一类特殊的文件，包含一条以绝对路径或者相对路径形式指向其他文件或者目录的引用。目前 Unix，Windows 都支持<code>symlink</code>，一个符号链接文件仅包含有一个文本字符串，其被操作系统解释为一条指向另一个文件或者目录的路径。</p><p><code>lerna bootstrap --use-workspaces</code>使用<code>yarn workspace</code>的形式管理<code>packages</code>的依赖。</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna-add">lerna add<a href="#lerna-add" class="hash-link" aria-label="lerna add的直接链接" title="lerna add的直接链接">​</a></h4><div class="language-bash codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-bash codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token plain">lerna </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">package</span><span class="token operator">&gt;</span><span class="token plain"> --scope</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">package</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> --dev</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>lerna add</code>用于安装依赖到指定<code>package</code>内部，如果没有指定<code>scope</code>，那么默认安装到所有<code>package</code>内部。</p><p>注意不同<code>package</code>之间如果相互依赖，也需要通过<code>lerna add</code>安装，这样<code>lerna</code>才能创建<code>symlink</code>关联到依赖的<code>package</code>内部。</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna-publish">lerna publish<a href="#lerna-publish" class="hash-link" aria-label="lerna publish的直接链接" title="lerna publish的直接链接">​</a></h4><p>发布所有更新过内容的<code>package</code>仓库到<code>npm</code>，会提示<code>version</code>的更新。</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna-run-script">lerna run <!-- -->[script]<a href="#lerna-run-script" class="hash-link" aria-label="lerna-run-script的直接链接" title="lerna-run-script的直接链接">​</a></h4><p>在包含指定<code>script</code>的<code>package</code>内部执行该命令。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="lerna-的局限性">lerna 的局限性<a href="#lerna-的局限性" class="hash-link" aria-label="lerna 的局限性的直接链接" title="lerna 的局限性的直接链接">​</a></h3><p><code>lerna</code>作为<code>package</code>管理的容器，<code>lerna</code>无法做到高效地管理<code>node_modules</code>：</p><ul><li><code>lerna</code>为每个<code>package</code>单独执行<code>xxx install</code>的操作，并且依赖之间无法共享，所以会导致依赖的重复安装，可以参考上文使用<code>lerna</code>创建的项目内部管理<code>react</code>的安装项。</li><li><code>lerna</code>必须通过执行<code>lerna bootstrap</code>才能为不同<code>package</code>创建<code>symlink</code>，而如果单独在<code>package</code>内部执行<code>yarn install</code>等命令就会导致<code>symlink</code>被破坏，因此<code>package</code>管理非常受限制。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="yarn-workspace">yarn workspace<a href="#yarn-workspace" class="hash-link" aria-label="yarn workspace的直接链接" title="yarn workspace的直接链接">​</a></h2><p>为了解决<code>lerna</code>的局限性，<code>yarn</code>从<code>0.28</code>版本（目前 1.22）以后支持<code>monorepo</code>管理<code>package</code>之间的依赖。</p><p>并且从<code>yarn-1.0</code>版本以后，<code>yarn</code>默认支持，这种方式在<code>yarn</code>内部称为<code>workspace</code>。使用上来说，只需要在</p><p><code>monorepo</code>根目录下的<code>package.json</code>中注册<code>workspace</code>的文件夹即可。</p><div class="language-json codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-json codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"private"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token property">"workspaces"</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">"packages/*"</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>yarn workspace</code>不能取代<code>lerna</code>，主要是为了解决<code>lerna</code>的问题，因此<code>lerna</code>从<code>2.0.0</code>版本以后，支持使用<code>lerna bootstrap --use-workspace</code>来使用<code>yarn</code>引导<code>monorepo</code>依赖的管理和创建，这样<code>monorepo</code>内部所有<code>package</code>的依赖都只会安装在仓库根目录的<code>node_modules</code>下。</p><p><img loading="lazy" alt="image-20211212164417532" src="/assets/images/image-20211212164417532-94506936f7c3e7cebfb7c89618da7978.png" width="437" height="359" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="命令行-1">命令行<a href="#命令行-1" class="hash-link" aria-label="命令行的直接链接" title="命令行的直接链接">​</a></h3><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="yarn-install">yarn install<a href="#yarn-install" class="hash-link" aria-label="yarn install的直接链接" title="yarn install的直接链接">​</a></h3><p>安装依赖</p><h4 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="yarn-workspace-1">yarn workspace<a href="#yarn-workspace-1" class="hash-link" aria-label="yarn workspace的直接链接" title="yarn workspace的直接链接">​</a></h4><div class="language-bash codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-bash codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> workspace </span><span class="token operator">&lt;</span><span class="token plain">workspace_name</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">command</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>yarn workspace</code>命令用于在指定<code>package</code>内部执行命令，类似于<code>lerna add</code>。</p><p>例如安装依赖到指定<code>package</code>内部：</p><div class="language-bash codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-bash codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> workspace package1 </span><span class="token function" style="color:rgb(80, 250, 123)">add</span><span class="token plain"> react react-dom --D</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="yarn-workspaces">yarn workspaces<a href="#yarn-workspaces" class="hash-link" aria-label="yarn workspaces的直接链接" title="yarn workspaces的直接链接">​</a></h3><div class="language-bash codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-bash codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">yarn</span><span class="token plain"> workspaces run </span><span class="token operator">&lt;</span><span class="token plain">command</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在每个<code>packages</code>内部执行命令，类似于<code>lerna run</code>。</p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[Promise A+规范的实现]]></title>
        <id>https://willes.github.io/2022/01/02/Promise A+规范的实现</id>
        <link href="https://willes.github.io/2022/01/02/Promise A+规范的实现"/>
        <updated>2022-01-02T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Promise/A+]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="promisea">Promise/A+<a href="#promisea" class="hash-link" aria-label="Promise/A+的直接链接" title="Promise/A+的直接链接">​</a></h2><blockquote><p><a href="https://promisesaplus.com/#terminology" target="_blank" rel="noopener noreferrer">https://promisesaplus.com/#terminology</a></p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="promise-对象">Promise 对象<a href="#promise-对象" class="hash-link" aria-label="Promise 对象的直接链接" title="Promise 对象的直接链接">​</a></h3><ul><li>一个对象或者函数，并且带有<code>then</code>方法</li><li>一个当前状态<code>state</code>，可以是<code>pending</code>、<code>fulfilled</code>和<code>rejected</code>，且<code>fulfilled</code>和<code>rejected</code>不可被改变</li><li>一个<code>resolve</code>值<code>value</code>，可以是任何 JS 值的形式</li><li>一个执行<code>reject</code>的原因<code>reason</code></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="then-方法">then 方法<a href="#then-方法" class="hash-link" aria-label="then 方法的直接链接" title="then 方法的直接链接">​</a></h3><blockquote><p><code>newPromise = promise.then(onFulfilled, onRejected)</code></p></blockquote><p><code>then</code>方法接收两个参数，且必须都是函数，否则忽略该参数</p><ul><li><code>onFulfilled</code>：当前 Promise 对象的状态变成<code>fulfilled</code>以后执行，并且将<code>value</code>作为第一个参数，并且只允许执行一次</li><li><code>onRejected</code>：当前 Promise 对象的状态变成<code>rejected</code>以后执行，并且将<code>reason</code>作为第一个参数，并且只允许执行一次</li><li><code>onFulfilled</code>和<code>onRejected</code>必须在当前宏任务执行完以后才能执行，也就是异步的需求</li><li><code>then</code>执行完<strong>返回一个新的 Promise 对象</strong><code>newPromise</code>：<ul><li>如果<code>onFulfilled</code>或者<code>onRejected</code>返回新的值<code>x</code>，则执行下文的方法<code>Resolve(newPromise, x)</code></li><li>如果<code>onFulfilled</code>或者<code>onRejected</code>执行抛出异常<code>e</code>，<code>promise2</code>也必须<code>reject(e)</code></li><li>如果<code>onFulfilled</code>不是函数（未提供），则当<code>promise</code>状态变成<code>fulfilled</code>的时候，<code>newPromise</code>内部状态也要变成<code>fulfilled</code>并以<code>promise</code>内部的<code>value</code>执行<code>resolve</code>；同理<code>onRejected</code>也是</li></ul></li><li>同一个 Promise 对象的<code>then</code>方法可能调用多次<ul><li>并且各自<code>onFulfilled</code>或者<code>onRejected</code>回调必须按照调用<code>then</code>的顺序依次执行</li></ul></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="resolvepromise-x">Resolve(promise, x)<a href="#resolvepromise-x" class="hash-link" aria-label="Resolve(promise, x)的直接链接" title="Resolve(promise, x)的直接链接">​</a></h3><p><code>Resolve(promise, x)</code>这里是描述<code>then</code>执行以后的算法判断，也就是<code>then</code>的反复执行过程，这是一个特殊的内部方法，是处理<code>then</code>链式执行的算法；</p><ul><li>如果<code>promise === x</code>，直接<code>reject promise</code>并返回<code>TypeError</code>的错误；</li><li>如果<code>x</code>是一个 Promise 对象，则当前 Promise 对象<code>promise</code>的状态必须和<code>x</code>同步；</li><li>如果<code>x</code>是一个对象或者函数：<ul><li>判断其是否具有<code>then</code>方法；</li><li>如果没有，则<code>reject</code>；</li><li>如果具有<code>then</code>，则使用<code>x</code>作为<code>then</code>内部的<code>this</code>执行<code>then</code>，第一个参数传递<code>resolvePromise</code>，第二个参数传递<code>rejectPromise</code><ul><li>当<code>resolvePromise</code>被传递参数<code>y</code>调用的时候，执行<code>Resolve(promise, y)</code></li><li>当<code>rejectPromise</code>被传递参数<code>r</code>调用的时候，则<code>promise</code>也<code>reject</code></li><li>如果<code>resolvePromise</code>和<code>rejectPromise</code>都被调用了，或者被多次调用，首次调用优先执行，后续被忽略；</li><li>如果执行<code>then</code>抛出异常，当<code>resolvePromise</code>或者<code>rejectPromise</code>被调用了，则忽略；否则<code>reject</code>顶层的<code>promise</code></li></ul></li></ul></li><li>如果<code>x</code>不满足上述条件，<code>promise</code>直接<code>fulfilled</code></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="实现">实现<a href="#实现" class="hash-link" aria-label="实现的直接链接" title="实现的直接链接">​</a></h2><p>如果按照 promise-aplus 的算法慢慢摸索就可以直接实现一个完整的 Promise</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="初始化">初始化<a href="#初始化" class="hash-link" aria-label="初始化的直接链接" title="初始化的直接链接">​</a></h3><p>Promise 对象在初始化以后，具有以上提到的<code>value</code>，<code>state</code>以及<code>reason</code>等状态值</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">APromise</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">constructor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> fn </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token string" style="color:rgb(255, 121, 198)">'init parameter must be a function'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'fulfilled'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'rejected'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="then">then<a href="#then" class="hash-link" aria-label="then的直接链接" title="then的直接链接">​</a></h3><p>在上述代码的基础上，添加<code>then</code>方法，因为<code>then</code>方法可能被调用多次，所以我们需要额外定义两个队列保存在 Promise 状态发生变化以后的回调函数<code>onFulfilled</code>或<code>onRejected</code>，这里做一个参数非函数类型的简单化处理，这样只需要考虑函数的回调形式，毕竟日常开发也不会传递其他类型的参数</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">class</span><span class="token plain"> </span><span class="token class-name">APromise</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">constructor</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">fulfilledQue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">rejectedQue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">fn</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">then</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">onFulfilled</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> onRejected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">fulfilledQue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> onFulfilled </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onFulfilled</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">rejectedQue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> onRejected </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onRejected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token operator">:</span><span class="token plain"> </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后<code>then</code>方法返回一个新的 Promise 对象<code>newPromise</code>，并且这个新的 Promise 对象和当前 Promise 的状态保持同步，所以在<code>then</code>内部需要判断当前 Promise 的状态来进行不同的处理：</p><ul><li>如果是<code>fulfilled</code>状态，则表明当前 Promise 已经执行了<code>resolve</code>，所以应该以当前 Promise 的<code>value</code>异步执行<code>onFulfilled</code>，并把当前 Promise 的<code>value</code>传递下去；<code>rejected</code>状态同理</li><li>而如果当前 Promise 状态是<code>pending</code>，那么应该将<code>onFulfilled</code>或<code>onRejected</code>推到回调函数中去，等待状态改变的时候自动调用</li></ul><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function-variable function" style="color:rgb(80, 250, 123)">then</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">onFulfilled</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> onRejected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  onFulfilled </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> onFulfilled </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onFulfilled</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  onRejected </span><span class="token operator">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> onRejected </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function-variable function" style="color:rgb(80, 250, 123)">onRejected</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">throw</span><span class="token plain"> reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> newPromise </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">APromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'fulfilled'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-43</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// 这里直接异步执行回调函数，保证返回的 Promise 状态和当前 Promise 状态一致</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">onFulfilled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">newPromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'rejected'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">onRejected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">newPromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 如果当前 Promise 状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">fulfilledQue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">onFulfilled</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">newPromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">rejectedQue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">push</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">const</span><span class="token plain"> x </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">onRejected</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">newPromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> newPromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后我们需要在 Promise 状态发生改变的时候调用<code>onFulfilled</code>或<code>onRejected</code>，可以在原来的<code>resolve</code>和<code>reject</code>基础上进行补充，这里<a href="https://promisesaplus.com/#point-67" target="_blank" rel="noopener noreferrer">使用<code>setTimeout</code>模拟异步实现</a>的方式</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function-variable function" style="color:rgb(80, 250, 123)">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'fulfilled'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">value</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">fulfilledQue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">forEach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">cb</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function-variable function" style="color:rgb(80, 250, 123)">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token function" style="color:rgb(80, 250, 123)">setTimeout</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'rejected'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reason</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">rejectedQue</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">forEach</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">cb</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">cb</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="resolvepromise">resolvePromise<a href="#resolvepromise" class="hash-link" aria-label="resolvePromise的直接链接" title="resolvePromise的直接链接">​</a></h3><p><code>resolvePromise</code>的实现相对简单一点，直接按照规范定义一步一步来即可</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function-variable function" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">promise</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> x</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> resolve</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-48</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 如果then提供的onFulfilled或者onRejected函数执行返回的值和then返回的是同一个promise，会导致下文this.resolvePromise重复调用，形成死循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">promise </span><span class="token operator">===</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">TypeError</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token string" style="color:rgb(255, 121, 198)">'then must return a different promise with fulfilled callback'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-49</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token comment" style="color:rgb(98, 114, 164)">// 如果是一个 Promise，需要判断其状态，并同步到后续的 Promise</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">instanceof</span><span class="token plain"> </span><span class="token class-name">APromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-50</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'pending'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token parameter">value</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token parameter">reason</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">reason</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-51</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> x </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> x </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'object'</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> x </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(189, 147, 249);font-style:italic">null</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-53</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// thenable 函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-59</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// 保证x.then提供的回调函数只会被执行一次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> hasBeenResolved </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">try</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      then </span><span class="token operator">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-56</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">typeof</span><span class="token plain"> then </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'function'</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        then</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">call</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token parameter">y</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">hasBeenResolved</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              hasBeenResolved </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-57</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">this</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method function property-access" style="color:rgb(80, 250, 123)">resolvePromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">promise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token parameter">r</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">hasBeenResolved</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              hasBeenResolved </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">r</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-63</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token operator">!</span><span class="token plain">hasBeenResolved</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">// https://promisesaplus.com/#point-64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="测试">测试<a href="#测试" class="hash-link" aria-label="测试的直接链接" title="测试的直接链接">​</a></h3><p>使用 promise-aplus 规范提供的<a href="https://github.com/promises-aplus/promises-tests" target="_blank" rel="noopener noreferrer">promises-tests</a>进行测试，在原有代码上暴露以下入口方法，然后使用 cjs 语法导出即可</p><div class="language-js codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-js codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)">/**</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> * 测试入口</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token maybe-class-name">APromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">defer</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">APromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token method-variable function-variable method function property-access" style="color:rgb(80, 250, 123)">deferred</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">function</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">let</span><span class="token plain"> dfd </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  dfd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">promise</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">new</span><span class="token plain"> </span><span class="token class-name">APromise</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token parameter">resolve</span><span class="token parameter punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token parameter"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dfd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">resolve</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> resolve</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    dfd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token property-access">reject</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> reject</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token keyword control-flow" style="color:rgb(189, 147, 249);font-style:italic">return</span><span class="token plain"> dfd</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>执行<code>promises-aplus-tests</code>，可以看到完美通过 872 个测试用例。</p>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
    <entry>
        <title type="html"><![CDATA[GitHub不再支持密码登录验证]]></title>
        <id>https://willes.github.io/2021/10/30/GitHub不再支持密码登录验证</id>
        <link href="https://willes.github.io/2021/10/30/GitHub不再支持密码登录验证"/>
        <updated>2021-10-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[GitHub 取消密码登录验证的方式]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="github-取消密码登录验证的方式">GitHub 取消密码登录验证的方式<a href="#github-取消密码登录验证的方式" class="hash-link" aria-label="GitHub 取消密码登录验证的方式的直接链接" title="GitHub 取消密码登录验证的方式的直接链接">​</a></h2><p>2021 年 8 月 13 日以后，<a href="https://github.blog/changelog/2021-08-12-git-password-authentication-is-shutting-down/" target="_blank" rel="noopener noreferrer">GitHub 宣布不再支持密码登录的客户端授权方式</a>。</p><p><img loading="lazy" alt="image-20210922195230530" src="/assets/images/image-20210922195230530-61845da324c0ff530755d544c8514631.png" width="987" height="167" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="解决方式">解决方式<a href="#解决方式" class="hash-link" aria-label="解决方式的直接链接" title="解决方式的直接链接">​</a></h2><blockquote><p><a href="https://stackoverflow.com/questions/68775869/support-for-password-authentication-was-removed-please-use-a-personal-access-to" target="_blank" rel="noopener noreferrer">git - Support for password authentication was removed. Please use a personal access token instead - Stack Overflow</a></p></blockquote><p>参考 StackOverflow 上的解释，现在只能通过在 GitHub 网站生成 PAT (Personal Access Token)的方式保存在客户端来进行校验和授权。</p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="生成-pat">生成 PAT<a href="#生成-pat" class="hash-link" aria-label="生成 PAT的直接链接" title="生成 PAT的直接链接">​</a></h3><p>在 GitHub 官网生成 PAT 按照以下方式：</p><ol><li>右上角点击个人头像，找到 <strong>Settings</strong> 并打开；</li><li>然后在 <strong>Settings</strong> 面板左侧目录找到 <strong>Developer Settings</strong>，点击进去就可以看到 <strong>Personal access tokens</strong> 了</li></ol><p><img loading="lazy" alt="image-20210922200800547" src="/assets/images/image-20210922200800547-f0636d752e0b36c1313e24c7df383596.png" width="1206" height="535" class="img_MG2L"></p><h3 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="设置-pat">设置 PAT<a href="#设置-pat" class="hash-link" aria-label="设置 PAT的直接链接" title="设置 PAT的直接链接">​</a></h3><p>生成 PAT 以后呢，以 windows10 系统为例，在<strong>控制面板 =&gt; 个人账户</strong>下找到<strong>凭据管理器</strong></p><p><img loading="lazy" alt="image-20210922201159423" src="/assets/images/image-20210922201159423-906460f9b489d356e7538ca20d066a0b.png" width="1122" height="556" class="img_MG2L"></p><p>然后点击右侧 Windows 凭据，找到<code>git:https://github.com</code>，如果没有就点击添加，用户名就是邮箱地址，密码是刚才生成的 token，保存即可。</p><p><img loading="lazy" alt="image-20210922201533179" src="/assets/images/image-20210922201533179-fc077fd442cf68a46c78cb0b3fabe754.png" width="849" height="588" class="img_MG2L"></p><h2 class="anchor anchorWithHideOnScrollNavbar_tQQR" id="注意">注意<a href="#注意" class="hash-link" aria-label="注意的直接链接" title="注意的直接链接">​</a></h2><p>如果本地设置了 Git 代理地址，则需要重置代理</p><div class="language-shell codeBlockContainer_EZCn theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_YKKe"><pre tabindex="0" class="prism-code language-shell codeBlock_rPGn thin-scrollbar"><code class="codeBlockLines_yOdO"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> config --global https.proxy http://127.0.0.1:1080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> config --global https.proxy https://127.0.0.1:1080</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> config --global --unset http.proxy</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> config --global --unset https.proxy</span><br></span></code></pre><div class="buttonGroup_Mf1z"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_zP6O" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_K6ps"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_mWpP"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Oxygen</name>
            <uri>https://github.com/wood3n</uri>
        </author>
    </entry>
</feed>